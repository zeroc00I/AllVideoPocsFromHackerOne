{"id":182487,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xODI0ODc=","url":"https://hackerone.com/reports/182487","title":"CSRF Token Bypass in Account Deletion","state":"Closed","substate":"resolved","severity_rating":"low","readable_substate":"Resolved","created_at":"2016-11-16T11:14:50.871Z","submitted_at":"2016-11-16T11:14:50.871Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"7h0r4pp4n","url":"/7h0r4pp4n","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/049/473/07654bfb1b6d3c864ae4308a340c28bff6a87ebe_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":264,"url":"https://hackerone.com/gitlab","handle":"gitlab","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"GitLab","twitter_handle":"gitlab","website":"https://about.gitlab.com","about":"A single application for the entire software development lifecycle."}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2017-04-20T16:50:53.899Z","bug_reporter_agreed_on_going_public_at":"2017-04-20T08:57:12.318Z","team_member_agreed_on_going_public_at":"2017-04-20T16:50:53.850Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"The authentication token `authenticity_token` used in the POST request for deleting an account can be bypassed, by replacing the same with a token generated for deleting another account. This way, a self submitting form can be used to delete another user's account as long as he/she's logged in.\n\n**Steps to Reproduce:**\n1. Create an account and copy the POST request for deleting it.\n\n```\nPOST /users HTTP/1.1\nHost: gitlab.com\nReferer: https://gitlab.com/profile/account\nCookie: _gitlab_session=1staccount_cookie;\nContent-Type: application/x-www-form-urlencoded\n\n_method=delete\u0026authenticity_token=auth_1staccount\n```\n2. Create another account and send the above request after replacing the `_gitlab_session` cookie with that of the new one.  The `authenticity_token` remains the same as that of the first account.\n3. Send the request and the new account gets deleted.\n\nI have not explored all possible scenarios like different IP addresses or something. But the above situation, where I used accounts created using emails from a temporary email address generator, was reproduced multiple times.","vulnerability_information_html":"\u003cp\u003eThe authentication token \u003ccode\u003eauthenticity_token\u003c/code\u003e used in the POST request for deleting an account can be bypassed, by replacing the same with a token generated for deleting another account. This way, a self submitting form can be used to delete another user\u0026#39;s account as long as he/she\u0026#39;s logged in.\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eSteps to Reproduce:\u003c/strong\u003e\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003eCreate an account and copy the POST request for deleting it.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003ePOST /users HTTP/1.1\nHost: gitlab.com\nReferer: https://gitlab.com/profile/account\nCookie: _gitlab_session=1staccount_cookie;\nContent-Type: application/x-www-form-urlencoded\n\n_method=delete\u0026amp;authenticity_token=auth_1staccount\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003col\u003e\n\u003cli\u003eCreate another account and send the above request after replacing the \u003ccode\u003e_gitlab_session\u003c/code\u003e cookie with that of the new one.  The \u003ccode\u003eauthenticity_token\u003c/code\u003e remains the same as that of the first account.\u003c/li\u003e\n\u003cli\u003eSend the request and the new account gets deleted.\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eI have not explored all possible scenarios like different IP addresses or something. But the above situation, where I used accounts created using emails from a temporary email address generator, was reproduced multiple times.\u003c/p\u003e\n","weakness":{"id":45,"name":"Cross-Site Request Forgery (CSRF)"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-05-20T08:57:12.368Z","allow_singular_disclosure_after":-113946540.44010507,"singular_disclosure_allowed":true,"vote_count":6,"voters":["eveeez","silv3rpoision","osama123","rbcafe","spetr0x","madarkitekt"],"severity":{"rating":"low","author_type":"Team"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1302226,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for the report @7h0r4pp4n. We'll investigate and get back to you shortly.","markdown_message":"\u003cp\u003eThanks for the report \u003ca href=\"/7h0r4pp4n\"\u003e@7h0r4pp4n\u003c/a\u003e. We\u0026#39;ll investigate and get back to you shortly.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-16T12:07:02.536Z","updated_at":"2016-11-16T12:07:02.536Z","actor":{"username":"rspeicher","cleared":false,"url":"/rspeicher","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/070/800/771703800f32dcb0c5413919f04f19305041dd58_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1302358,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@7h0r4pp4n I'm having trouble reproducing this as you've described. Here's where I am:\n\n1. Create two users, **attacker** and **victim**\n1. Somehow, **attacker** knows **victim**'s secure session key. In this case it's `b9dbae76ceaed44954d57d0d505eca00`\n1. As **attacker**, initiate an account deletion, which looks something like this:\n\n    ```\n    POST /users HTTP/1.1\n    Host: localhost:3000\n    User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:39.0) Gecko/20100101 Firefox/39.0\n    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\n    Accept-Language: en-US,en;q=0.5\n    Accept-Encoding: gzip, deflate\n    Cookie: _gitlab_session=568a0c6e266c55938182945af357dda4\n    Connection: close\n    Content-Type: application/x-www-form-urlencoded\n    Content-Length: 132\n\n    _method=delete\u0026authenticity_token=a57BV%2BO0KhEtRe%2FS9W2%2FIBqZj2bWA8jbfE38VlA4pzN1wBKov8F4UV7gYerBaLOumjqpnIoC2Dsx1jufaAZGsg%3D%3D\n    ```\n\n1. Intercept that request, modifying `_gitlab_session` with the value of **victim**'s secure session cookie\n1. Forward the request, which now looks like this:\n\n    ```\n    POST /users HTTP/1.1\n    Host: localhost:3000\n    User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:39.0) Gecko/20100101 Firefox/39.0\n    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\n    Accept-Language: en-US,en;q=0.5\n    Accept-Encoding: gzip, deflate\n    Cookie: _gitlab_session=b9dbae76ceaed44954d57d0d505eca00\n    Connection: close\n    Content-Type: application/x-www-form-urlencoded\n    Content-Length: 132\n\n    _method=delete\u0026authenticity_token=a57BV%2BO0KhEtRe%2FS9W2%2FIBqZj2bWA8jbfE38VlA4pzN1wBKov8F4UV7gYerBaLOumjqpnIoC2Dsx1jufaAZGsg%3D%3D\n    ```\n\n1. At this point we expect the **victim** account to be deleted. Instead, I get back an `ActionController::InvalidAuthenticityToken` error\n\nWhat am I misunderstanding?\n\nThanks!","markdown_message":"\u003cp\u003e\u003ca href=\"/7h0r4pp4n\"\u003e@7h0r4pp4n\u003c/a\u003e I\u0026#39;m having trouble reproducing this as you\u0026#39;ve described. Here\u0026#39;s where I am:\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003eCreate two users, \u003cstrong\u003eattacker\u003c/strong\u003e and \u003cstrong\u003evictim\u003c/strong\u003e\n\u003c/li\u003e\n\u003cli\u003eSomehow, \u003cstrong\u003eattacker\u003c/strong\u003e knows \u003cstrong\u003evictim\u003c/strong\u003e\u0026#39;s secure session key. In this case it\u0026#39;s \u003ccode\u003eb9dbae76ceaed44954d57d0d505eca00\u003c/code\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eAs \u003cstrong\u003eattacker\u003c/strong\u003e, initiate an account deletion, which looks something like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003ePOST /users HTTP/1.1\nHost: localhost:3000\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:39.0) Gecko/20100101 Firefox/39.0\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\nAccept-Language: en-US,en;q=0.5\nAccept-Encoding: gzip, deflate\nCookie: _gitlab_session=568a0c6e266c55938182945af357dda4\nConnection: close\nContent-Type: application/x-www-form-urlencoded\nContent-Length: 132\n\n_method=delete\u0026amp;authenticity_token=a57BV%2BO0KhEtRe%2FS9W2%2FIBqZj2bWA8jbfE38VlA4pzN1wBKov8F4UV7gYerBaLOumjqpnIoC2Dsx1jufaAZGsg%3D%3D\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003eIntercept that request, modifying \u003ccode\u003e_gitlab_session\u003c/code\u003e with the value of \u003cstrong\u003evictim\u003c/strong\u003e\u0026#39;s secure session cookie\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eForward the request, which now looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003ePOST /users HTTP/1.1\nHost: localhost:3000\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:39.0) Gecko/20100101 Firefox/39.0\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\nAccept-Language: en-US,en;q=0.5\nAccept-Encoding: gzip, deflate\nCookie: _gitlab_session=b9dbae76ceaed44954d57d0d505eca00\nConnection: close\nContent-Type: application/x-www-form-urlencoded\nContent-Length: 132\n\n_method=delete\u0026amp;authenticity_token=a57BV%2BO0KhEtRe%2FS9W2%2FIBqZj2bWA8jbfE38VlA4pzN1wBKov8F4UV7gYerBaLOumjqpnIoC2Dsx1jufaAZGsg%3D%3D\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003eAt this point we expect the \u003cstrong\u003evictim\u003c/strong\u003e account to be deleted. Instead, I get back an \u003ccode\u003eActionController::InvalidAuthenticityToken\u003c/code\u003e error\u003c/p\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eWhat am I misunderstanding?\u003c/p\u003e\n\n\u003cp\u003eThanks!\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-16T12:48:26.676Z","updated_at":"2016-11-16T12:48:26.676Z","actor":{"username":"rspeicher","cleared":false,"url":"/rspeicher","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/070/800/771703800f32dcb0c5413919f04f19305041dd58_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1302511,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I tried a different route: \n\nHave two sessions open and have both browse to delete their accounts.  \nSwap authenticity_tokens between them.\nNeither account deletion works.\n","markdown_message":"\u003cp\u003eI tried a different route: \u003c/p\u003e\n\n\u003cp\u003eHave two sessions open and have both browse to delete their accounts.\u003cbr\u003e\u003cbr\u003e\nSwap authenticity_tokens between them.\u003cbr\u003e\nNeither account deletion works.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-16T14:56:48.754Z","updated_at":"2016-11-16T14:56:48.754Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1302633,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"The attached video shows the process that I followed. Kindly go through the same.","markdown_message":"\u003cp\u003eThe attached video shows the process that I followed. Kindly go through the same.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-16T16:08:23.300Z","updated_at":"2016-11-16T16:08:23.300Z","actor":{"username":"7h0r4pp4n","cleared":false,"url":"/7h0r4pp4n","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/049/473/07654bfb1b6d3c864ae4308a340c28bff6a87ebe_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"attachments":[{"id":135071,"filename":"record.mkv","type":"video/x-matroska","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/135/071/99084bdf023ebdc447fd46364f1bccb6918cdb11/record.mkv?response-content-disposition=attachment%3B%20filename%3D%22record.mkv%22%3B%20filename%2A%3DUTF-8%27%27record.mkv\u0026response-content-type=video%2Fx-matroska\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQVN4C5GIR%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T044612Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJn%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJGMEQCICjdrX7ABZ%2BvfX76vY4hAT36HAFa7ABTRFnFNWlME3RsAiA6spUqHGGbpGIJMpDYYPRLrN21uLj3JvPgDLV04KLXWCq0AwhSEAEaDDAxMzYxOTI3NDg0OSIM%2BwbYtZgzO0HRNuilKpED0QRzghA3dQ82LDNvNHg%2F%2Bapjkbzzquj0OQyaslf6lhZ6ae5aaEALaU1htc90%2FTkEnCjK7YAB%2BOOqYauHnXFwgnicH8P2qB1b6qq8ByPdiyv%2F6FeKLaeKEKd1ked0wxhxGILfvv9geWvP9kPkCkrnpW%2Bk3I2nWFhXQ59oSwcUQzXUMoZ0agtptlqAo0vIB0BQ8w3QdM1eyZALy%2Fa2aEoAk0NEEkFhGgVq6y7NSlne0HYNYsnTubU1gtBiWgKFN75WWxAKzP41DZr9biaTv2LpKz%2BS54%2B0D7gM01Pv9DWNFSxduldCjFNWMHaz53TpINKZivByzZ%2FZritkdAHNoYR8NUHdDo4fG9KADtaMgItKYoCYS9dQ3VQKUnEB%2FG5XIqiEWJNuiVPw9Xo1zZJ7ItciKJ%2F2lZOYbSY5IWLtOLK3LAXfBln%2BqWM6KN%2BYSgAqj80OMMoKJozuCJRCLPgT%2BsuXVxgkfPMjWm0msUwRdOuNqAG3PPIFx7Qi20ur1fS33s63LIR24RY3pe1aeEm14DkixQAwqvyp%2FwU67AFUTZKxgkosuC9%2FFnLTDWAcFKkGbWeTSyQlX9WvARJtmEGSKKE3O3RCz4o1fvK2y8cIWG4ZDqIQnnY30DkA5lvQ1S96196eUcIlxUE3IU6WzlYzirsAJvCXzxdcKxl0gn59sA3vLFJkUTgoas7IMyJTtRG6%2B0%2BVBuYKCHqJR1eTwSQxZvSP%2Bzn9VyHRQJZnA1hWcpkteF706gKj%2FXnieX9VW%2FOBOoEUExU1kfEmA0ZpoQRXSm8ma7vzsQoYhwoevAvKutaOvkhM8WM71tgT1%2FjC27FmA%2F%2FsDsAjQs2Rv9IujFElYACO0n6OSheOZw%3D%3D\u0026X-Amz-Signature=32e8140335b395848e7323fdfebdcc3582b1cd16d7ea7ea0d254770db82b3f18"}],"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1302750,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@7h0r4pp4n Try clearing your cookies before creating the second account. AFAICT this is a bug with not deleting the old session ID when a user deletes an account and therefore Rails somehow ends up with two valid CSRF authentication_token values for one account. It shouldn't work across client IPs or browser sessions.","markdown_message":"\u003cp\u003e\u003ca href=\"/7h0r4pp4n\"\u003e@7h0r4pp4n\u003c/a\u003e Try clearing your cookies before creating the second account. AFAICT this is a bug with not deleting the old session ID when a user deletes an account and therefore Rails somehow ends up with two valid CSRF authentication_token values for one account. It shouldn\u0026#39;t work across client IPs or browser sessions.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-16T17:23:31.032Z","updated_at":"2016-11-16T17:23:31.032Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1302807,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"The request to delete the account was not initiated from the browser. The request was directly sent from the network proxy I was using. \n\nCurrently I'm unable to access gitlab.com anymore. Is my IP (103.10.24.194) blocked for creating and deleting multiple accounts or something?\nOnce it's back up, I'll give it a shot without the proxy.","markdown_message":"\u003cp\u003eThe request to delete the account was not initiated from the browser. The request was directly sent from the network proxy I was using. \u003c/p\u003e\n\n\u003cp\u003eCurrently I\u0026#39;m unable to access gitlab.com anymore. Is my IP (103.10.24.194) blocked for creating and deleting multiple accounts or something?\u003cbr\u003e\nOnce it\u0026#39;s back up, I\u0026#39;ll give it a shot without the proxy.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-16T18:05:48.832Z","updated_at":"2016-11-16T18:06:55.266Z","actor":{"username":"7h0r4pp4n","cleared":false,"url":"/7h0r4pp4n","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/049/473/07654bfb1b6d3c864ae4308a340c28bff6a87ebe_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"attachments":[{"id":135101,"filename":"screenshot2.png","type":"image/png","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/135/101/a7f0e36cec1291db7b539e58d70d1e5c43742272/screenshot2.png?response-content-disposition=attachment%3B%20filename%3D%22screenshot2.png%22%3B%20filename%2A%3DUTF-8%27%27screenshot2.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQVN4C5GIR%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T044612Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJn%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJGMEQCICjdrX7ABZ%2BvfX76vY4hAT36HAFa7ABTRFnFNWlME3RsAiA6spUqHGGbpGIJMpDYYPRLrN21uLj3JvPgDLV04KLXWCq0AwhSEAEaDDAxMzYxOTI3NDg0OSIM%2BwbYtZgzO0HRNuilKpED0QRzghA3dQ82LDNvNHg%2F%2Bapjkbzzquj0OQyaslf6lhZ6ae5aaEALaU1htc90%2FTkEnCjK7YAB%2BOOqYauHnXFwgnicH8P2qB1b6qq8ByPdiyv%2F6FeKLaeKEKd1ked0wxhxGILfvv9geWvP9kPkCkrnpW%2Bk3I2nWFhXQ59oSwcUQzXUMoZ0agtptlqAo0vIB0BQ8w3QdM1eyZALy%2Fa2aEoAk0NEEkFhGgVq6y7NSlne0HYNYsnTubU1gtBiWgKFN75WWxAKzP41DZr9biaTv2LpKz%2BS54%2B0D7gM01Pv9DWNFSxduldCjFNWMHaz53TpINKZivByzZ%2FZritkdAHNoYR8NUHdDo4fG9KADtaMgItKYoCYS9dQ3VQKUnEB%2FG5XIqiEWJNuiVPw9Xo1zZJ7ItciKJ%2F2lZOYbSY5IWLtOLK3LAXfBln%2BqWM6KN%2BYSgAqj80OMMoKJozuCJRCLPgT%2BsuXVxgkfPMjWm0msUwRdOuNqAG3PPIFx7Qi20ur1fS33s63LIR24RY3pe1aeEm14DkixQAwqvyp%2FwU67AFUTZKxgkosuC9%2FFnLTDWAcFKkGbWeTSyQlX9WvARJtmEGSKKE3O3RCz4o1fvK2y8cIWG4ZDqIQnnY30DkA5lvQ1S96196eUcIlxUE3IU6WzlYzirsAJvCXzxdcKxl0gn59sA3vLFJkUTgoas7IMyJTtRG6%2B0%2BVBuYKCHqJR1eTwSQxZvSP%2Bzn9VyHRQJZnA1hWcpkteF706gKj%2FXnieX9VW%2FOBOoEUExU1kfEmA0ZpoQRXSm8ma7vzsQoYhwoevAvKutaOvkhM8WM71tgT1%2FjC27FmA%2F%2FsDsAjQs2Rv9IujFElYACO0n6OSheOZw%3D%3D\u0026X-Amz-Signature=5a60c761658867032acc3922f6b30feb0225f350038b2f249b1a0a1522129dcd"}],"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1302819,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@7h0r4pp4n No, we're just experiencing some (unrelated) downtime right now.\n\nThat said, we do list testing on gitlab.com as out of scope on our H1 program page and would appreciate if you tested locally in the future. ðŸ˜€","markdown_message":"\u003cp\u003e\u003ca href=\"/7h0r4pp4n\"\u003e@7h0r4pp4n\u003c/a\u003e No, we\u0026#39;re just experiencing some (unrelated) downtime right now.\u003c/p\u003e\n\n\u003cp\u003eThat said, we do list testing on gitlab.com as out of scope on our H1 program page and would appreciate if you tested locally in the future. ðŸ˜€\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-16T18:12:32.717Z","updated_at":"2016-11-16T18:12:32.717Z","actor":{"username":"rspeicher","cleared":false,"url":"/rspeicher","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/070/800/771703800f32dcb0c5413919f04f19305041dd58_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1302839,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@7h0r4pp4n It's not the request to delete the user that's associating the old authentication token with the new session, it's the initial login request for the second account.\n\nIf you create the first user and then delete them (storing the delete request in Burp), close your browser and re-open (or delete cookies and refresh the login page), this attack _shouldn't_ succeed. What I think is happening -- and I'm still trying to verify this -- is that when you register your second account you're doing so still using the old session ID associated with the first account. When you validate your email address the second time and are logged in a new session ID is created, but the old authentication token has already been declared valid for the new user. Burp can save all of these values but only GitLab can associate the auth token with a new session.\n\nAnother way to test this would be to run two web browsers, both using Burp as a proxy, and see if it still works. Use each browser for only one user. I've done this and it doesn't appear to work.","markdown_message":"\u003cp\u003e\u003ca href=\"/7h0r4pp4n\"\u003e@7h0r4pp4n\u003c/a\u003e It\u0026#39;s not the request to delete the user that\u0026#39;s associating the old authentication token with the new session, it\u0026#39;s the initial login request for the second account.\u003c/p\u003e\n\n\u003cp\u003eIf you create the first user and then delete them (storing the delete request in Burp), close your browser and re-open (or delete cookies and refresh the login page), this attack \u003cu\u003eshouldn\u0026#39;t\u003c/u\u003e succeed. What I think is happening -- and I\u0026#39;m still trying to verify this -- is that when you register your second account you\u0026#39;re doing so still using the old session ID associated with the first account. When you validate your email address the second time and are logged in a new session ID is created, but the old authentication token has already been declared valid for the new user. Burp can save all of these values but only GitLab can associate the auth token with a new session.\u003c/p\u003e\n\n\u003cp\u003eAnother way to test this would be to run two web browsers, both using Burp as a proxy, and see if it still works. Use each browser for only one user. I\u0026#39;ve done this and it doesn\u0026#39;t appear to work.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-16T18:26:31.348Z","updated_at":"2016-11-16T18:26:31.348Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1302938,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Aha. Now that works. I'm getting a 422 status code.\n\nWhy wasn't the `authenticity_token` invalidated though? And how did it even sustain after logging out?\nThe token was passed via the meta-tag and only ever used via POST tag right?\n\nAlso the scenario begs for attention to an even bigger issue!  Why was the old session id validated to a new account? I can easily leave a session id in a public system and wait for someone else to use that system to create a new account or login. Wouldn't this then validate the old session id (which I know) to someone's new account? Should I open this as a new issue?","markdown_message":"\u003cp\u003eAha. Now that works. I\u0026#39;m getting a 422 status code.\u003c/p\u003e\n\n\u003cp\u003eWhy wasn\u0026#39;t the \u003ccode\u003eauthenticity_token\u003c/code\u003e invalidated though? And how did it even sustain after logging out?\u003cbr\u003e\nThe token was passed via the meta-tag and only ever used via POST tag right?\u003c/p\u003e\n\n\u003cp\u003eAlso the scenario begs for attention to an even bigger issue!  Why was the old session id validated to a new account? I can easily leave a session id in a public system and wait for someone else to use that system to create a new account or login. Wouldn\u0026#39;t this then validate the old session id (which I know) to someone\u0026#39;s new account? Should I open this as a new issue?\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-16T19:13:45.753Z","updated_at":"2016-11-16T19:13:45.753Z","actor":{"username":"7h0r4pp4n","cleared":false,"url":"/7h0r4pp4n","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/049/473/07654bfb1b6d3c864ae4308a340c28bff6a87ebe_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1303050,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"**Ignore the previous comment**\nAha. Now that works. I'm getting a 422 status code.\n\nI am seeing three separate issues, all equally terrifying, which came together to cause the issue that we are facing.\n\n- The `authenticity_token` wasn't invalidated even though it was already used for deleting the first account.\n- The old session id wasn't invalidated by emptying the value of `_gitlab_session` cookie after the account was deleted.\n- Why was the **user submitted value** of `_gitlab_session` validated? That too, to a new account?\n\n I can easily leave a session id in a public system and wait for someone else to use that system to create a new account or login. Wouldn't this then validate the old session id (which I know) to someone's account? I mean, why was the old session id even allowed to be validated? Should I open this as a new issue?","markdown_message":"\u003cp\u003e\u003cstrong\u003eIgnore the previous comment\u003c/strong\u003e\u003cbr\u003e\nAha. Now that works. I\u0026#39;m getting a 422 status code.\u003c/p\u003e\n\n\u003cp\u003eI am seeing three separate issues, all equally terrifying, which came together to cause the issue that we are facing.\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eThe \u003ccode\u003eauthenticity_token\u003c/code\u003e wasn\u0026#39;t invalidated even though it was already used for deleting the first account.\u003c/li\u003e\n\u003cli\u003eThe old session id wasn\u0026#39;t invalidated by emptying the value of \u003ccode\u003e_gitlab_session\u003c/code\u003e cookie after the account was deleted.\u003c/li\u003e\n\u003cli\u003eWhy was the \u003cstrong\u003euser submitted value\u003c/strong\u003e of \u003ccode\u003e_gitlab_session\u003c/code\u003e validated? That too, to a new account?\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eI can easily leave a session id in a public system and wait for someone else to use that system to create a new account or login. Wouldn\u0026#39;t this then validate the old session id (which I know) to someone\u0026#39;s account? I mean, why was the old session id even allowed to be validated? Should I open this as a new issue?\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-16T20:18:52.093Z","updated_at":"2016-11-16T20:19:24.767Z","actor":{"username":"7h0r4pp4n","cleared":false,"url":"/7h0r4pp4n","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/049/473/07654bfb1b6d3c864ae4308a340c28bff6a87ebe_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1303145,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"A couple of important things:\n\nThe old session ID used for authenticating the user is invalidated in the sense that it can no longer be used to authenticate. It's not being removed from the browser's cookie store but it is no longer trusted in any sense by GitLab. It can't be used for session fixation because session IDs are always replaced on a login attempt.\n\nNow why the old authentication token used to prevent CSRF is still honored is a good question and one I'm still trying to answer. It would be next to impossible to leverage this to attack a user because they would have to be logged into the very browsing session the attacker used to create their own session ID and auth token in the first place and then they'd have to be tricked into\nnavigating to a malicious site that leverages the CSRF attack.\n\nBtw, these CSRF authentication tokens are intended to be valid for the length of a session so the fact that they are still valid beyond a single form POST isn't an issue. Them being valid after a new session ID is assigned is concerning, however.\n\nI'll keep researching it and see if I can find the root cause. Feel free to do the same! I'll keep you updated here.\n","markdown_message":"\u003cp\u003eA couple of important things:\u003c/p\u003e\n\n\u003cp\u003eThe old session ID used for authenticating the user is invalidated in the sense that it can no longer be used to authenticate. It\u0026#39;s not being removed from the browser\u0026#39;s cookie store but it is no longer trusted in any sense by GitLab. It can\u0026#39;t be used for session fixation because session IDs are always replaced on a login attempt.\u003c/p\u003e\n\n\u003cp\u003eNow why the old authentication token used to prevent CSRF is still honored is a good question and one I\u0026#39;m still trying to answer. It would be next to impossible to leverage this to attack a user because they would have to be logged into the very browsing session the attacker used to create their own session ID and auth token in the first place and then they\u0026#39;d have to be tricked into\u003cbr\u003e\nnavigating to a malicious site that leverages the CSRF attack.\u003c/p\u003e\n\n\u003cp\u003eBtw, these CSRF authentication tokens are intended to be valid for the length of a session so the fact that they are still valid beyond a single form POST isn\u0026#39;t an issue. Them being valid after a new session ID is assigned is concerning, however.\u003c/p\u003e\n\n\u003cp\u003eI\u0026#39;ll keep researching it and see if I can find the root cause. Feel free to do the same! I\u0026#39;ll keep you updated here.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-16T21:03:13.150Z","updated_at":"2016-11-16T21:03:13.150Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1303196,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"If the session ids are not revalidated to the new account, how can the auth token for one account be used to delete another account? The generated tokens ARE uniquely linked to each account right?\nAnd the auth token I used for deleting the first account, is not sent back to the server at a later time. The only connection between these two accounts appear to be the presence of the session id in the browser's cookie jar.","markdown_message":"\u003cp\u003eIf the session ids are not revalidated to the new account, how can the auth token for one account be used to delete another account? The generated tokens ARE uniquely linked to each account right?\u003cbr\u003e\nAnd the auth token I used for deleting the first account, is not sent back to the server at a later time. The only connection between these two accounts appear to be the presence of the session id in the browser\u0026#39;s cookie jar.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-16T21:30:00.226Z","updated_at":"2016-11-16T21:33:49.225Z","actor":{"username":"7h0r4pp4n","cleared":false,"url":"/7h0r4pp4n","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/049/473/07654bfb1b6d3c864ae4308a340c28bff6a87ebe_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1337422,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"This all appears to relate to an old Warden vulnerability where csrf_tokens weren't being reset upon authentication. What the Warden developers did was implement a \"hook\" so that after each successful authentication the csrf_token is reset. Because our process for confirming accounts via email link did not qualify as \"authentication events\" to Warden this token was never being reset. We're working on a patch right now. Thanks for bringing this to our attention and I'll be sure to keep you updated on our progress.","markdown_message":"\u003cp\u003eThis all appears to relate to an old Warden vulnerability where csrf_tokens weren\u0026#39;t being reset upon authentication. What the Warden developers did was implement a \u0026quot;hook\u0026quot; so that after each successful authentication the csrf_token is reset. Because our process for confirming accounts via email link did not qualify as \u0026quot;authentication events\u0026quot; to Warden this token was never being reset. We\u0026#39;re working on a patch right now. Thanks for bringing this to our attention and I\u0026#39;ll be sure to keep you updated on our progress.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-12-02T20:15:03.056Z","updated_at":"2016-12-02T20:15:03.056Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1337425,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","markdown_message":"","automated_response":false,"created_at":"2016-12-02T20:16:41.075Z","updated_at":"2016-12-02T20:16:41.075Z","additional_data":{"old_severity":"High (7.4)","new_severity":"None (0.0)","old_severity_id":7817,"new_severity_id":11182},"actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1337426,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","markdown_message":"","automated_response":false,"created_at":"2016-12-02T20:16:52.113Z","updated_at":"2016-12-02T20:16:52.113Z","additional_data":{"old_severity":"None (0.0)","new_severity":"Low","old_severity_id":11182,"new_severity_id":11183},"actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1337431,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2016-12-02T20:18:11.326Z","updated_at":"2016-12-02T20:18:11.326Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1337920,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Alright @briann :)","markdown_message":"\u003cp\u003eAlright \u003ca href=\"/briann\"\u003e@briann\u003c/a\u003e :)\u003c/p\u003e\n","automated_response":false,"created_at":"2016-12-03T00:57:22.347Z","updated_at":"2016-12-03T00:57:22.347Z","actor":{"username":"7h0r4pp4n","cleared":false,"url":"/7h0r4pp4n","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/049/473/07654bfb1b6d3c864ae4308a340c28bff6a87ebe_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1504754,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"This has been fixed in GitLab 8.17. Sessions are destroyed on logout and email confirmation links no longer automatically log in the user without a password. Thanks for the report!","markdown_message":"\u003cp\u003eThis has been fixed in GitLab 8.17. Sessions are destroyed on logout and email confirmation links no longer automatically log in the user without a password. Thanks for the report!\u003c/p\u003e\n","automated_response":false,"created_at":"2017-02-25T00:11:10.346Z","updated_at":"2017-02-25T00:11:10.346Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"7h0r4pp4n","url":"/7h0r4pp4n"},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1505156,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Sorry about the whole confusion about what exactly is the bug.\nBeen my pleasure mate :)","markdown_message":"\u003cp\u003eSorry about the whole confusion about what exactly is the bug.\u003cbr\u003e\nBeen my pleasure mate :)\u003c/p\u003e\n","automated_response":false,"created_at":"2017-02-25T08:25:19.485Z","updated_at":"2017-02-25T08:25:19.485Z","actor":{"username":"7h0r4pp4n","cleared":false,"url":"/7h0r4pp4n","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/049/473/07654bfb1b6d3c864ae4308a340c28bff6a87ebe_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1623195,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-04-20T08:57:12.340Z","updated_at":"2017-04-20T08:57:12.340Z","first_to_agree":true,"actor":{"username":"7h0r4pp4n","cleared":false,"url":"/7h0r4pp4n","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/049/473/07654bfb1b6d3c864ae4308a340c28bff6a87ebe_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1624204,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-04-20T16:50:53.872Z","updated_at":"2017-04-20T16:50:53.872Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1624205,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-04-20T16:50:53.919Z","updated_at":"2017-04-20T16:50:53.919Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}