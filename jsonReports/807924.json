{"id":807924,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC84MDc5MjQ=","url":"https://hackerone.com/reports/807924","title":"CSRF on connecting Paypal as Payment Provider","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2020-03-01T02:58:21.320Z","submitted_at":"2020-03-01T02:58:21.320Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"ngalog","url":"/ngalog","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/074/607/68068f139c99d98e3e8baf0a51f219c29ade1769_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":1382,"url":"https://hackerone.com/shopify","handle":"shopify","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Shopify","twitter_handle":"","website":"https://www.shopify.com","about":"Shopify is a multi-channel commerce platform that helps people sell online, in-store, and everywhere in between."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2020-04-10T01:54:21.635Z","bug_reporter_agreed_on_going_public_at":"2020-04-10T01:54:21.538Z","team_member_agreed_on_going_public_at":"2020-04-09T15:58:03.608Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Hi,\n\nI think there is a weak csrf protection on adding paypal as the payment provider, but the protection is not good. When user try to add paypal as payment provider, they will make this GET request\n\n`https://h60ngalog.myshopify.com/admin/payments/complete_paypal_incontext_oauth/41?merchantId=MTU4MzAzMDUwNDowMTBmMDZkYjg1NzM0YjQ4NWVkMDk1YzQ1YWYxY2ZlNw%3D%3D\u0026merchantIdInPayPal=5NS8DHQCFGT84\u0026permissionsGranted=true\u0026accountStatus=BUSINESS_ACCOUNT\u0026consentStatus=true\u0026productIntentID=addipmt\u0026productIntentId=addipmt\u0026isEmailConfirmed=true`\n\nThe `merchantId` belongs to your store only, and the base64 decoded value is `1583030504:010f06db85734b485ed095c45af1cfe7` which is obviously too long to brute force, I'll say it is a pretty good way to mitigate CSRF, however there is one catch. This value is fixed, i.e. if someone who previously was an admin of this store before, then he/she can take advantage of this fixed value for CSRF protection, and perfomr CSRF attack on victim to connect victim's payment provider to their Paypal order. Or this value is leaked somewhere, then the store owner is forever vulnerable to CSRF attack \n\n## Steps to reproduce\n- Visit https://YOURDOMAIN.myshopify.com/admin/settings/payments, if there is already paypal account connected, disconnect it first\n- Then click the link Acitivate paypal express checkout\n- In the link, jot down the value of merchantId, this merchantId belongs to your store only, in order to connect your store to victim's store, you'll need this parameter, it looks like this `MTU4MzAzMDUwNDowMTBmMDZkYjg1NzM0YjQ4NWVkMDk1YzQ1YWYxY2ZlNw%3D%3D`\n- Finally, visit this link with merchantId replaced with the value you got from above step (replace YOUTSUBDOMAIN and REPLACEME)\n\n`https://YOURSUBDOMAIN.myshopify.com/admin/payments/complete_paypal_incontext_oauth/41?merchantId=REPLACEME\u0026merchantIdInPayPal=5NS8DHQCFGT84\u0026permissionsGranted=true\u0026accountStatus=BUSINESS_ACCOUNT\u0026consentStatus=true\u0026productIntentID=addipmt\u0026productIntentId=addipmt\u0026isEmailConfirmed=true`\n\nHere in `5NS8DHQCFGT84` is the attacker's paypal merchant id, so after you visit that link, you got CSRFed to connect your store to my paypal as payment provider, very similar to #807921 but different impact\n\n## Impact\n\nCSRFed to connect your store to my paypal as payment provider, very similar to #807921 but different impact","vulnerability_information_html":"\u003cp\u003eHi,\u003c/p\u003e\n\n\u003cp\u003eI think there is a weak csrf protection on adding paypal as the payment provider, but the protection is not good. When user try to add paypal as payment provider, they will make this GET request\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003ehttps://h60ngalog.myshopify.com/admin/payments/complete_paypal_incontext_oauth/41?merchantId=MTU4MzAzMDUwNDowMTBmMDZkYjg1NzM0YjQ4NWVkMDk1YzQ1YWYxY2ZlNw%3D%3D\u0026amp;merchantIdInPayPal=5NS8DHQCFGT84\u0026amp;permissionsGranted=true\u0026amp;accountStatus=BUSINESS_ACCOUNT\u0026amp;consentStatus=true\u0026amp;productIntentID=addipmt\u0026amp;productIntentId=addipmt\u0026amp;isEmailConfirmed=true\u003c/code\u003e\u003c/p\u003e\n\n\u003cp\u003eThe \u003ccode\u003emerchantId\u003c/code\u003e belongs to your store only, and the base64 decoded value is \u003ccode\u003e1583030504:010f06db85734b485ed095c45af1cfe7\u003c/code\u003e which is obviously too long to brute force, I\u0026#39;ll say it is a pretty good way to mitigate CSRF, however there is one catch. This value is fixed, i.e. if someone who previously was an admin of this store before, then he/she can take advantage of this fixed value for CSRF protection, and perfomr CSRF attack on victim to connect victim\u0026#39;s payment provider to their Paypal order. Or this value is leaked somewhere, then the store owner is forever vulnerable to CSRF attack \u003c/p\u003e\n\n\u003ch2 id=\"steps-to-reproduce\"\u003eSteps to reproduce\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003eVisit \u003ca title=\"https://yourdomain.myshopify.com/admin/settings/payments\" href=\"/redirect?url=https%3A%2F%2Fyourdomain.myshopify.com%2Fadmin%2Fsettings%2Fpayments\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://yourdomain.myshopify.com/admin/settings/payments\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e, if there is already paypal account connected, disconnect it first\u003c/li\u003e\n\u003cli\u003eThen click the link Acitivate paypal express checkout\u003c/li\u003e\n\u003cli\u003eIn the link, jot down the value of merchantId, this merchantId belongs to your store only, in order to connect your store to victim\u0026#39;s store, you\u0026#39;ll need this parameter, it looks like this \u003ccode\u003eMTU4MzAzMDUwNDowMTBmMDZkYjg1NzM0YjQ4NWVkMDk1YzQ1YWYxY2ZlNw%3D%3D\u003c/code\u003e\n\u003c/li\u003e\n\u003cli\u003eFinally, visit this link with merchantId replaced with the value you got from above step (replace YOUTSUBDOMAIN and REPLACEME)\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e\u003ccode\u003ehttps://YOURSUBDOMAIN.myshopify.com/admin/payments/complete_paypal_incontext_oauth/41?merchantId=REPLACEME\u0026amp;merchantIdInPayPal=5NS8DHQCFGT84\u0026amp;permissionsGranted=true\u0026amp;accountStatus=BUSINESS_ACCOUNT\u0026amp;consentStatus=true\u0026amp;productIntentID=addipmt\u0026amp;productIntentId=addipmt\u0026amp;isEmailConfirmed=true\u003c/code\u003e\u003c/p\u003e\n\n\u003cp\u003eHere in \u003ccode\u003e5NS8DHQCFGT84\u003c/code\u003e is the attacker\u0026#39;s paypal merchant id, so after you visit that link, you got CSRFed to connect your store to my paypal as payment provider, very similar to \u003ca href=\"/reports/807921\"\u003e#807921\u003c/a\u003e but different impact\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eCSRFed to connect your store to my paypal as payment provider, very similar to \u003ca href=\"/reports/807921\"\u003e#807921\u003c/a\u003e but different impact\u003c/p\u003e\n","bounty_amount":"500.0","formatted_bounty":"$500","weakness":{"id":45,"name":"Cross-Site Request Forgery (CSRF)"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":274,"voters":["jimmy-doe","sultancad","m0chan","foobar7","a_d_a_m","mashoud1122","albntomat0_1","rreiss","sameerphad72","testert1ng","and 264 more..."],"severity":{"rating":"medium","author_type":"User"},"structured_scope":{"databaseId":413,"asset_type":"URL","asset_identifier":"your-store.myshopify.com","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":7211704,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Howdy @ngalog,\n\nApologies for the delay, we wanted to make sure we investigated all the potential implications surrounding this token before getting back to you.\n\nWe've been able to reproduce your findings and our engineering team is working on a fix.\n\nAs an aside, the token in question does in fact have a 24 hour expiry, which limits the impact of this issue.\n\nThanks for the report!","markdown_message":"\u003cp\u003eHowdy \u003ca href=\"/ngalog\"\u003e@ngalog\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eApologies for the delay, we wanted to make sure we investigated all the potential implications surrounding this token before getting back to you.\u003c/p\u003e\n\n\u003cp\u003eWe\u0026#39;ve been able to reproduce your findings and our engineering team is working on a fix.\u003c/p\u003e\n\n\u003cp\u003eAs an aside, the token in question does in fact have a 24 hour expiry, which limits the impact of this issue.\u003c/p\u003e\n\n\u003cp\u003eThanks for the report!\u003c/p\u003e\n","automated_response":false,"created_at":"2020-03-03T22:26:38.712Z","updated_at":"2020-03-03T22:26:38.712Z","actor":{"username":"zack_spotify","cleared":false,"url":"/zack_spotify","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/261/793/78a81f701248b9e632d5de7b037e5e0eedd37560_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7227929,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks again for the report. We're awarding a $500 bounty for this issue, and we'll be in touch again once the issue is resolved.","markdown_message":"\u003cp\u003eThanks again for the report. We\u0026#39;re awarding a $500 bounty for this issue, and we\u0026#39;ll be in touch again once the issue is resolved.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-03-04T19:02:37.789Z","updated_at":"2020-03-04T19:02:37.789Z","actor":{"url":"/shopify","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Shopify"}},"bounty_amount":"500.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"shopify","collaborator":{"username":"ngalog","url":"/ngalog"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7562022,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Howdy @ngalog,\n\nWe are happy to report that we've shipped a fix for this issue and it should no longer be reproducible.\n\nThanks again for taking the time to help make Shopify more secure.","markdown_message":"\u003cp\u003eHowdy \u003ca href=\"/ngalog\"\u003e@ngalog\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eWe are happy to report that we\u0026#39;ve shipped a fix for this issue and it should no longer be reproducible.\u003c/p\u003e\n\n\u003cp\u003eThanks again for taking the time to help make Shopify more secure.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-04-06T17:50:53.975Z","updated_at":"2020-04-06T17:50:53.975Z","actor":{"username":"zack_spotify","cleared":false,"url":"/zack_spotify","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/261/793/78a81f701248b9e632d5de7b037e5e0eedd37560_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"ngalog","url":"/ngalog"},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7599331,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-04-09T15:58:03.626Z","updated_at":"2020-04-09T15:58:03.626Z","first_to_agree":true,"actor":{"username":"shopify-peteryaworski","cleared":false,"url":"/shopify-peteryaworski","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/175/526/7ba4844078e290c91c4c46a345b4f9e7666f3ed4_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7608294,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-04-10T01:54:21.617Z","updated_at":"2020-04-10T01:54:21.617Z","actor":{"username":"ngalog","cleared":true,"url":"/ngalog","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/074/607/68068f139c99d98e3e8baf0a51f219c29ade1769_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7608295,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-04-10T01:54:21.657Z","updated_at":"2020-04-10T01:54:21.657Z","actor":{"username":"ngalog","cleared":true,"url":"/ngalog","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/074/607/68068f139c99d98e3e8baf0a51f219c29ade1769_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}