{"id":1034346,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xMDM0MzQ2","url":"https://hackerone.com/reports/1034346","title":"Security@ email forwarding and Embedded Submission drafts can be used to obtain copy of deleted attachments from other HackerOne users","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2020-11-14T03:25:43.624Z","submitted_at":"2020-11-14T03:25:43.710Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"jobert","url":"/jobert","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":13,"url":"https://hackerone.com/security","handle":"security","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"HackerOne","twitter_handle":"Hacker0x01","website":"https://hackerone.com","about":"Vulnerability disclosure should be safe, transparent, and rewarding."}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2020-11-17T00:42:05.672Z","bug_reporter_agreed_on_going_public_at":"2020-11-16T23:39:34.810Z","team_member_agreed_on_going_public_at":"2020-11-17T00:42:05.581Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"HackerOne has a number of ways for hackers to submit security vulnerabilities to a program, two of which are through an embedded submission form and through security@ email forwarding. These two features can be exploited to update a report draft created through security@ email forwarding that does not belong to the attacker. In addition to that, the attacker can exploit these features to obtain copies of orphaned platform attachments that were uploaded through an embedded submission form and don't belong to the attacker.\n\n# Steps to reproduce\nThe exploit consists of chaining two vulnerabilities. The first one is an oversight in the access control of report drafts created and updated through an embedded submission form. To reproduce this first vulnerability, a victim will have to send an email that forwards all emails to a HackerOne inbox. An example of such an email address is security@hackerone.com, which forwards emails to our own program. When someone sends an email to this address, they'd receive an email similar to this one:\n\n{F1077716}\n\nIn the backend, this essentially does two things: it creates a `ReportDraft` object and a corresponding `Invitation` object. The email above contains the secret invitation token for the user to get access to the report draft. As long as the invitation is not accepted, the `ReportDraft` has its `reporter_id` and `tracer` attributes set to `NULL`. When a user would accept the invite, the `reporter_id` attribute would be overwritten with the user's ID who accepted the invitation. For now, let's not accept the invite and dive into the inner workings of embedded submission forms.\n\nSimilar to security@ email forwarding, embedded submission forms allow anonymous users to create a `ReportDraft` object in the backend. This object contains the current state of the embedded submission form to avoid data loss in case the user happens to close their window. To avoid unauthorized access to other anonymous users writing a report at the same time, the frontend generates a UUID to keep track of which attachments belong to the draft. The `ReportDraft` stores this UUID in the `tracer` attribute. Only when the user knows the UUID of this draft will it be able to update the draft. Every request triggered for an unauthenticated session in an embedded submission form will submit this UUID for the backend to authorize the user. This is where the first vulnerability is found.\n\nThe `Teams::EmbeddedSubmissionsController` implements a number of actions, which one of which is `draft_sync`:\n\n```ruby\n# frozen_string_literal: true\n\nmodule Teams\n  class EmbeddedSubmissionsController \u003c ApplicationController\n    # ...\n    def draft_sync\n      draft = Interactors::ReportDrafts::UpdateOrCreate.interact_without_authorization(\n        draft_id: report_params[:draft_id],\n        # ...\n        handle: team.handle,\n        # ...\n        attachment_ids: report_params[:attachment_ids],\n        as_user: current_user,\n        tracer: report_params[:tracer],\n      )\n    # ...\n  end\nend\n```\n\nHackerOne's backend consolidates business logic, input validation, and authorization into service objects called interactors. This particular interactor is called explicitly without any form of authorization. Among a few other attributes, the interaction is given a `draft_id`, `attachment_ids`, `tracer`, and a reference to the `current_user`, which is an instance of a `User` object or an instance of `UserAuthentication::AnonymousUser`. The `handle` attribute that is given is the program's handle based on embedded submission UUID. At this point, the application **should** determine whether the `current_user` OR a valid `tracer` value is present, but this check is missing. This is the first vulnerability. When the interaction is executed, it tries to look up a draft using the following code (see `draft` method):\n\n```ruby\n# frozen_string_literal: true\n\nmodule Interactors\n  module ReportDrafts\n    class UpdateOrCreate \u003c HackeroneInteractor\n      attribute :draft_id, Integer, required: false\n      # ...\n      attribute :attachment_ids, Array, default: []\n      attribute :tracer, String, required: false\n\n      private\n\n      def execute\n        return if draft_id \u0026\u0026 draft.nil?\n\n        draft.update(\n          # ...\n        )\n\n        draft\n      end\n\n      # ...\n\n      def draft\n        @draft ||= if draft_id\n          ReportDraft.find_by(\n            id: draft_id,\n            team: team,\n            reporter: nil_or_current_user,\n            tracer: tracer,\n          )\n        else\n          ReportDraft.find_or_initialize_by(\n            team: team,\n            reporter: nil_or_current_user,\n            tracer: tracer,\n          )\n        end\n      end\n\n      # ...\n\n      def nil_or_current_user\n        current_user.is_a?(User) ? current_user : nil\n      end\n    end\n  end\nend\n```\n\nStepping through the code, a user can see that if a `draft_id` is present, the system will try to look up a `ReportDraft` object by a tracer UUID and reporter. Going back to the security@ email forwarding, we know that there are `ReportDraft` objects that have a `tracer` or `reported_by_id` attribute set to `NULL`. This means that an attacker can, by guessing a draft ID created through the security@ email forwarding feature, change the contents of a draft by completely removing the `tracer` value from a draft sync that is initiated through the embedded submission form. Here is an excerpt of that request:\n\n```http\nPOST /80b9bc53-a236-445d-a7e4-553828b7d533/embedded_submissions/draft_sync HTTP/2\nHost: hackerone.com\n...\n\n{\n  \"draft_id\": \"1\",\n  \"title\": \"This becomes the new title for draft 1\",\n  \"vulnerability_information\":\"This becomes the new vulnerability information for draft 1\"\n}\n```\n\nOnce the victim claims the invitation through the email that was shown earlier, they'll see the updated vulnerability information and title.\n\n{F1077723}\n\nYou can see that the interaction passes *all* attributes to the `update` call, see `Interactors::ReportDrafts::UpdateOrCreate#execute`. This means that the attacker can only change *all* attributes, reducing the likelihood of the expoitation. However, due to the fact that this allows an attacker to change report drafts, the impact on the integrity is set to high. It could be used to tamper with drafts that are in the process of being submitted to a live program.\n\nTo further increase the severity of the vulnerability, it can be chained with another vulnerability. When a user uploads an attachment through an embedded submission form, it'll create an `Attachment` object that belongs to the `ReportDraft` object. In the backend, its attributes will look like this:\n\n```json\n{\n  \"id\": \"1\",\n  \"uploaded_by_id\": null,\n  \"attachable_id\": 1,\n  \"attachable_type\": \"ReportDraft\"\n}\n```\n\nThe `attachable_id` and `attachable_type` form a polymorphic relation to any other persistent model in HackerOne's database. As long as the user is working on its report, the attachment references a `ReportDraft` object. On submission, it'll transfer the ownership to the `Report` that was created – this is the report that customers see. ActiveRecord, the ORM HackerOne uses, has logic to (conveniently) disassociate a polymorphic relation when the model referencing the polymorphic relation overwrites the IDs. To show this, consider the following code example:\n\n```ruby\n# Create an attachment. At this time, the `attachable_id` and `attachable_type` are set to `NULL`\nattachment = Attachment.create!\n\n# Create another attachment. At this time, the `attachable_id` and `attachable_type` are set to `NULL`\nanother_attachment = Attachment.create!\n\n# Create a report draft and reference the first attachment. The `attachable_id` and `attachable_type` of the attachment are updated to reference the created report draft.\nreport_draft = ReportDraft.create! attachment_ids: [attachment.id]\n\n# Update the attachment IDs of a report draft. This will do two things:\n#   - update `attachment.attachable_id` to `NULL`\n#   - update `another_attachment.attachable_type` to `ReportDraft`\n#   - update `another_attachment.attachable_id` to `report_draft.id`\nreport_draft.update! attachment_ids: [another_attachment.id]\n```\n\nThis means that the `attachment`, as created in the above code example, is not referencing any object at all. There is a code path in HackerOne's platform to get an attachment in this state: upload an attachment using an embedded submission form, then clicking the \"X\" to remove it, and type one character in the vulnerability information field to trigger a draft sync. This will leave the first attachment in an orphaned state that has its `uploaded_by_id` and `attachable_id` set to `NULL`. Going back to the `Interactors::ReportDrafts::UpdateOrCreate` interactor, there's a method that associates attachments to a `ReportDraft` with the following logic:\n\n```ruby\n# ...\ndef valid_attachments\n  (\n    draft.attachments.with_attached_file.where(id: attachment_ids) +\n    Attachment.with_attached_file.where(\n      id: attachment_ids,\n      attachable_id: nil,\n      uploaded_by: nil_or_current_user,\n    )\n  ).uniq\nend\n# ...\n```\n\nThe code that contains the vulnerability is the second `Attachment` lookup: it selects all attachment objects that don't have an `attachable_id` set and that are uploaded by an anonymous user. This means that any attachment that was uploaded by an anonymous user and removed the attachment from a draft can be associated with the attacker's report draft. There are 823 attachments that match this criteria.\n\nAn attacker can exploit this chain using the following steps:\n\n1. in an authenticated session, start typing a report to any program. Observe the network traffic for the `draft_sync` endpoint to determine the latest report draft ID, which is included in the response (e.g. 1).\n1. in the same session, upload an attachment and observe which ID was associated (e.g. 5).\n1. send an email to the program's email forwarding address (e.g. security@hackerone.com). This will create a report draft with an ID that is one to ~ ten IDs up from the report draft the authenticated user created.\n1.  in an incognito browser, go to the program's embedded submission form URL. An example is [HackerOne's own form](https://hackerone.com/80b9bc53-a236-445d-a7e4-553828b7d533/embedded_submissions/new). Start typing and intercept the request to the `draft_sync` endpoint.\n1. change the `draft_id` to the ID obtained in step 1 and completely remove the `tracer` value from the request.\n1. set the `attachment_ids` to an array containing *all* possible attachment IDs from 1 to the ID obtained in step 2\n1. claim the report draft through the invitation you received\n1. in the UI, observe that the attachments belonging to the victim are attached to the report draft\n1. copy the ID and inline them in the vulnerability information field, e.g. `{F5}`\n1. in the report preview section, click the link to obtain a copy of the victim's attachment\n\n## Impact\n\nThe first vulnerability can be used to change the contents of a number of draft reports that were created through the security@ email forwarding feature. However, chaining the two vulnerabilities would increase the severity as it would allow an attacker to associate orphaned `Attachment` objects to its own report draft, potentially containing sensitive information. The attacker does not have to be authenticated in order to exploit this vulnerability.","vulnerability_information_html":"\u003cp\u003eHackerOne has a number of ways for hackers to submit security vulnerabilities to a program, two of which are through an embedded submission form and through security@ email forwarding. These two features can be exploited to update a report draft created through security@ email forwarding that does not belong to the attacker. In addition to that, the attacker can exploit these features to obtain copies of orphaned platform attachments that were uploaded through an embedded submission form and don\u0026#39;t belong to the attacker.\u003c/p\u003e\n\n\u003ch1 id=\"steps-to-reproduce\"\u003eSteps to reproduce\u003c/h1\u003e\n\n\u003cp\u003eThe exploit consists of chaining two vulnerabilities. The first one is an oversight in the access control of report drafts created and updated through an embedded submission form. To reproduce this first vulnerability, a victim will have to send an email that forwards all emails to a HackerOne inbox. An example of such an email address is \u003ca title=\"security@hackerone.com\" href=\"mailto:security@hackerone.com\" rel=\"nofollow noopener noreferrer\"\u003esecurity@hackerone.com\u003c/a\u003e, which forwards emails to our own program. When someone sends an email to this address, they\u0026#39;d receive an email similar to this one:\u003c/p\u003e\n\n\u003cp\u003e\u003ca class=\"markdown-attachment-link markdown-attachment-inline-reference\" data-attachment-filename=\"Screen_Shot_2020-11-13_at_6.12.58_PM.png\" data-attachment-link=\"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/9SxkxusCYkPnqVT3Zm32EU21?response-content-disposition=attachment%3B%20filename%3D%22Screen_Shot_2020-11-13_at_6.12.58_PM.png%22%3B%20filename%2A%3DUTF-8%27%27Screen_Shot_2020-11-13_at_6.12.58_PM.png\u0026amp;response-content-type=image%2Fpng\u0026amp;X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026amp;X-Amz-Credential=ASIAQGK6FURQWAHVAIFX%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026amp;X-Amz-Date=20201229T041254Z\u0026amp;X-Amz-Expires=3600\u0026amp;X-Amz-SignedHeaders=host\u0026amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJGMEQCIAlQQeW6HwbMU642M1YS3mKA0cC7KTy63BC3DVlbPFccAiAFIAQSR2lzVefubZOpcwgfR5JfxC1YyaArdgyTaM5Xciq0AwhUEAEaDDAxMzYxOTI3NDg0OSIMhVACX4KCdTCd%2FRw6KpEDH7Ir%2FUR0ClKGTJlQ%2BggEJWfBJRFHumYkljhzQbv215TMk2tcSYABVZuQU7By29oKTWaf8%2BBeeZC2KQaENvlQxHEtdRGiXKF0XzVE4qfCyr815SuN9T2K6CVJoPIeLFEypjDuwQsGbKNhbqV3htO57CPsVo3JmE4pn0EjAQAoKwhcQ7W4aQyCKpTSZcHwAkGzAc5r2%2FwUKgFaCqM7%2BD56irNaH1IkOZQvOetWi4GIt8beRh49gLMuqviagGeZU7IQCf8qAYmfjSFfY4hB0vtZm2XD32PnJ%2BJpLEwTffTL4g%2FTkNVBT6beuo%2FDgy1lRLvaHY2z1pA5kQ92%2BKYfH0i3J0V%2B3KBN4ZC%2B55WOBuk9ewfbb7pNJj8pBSzEZwskCPEWXiUQm9STvO2MinnVY7xSdefc%2FOKi7zzkJtLbo%2B9hiyZhyHwDOTAZil7bQWU0hqtVtXtIk1IjdlkOebf9Qu2bqSEI0i4t6fQhotplXC%2BrYZk3dUhVKr9a00jpPStA9zNEGx4iX4nn4s58WdXQ0QJiw9Qwvrqq%2FwU67AHxTProz94M1mM2Hw5OeQfI2dL3QiFYx6KdQIdl2BWluloDYtvnMBHgUuNoXRWI3cYiUt08p6tWZoL%2F08jg0%2F%2F2zqwS52GSEB%2BhiT75CcK%2BN2pWY36Ifb9jj650q8ZZEOwFwqWa4sZOpoBDWVxNwewz7WAKPgYJg5mvhskAf0i8DqQitLf8cP1Lkaua7opILp4UuFNU3i86VmKhMuVWEXamFdrdpIr6MzJ2aGun4AIriEUORBOYXYkOpUj4Ashkm8EdbpYJ9WptWabRcAw7%2BLit2UyHv7NB9wiqyjdUxAlyy5qyYk5udmRO5veK0g%3D%3D\u0026amp;X-Amz-Signature=0476a638af412b44889c17652123f7bd5dee162524f4a7790725a1fc1c19f7ab\" data-attachment-type=\"image/png\"\u003e\u003cimg src=\"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/9SxkxusCYkPnqVT3Zm32EU21?response-content-disposition=attachment%3B%20filename%3D%22Screen_Shot_2020-11-13_at_6.12.58_PM.png%22%3B%20filename%2A%3DUTF-8%27%27Screen_Shot_2020-11-13_at_6.12.58_PM.png\u0026amp;response-content-type=image%2Fpng\u0026amp;X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026amp;X-Amz-Credential=ASIAQGK6FURQWAHVAIFX%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026amp;X-Amz-Date=20201229T041254Z\u0026amp;X-Amz-Expires=3600\u0026amp;X-Amz-SignedHeaders=host\u0026amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJGMEQCIAlQQeW6HwbMU642M1YS3mKA0cC7KTy63BC3DVlbPFccAiAFIAQSR2lzVefubZOpcwgfR5JfxC1YyaArdgyTaM5Xciq0AwhUEAEaDDAxMzYxOTI3NDg0OSIMhVACX4KCdTCd%2FRw6KpEDH7Ir%2FUR0ClKGTJlQ%2BggEJWfBJRFHumYkljhzQbv215TMk2tcSYABVZuQU7By29oKTWaf8%2BBeeZC2KQaENvlQxHEtdRGiXKF0XzVE4qfCyr815SuN9T2K6CVJoPIeLFEypjDuwQsGbKNhbqV3htO57CPsVo3JmE4pn0EjAQAoKwhcQ7W4aQyCKpTSZcHwAkGzAc5r2%2FwUKgFaCqM7%2BD56irNaH1IkOZQvOetWi4GIt8beRh49gLMuqviagGeZU7IQCf8qAYmfjSFfY4hB0vtZm2XD32PnJ%2BJpLEwTffTL4g%2FTkNVBT6beuo%2FDgy1lRLvaHY2z1pA5kQ92%2BKYfH0i3J0V%2B3KBN4ZC%2B55WOBuk9ewfbb7pNJj8pBSzEZwskCPEWXiUQm9STvO2MinnVY7xSdefc%2FOKi7zzkJtLbo%2B9hiyZhyHwDOTAZil7bQWU0hqtVtXtIk1IjdlkOebf9Qu2bqSEI0i4t6fQhotplXC%2BrYZk3dUhVKr9a00jpPStA9zNEGx4iX4nn4s58WdXQ0QJiw9Qwvrqq%2FwU67AHxTProz94M1mM2Hw5OeQfI2dL3QiFYx6KdQIdl2BWluloDYtvnMBHgUuNoXRWI3cYiUt08p6tWZoL%2F08jg0%2F%2F2zqwS52GSEB%2BhiT75CcK%2BN2pWY36Ifb9jj650q8ZZEOwFwqWa4sZOpoBDWVxNwewz7WAKPgYJg5mvhskAf0i8DqQitLf8cP1Lkaua7opILp4UuFNU3i86VmKhMuVWEXamFdrdpIr6MzJ2aGun4AIriEUORBOYXYkOpUj4Ashkm8EdbpYJ9WptWabRcAw7%2BLit2UyHv7NB9wiqyjdUxAlyy5qyYk5udmRO5veK0g%3D%3D\u0026amp;X-Amz-Signature=0476a638af412b44889c17652123f7bd5dee162524f4a7790725a1fc1c19f7ab\" class=\"markdown-inline-image\" style=\"display: inline-block\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eIn the backend, this essentially does two things: it creates a \u003ccode\u003eReportDraft\u003c/code\u003e object and a corresponding \u003ccode\u003eInvitation\u003c/code\u003e object. The email above contains the secret invitation token for the user to get access to the report draft. As long as the invitation is not accepted, the \u003ccode\u003eReportDraft\u003c/code\u003e has its \u003ccode\u003ereporter_id\u003c/code\u003e and \u003ccode\u003etracer\u003c/code\u003e attributes set to \u003ccode\u003eNULL\u003c/code\u003e. When a user would accept the invite, the \u003ccode\u003ereporter_id\u003c/code\u003e attribute would be overwritten with the user\u0026#39;s ID who accepted the invitation. For now, let\u0026#39;s not accept the invite and dive into the inner workings of embedded submission forms.\u003c/p\u003e\n\n\u003cp\u003eSimilar to security@ email forwarding, embedded submission forms allow anonymous users to create a \u003ccode\u003eReportDraft\u003c/code\u003e object in the backend. This object contains the current state of the embedded submission form to avoid data loss in case the user happens to close their window. To avoid unauthorized access to other anonymous users writing a report at the same time, the frontend generates a UUID to keep track of which attachments belong to the draft. The \u003ccode\u003eReportDraft\u003c/code\u003e stores this UUID in the \u003ccode\u003etracer\u003c/code\u003e attribute. Only when the user knows the UUID of this draft will it be able to update the draft. Every request triggered for an unauthenticated session in an embedded submission form will submit this UUID for the backend to authorize the user. This is where the first vulnerability is found.\u003c/p\u003e\n\n\u003cp\u003eThe \u003ccode\u003eTeams::EmbeddedSubmissionsController\u003c/code\u003e implements a number of actions, which one of which is \u003ccode\u003edraft_sync\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight ruby\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e# frozen_string_literal: true\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003emodule\u003c/span\u003e \u003cspan class=\"nn\"\u003eTeams\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eEmbeddedSubmissionsController\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"no\"\u003eApplicationController\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e# ...\u003c/span\u003e\n    \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003edraft_sync\u003c/span\u003e\n      \u003cspan class=\"n\"\u003edraft\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003eInteractors\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"no\"\u003eReportDrafts\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"no\"\u003eUpdateOrCreate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003einteract_without_authorization\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"ss\"\u003edraft_id: \u003c/span\u003e\u003cspan class=\"n\"\u003ereport_params\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"ss\"\u003e:draft_id\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e# ...\u003c/span\u003e\n        \u003cspan class=\"ss\"\u003ehandle: \u003c/span\u003e\u003cspan class=\"n\"\u003eteam\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ehandle\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e# ...\u003c/span\u003e\n        \u003cspan class=\"ss\"\u003eattachment_ids: \u003c/span\u003e\u003cspan class=\"n\"\u003ereport_params\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"ss\"\u003e:attachment_ids\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e\n        \u003cspan class=\"ss\"\u003eas_user: \u003c/span\u003e\u003cspan class=\"n\"\u003ecurrent_user\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"ss\"\u003etracer: \u003c/span\u003e\u003cspan class=\"n\"\u003ereport_params\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"ss\"\u003e:tracer\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e# ...\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eHackerOne\u0026#39;s backend consolidates business logic, input validation, and authorization into service objects called interactors. This particular interactor is called explicitly without any form of authorization. Among a few other attributes, the interaction is given a \u003ccode\u003edraft_id\u003c/code\u003e, \u003ccode\u003eattachment_ids\u003c/code\u003e, \u003ccode\u003etracer\u003c/code\u003e, and a reference to the \u003ccode\u003ecurrent_user\u003c/code\u003e, which is an instance of a \u003ccode\u003eUser\u003c/code\u003e object or an instance of \u003ccode\u003eUserAuthentication::AnonymousUser\u003c/code\u003e. The \u003ccode\u003ehandle\u003c/code\u003e attribute that is given is the program\u0026#39;s handle based on embedded submission UUID. At this point, the application \u003cstrong\u003eshould\u003c/strong\u003e determine whether the \u003ccode\u003ecurrent_user\u003c/code\u003e OR a valid \u003ccode\u003etracer\u003c/code\u003e value is present, but this check is missing. This is the first vulnerability. When the interaction is executed, it tries to look up a draft using the following code (see \u003ccode\u003edraft\u003c/code\u003e method):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight ruby\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e# frozen_string_literal: true\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003emodule\u003c/span\u003e \u003cspan class=\"nn\"\u003eInteractors\u003c/span\u003e\n  \u003cspan class=\"k\"\u003emodule\u003c/span\u003e \u003cspan class=\"nn\"\u003eReportDrafts\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eUpdateOrCreate\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"no\"\u003eHackeroneInteractor\u003c/span\u003e\n      \u003cspan class=\"n\"\u003eattribute\u003c/span\u003e \u003cspan class=\"ss\"\u003e:draft_id\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"no\"\u003eInteger\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"ss\"\u003erequired: \u003c/span\u003e\u003cspan class=\"kp\"\u003efalse\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e# ...\u003c/span\u003e\n      \u003cspan class=\"n\"\u003eattribute\u003c/span\u003e \u003cspan class=\"ss\"\u003e:attachment_ids\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"no\"\u003eArray\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"ss\"\u003edefault: \u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e\n      \u003cspan class=\"n\"\u003eattribute\u003c/span\u003e \u003cspan class=\"ss\"\u003e:tracer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"no\"\u003eString\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"ss\"\u003erequired: \u003c/span\u003e\u003cspan class=\"kp\"\u003efalse\u003c/span\u003e\n\n      \u003cspan class=\"kp\"\u003eprivate\u003c/span\u003e\n\n      \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003eexecute\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003edraft_id\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003edraft\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003enil?\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003edraft\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eupdate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n          \u003cspan class=\"c1\"\u003e# ...\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003edraft\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\n      \u003cspan class=\"c1\"\u003e# ...\u003c/span\u003e\n\n      \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003edraft\u003c/span\u003e\n        \u003cspan class=\"vi\"\u003e@draft\u003c/span\u003e \u003cspan class=\"o\"\u003e||=\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003edraft_id\u003c/span\u003e\n          \u003cspan class=\"no\"\u003eReportDraft\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003efind_by\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n            \u003cspan class=\"ss\"\u003eid: \u003c/span\u003e\u003cspan class=\"n\"\u003edraft_id\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"ss\"\u003eteam: \u003c/span\u003e\u003cspan class=\"n\"\u003eteam\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"ss\"\u003ereporter: \u003c/span\u003e\u003cspan class=\"n\"\u003enil_or_current_user\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"ss\"\u003etracer: \u003c/span\u003e\u003cspan class=\"n\"\u003etracer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n          \u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n          \u003cspan class=\"no\"\u003eReportDraft\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003efind_or_initialize_by\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n            \u003cspan class=\"ss\"\u003eteam: \u003c/span\u003e\u003cspan class=\"n\"\u003eteam\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"ss\"\u003ereporter: \u003c/span\u003e\u003cspan class=\"n\"\u003enil_or_current_user\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"ss\"\u003etracer: \u003c/span\u003e\u003cspan class=\"n\"\u003etracer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n          \u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\n      \u003cspan class=\"c1\"\u003e# ...\u003c/span\u003e\n\n      \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003enil_or_current_user\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ecurrent_user\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eis_a?\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"no\"\u003eUser\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"n\"\u003ecurrent_user\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kp\"\u003enil\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eStepping through the code, a user can see that if a \u003ccode\u003edraft_id\u003c/code\u003e is present, the system will try to look up a \u003ccode\u003eReportDraft\u003c/code\u003e object by a tracer UUID and reporter. Going back to the security@ email forwarding, we know that there are \u003ccode\u003eReportDraft\u003c/code\u003e objects that have a \u003ccode\u003etracer\u003c/code\u003e or \u003ccode\u003ereported_by_id\u003c/code\u003e attribute set to \u003ccode\u003eNULL\u003c/code\u003e. This means that an attacker can, by guessing a draft ID created through the security@ email forwarding feature, change the contents of a draft by completely removing the \u003ccode\u003etracer\u003c/code\u003e value from a draft sync that is initiated through the embedded submission form. Here is an excerpt of that request:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight http\"\u003e\u003ccode\u003e\u003cspan class=\"nf\"\u003ePOST\u003c/span\u003e \u003cspan class=\"nn\"\u003e/80b9bc53-a236-445d-a7e4-553828b7d533/embedded_submissions/draft_sync\u003c/span\u003e \u003cspan class=\"k\"\u003eHTTP\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\n\u003cspan class=\"na\"\u003eHost\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003ehackerone.com\u003c/span\u003e\n\u003cspan class=\"s\"\u003e...\u003c/span\u003e\n\n{\n  \u0026quot;draft_id\u0026quot;: \u0026quot;1\u0026quot;,\n  \u0026quot;title\u0026quot;: \u0026quot;This becomes the new title for draft 1\u0026quot;,\n  \u0026quot;vulnerability_information\u0026quot;:\u0026quot;This becomes the new vulnerability information for draft 1\u0026quot;\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eOnce the victim claims the invitation through the email that was shown earlier, they\u0026#39;ll see the updated vulnerability information and title.\u003c/p\u003e\n\n\u003cp\u003e\u003ca class=\"markdown-attachment-link markdown-attachment-inline-reference\" data-attachment-filename=\"Screen_Shot_2020-11-13_at_6.41.57_PM.png\" data-attachment-link=\"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/AJ8yLJBwzUcAdxBwo2VfLKU9?response-content-disposition=attachment%3B%20filename%3D%22Screen_Shot_2020-11-13_at_6.41.57_PM.png%22%3B%20filename%2A%3DUTF-8%27%27Screen_Shot_2020-11-13_at_6.41.57_PM.png\u0026amp;response-content-type=image%2Fpng\u0026amp;X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026amp;X-Amz-Credential=ASIAQGK6FURQWAHVAIFX%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026amp;X-Amz-Date=20201229T041254Z\u0026amp;X-Amz-Expires=3600\u0026amp;X-Amz-SignedHeaders=host\u0026amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJGMEQCIAlQQeW6HwbMU642M1YS3mKA0cC7KTy63BC3DVlbPFccAiAFIAQSR2lzVefubZOpcwgfR5JfxC1YyaArdgyTaM5Xciq0AwhUEAEaDDAxMzYxOTI3NDg0OSIMhVACX4KCdTCd%2FRw6KpEDH7Ir%2FUR0ClKGTJlQ%2BggEJWfBJRFHumYkljhzQbv215TMk2tcSYABVZuQU7By29oKTWaf8%2BBeeZC2KQaENvlQxHEtdRGiXKF0XzVE4qfCyr815SuN9T2K6CVJoPIeLFEypjDuwQsGbKNhbqV3htO57CPsVo3JmE4pn0EjAQAoKwhcQ7W4aQyCKpTSZcHwAkGzAc5r2%2FwUKgFaCqM7%2BD56irNaH1IkOZQvOetWi4GIt8beRh49gLMuqviagGeZU7IQCf8qAYmfjSFfY4hB0vtZm2XD32PnJ%2BJpLEwTffTL4g%2FTkNVBT6beuo%2FDgy1lRLvaHY2z1pA5kQ92%2BKYfH0i3J0V%2B3KBN4ZC%2B55WOBuk9ewfbb7pNJj8pBSzEZwskCPEWXiUQm9STvO2MinnVY7xSdefc%2FOKi7zzkJtLbo%2B9hiyZhyHwDOTAZil7bQWU0hqtVtXtIk1IjdlkOebf9Qu2bqSEI0i4t6fQhotplXC%2BrYZk3dUhVKr9a00jpPStA9zNEGx4iX4nn4s58WdXQ0QJiw9Qwvrqq%2FwU67AHxTProz94M1mM2Hw5OeQfI2dL3QiFYx6KdQIdl2BWluloDYtvnMBHgUuNoXRWI3cYiUt08p6tWZoL%2F08jg0%2F%2F2zqwS52GSEB%2BhiT75CcK%2BN2pWY36Ifb9jj650q8ZZEOwFwqWa4sZOpoBDWVxNwewz7WAKPgYJg5mvhskAf0i8DqQitLf8cP1Lkaua7opILp4UuFNU3i86VmKhMuVWEXamFdrdpIr6MzJ2aGun4AIriEUORBOYXYkOpUj4Ashkm8EdbpYJ9WptWabRcAw7%2BLit2UyHv7NB9wiqyjdUxAlyy5qyYk5udmRO5veK0g%3D%3D\u0026amp;X-Amz-Signature=65973929824bf67b73e80df26b52215657c63189db405b2d41aee7a1e02a2286\" data-attachment-type=\"image/png\"\u003e\u003cimg src=\"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/AJ8yLJBwzUcAdxBwo2VfLKU9?response-content-disposition=attachment%3B%20filename%3D%22Screen_Shot_2020-11-13_at_6.41.57_PM.png%22%3B%20filename%2A%3DUTF-8%27%27Screen_Shot_2020-11-13_at_6.41.57_PM.png\u0026amp;response-content-type=image%2Fpng\u0026amp;X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026amp;X-Amz-Credential=ASIAQGK6FURQWAHVAIFX%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026amp;X-Amz-Date=20201229T041254Z\u0026amp;X-Amz-Expires=3600\u0026amp;X-Amz-SignedHeaders=host\u0026amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJGMEQCIAlQQeW6HwbMU642M1YS3mKA0cC7KTy63BC3DVlbPFccAiAFIAQSR2lzVefubZOpcwgfR5JfxC1YyaArdgyTaM5Xciq0AwhUEAEaDDAxMzYxOTI3NDg0OSIMhVACX4KCdTCd%2FRw6KpEDH7Ir%2FUR0ClKGTJlQ%2BggEJWfBJRFHumYkljhzQbv215TMk2tcSYABVZuQU7By29oKTWaf8%2BBeeZC2KQaENvlQxHEtdRGiXKF0XzVE4qfCyr815SuN9T2K6CVJoPIeLFEypjDuwQsGbKNhbqV3htO57CPsVo3JmE4pn0EjAQAoKwhcQ7W4aQyCKpTSZcHwAkGzAc5r2%2FwUKgFaCqM7%2BD56irNaH1IkOZQvOetWi4GIt8beRh49gLMuqviagGeZU7IQCf8qAYmfjSFfY4hB0vtZm2XD32PnJ%2BJpLEwTffTL4g%2FTkNVBT6beuo%2FDgy1lRLvaHY2z1pA5kQ92%2BKYfH0i3J0V%2B3KBN4ZC%2B55WOBuk9ewfbb7pNJj8pBSzEZwskCPEWXiUQm9STvO2MinnVY7xSdefc%2FOKi7zzkJtLbo%2B9hiyZhyHwDOTAZil7bQWU0hqtVtXtIk1IjdlkOebf9Qu2bqSEI0i4t6fQhotplXC%2BrYZk3dUhVKr9a00jpPStA9zNEGx4iX4nn4s58WdXQ0QJiw9Qwvrqq%2FwU67AHxTProz94M1mM2Hw5OeQfI2dL3QiFYx6KdQIdl2BWluloDYtvnMBHgUuNoXRWI3cYiUt08p6tWZoL%2F08jg0%2F%2F2zqwS52GSEB%2BhiT75CcK%2BN2pWY36Ifb9jj650q8ZZEOwFwqWa4sZOpoBDWVxNwewz7WAKPgYJg5mvhskAf0i8DqQitLf8cP1Lkaua7opILp4UuFNU3i86VmKhMuVWEXamFdrdpIr6MzJ2aGun4AIriEUORBOYXYkOpUj4Ashkm8EdbpYJ9WptWabRcAw7%2BLit2UyHv7NB9wiqyjdUxAlyy5qyYk5udmRO5veK0g%3D%3D\u0026amp;X-Amz-Signature=65973929824bf67b73e80df26b52215657c63189db405b2d41aee7a1e02a2286\" class=\"markdown-inline-image\" style=\"display: inline-block\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eYou can see that the interaction passes \u003cem\u003eall\u003c/em\u003e attributes to the \u003ccode\u003eupdate\u003c/code\u003e call, see \u003ccode\u003eInteractors::ReportDrafts::UpdateOrCreate#execute\u003c/code\u003e. This means that the attacker can only change \u003cem\u003eall\u003c/em\u003e attributes, reducing the likelihood of the expoitation. However, due to the fact that this allows an attacker to change report drafts, the impact on the integrity is set to high. It could be used to tamper with drafts that are in the process of being submitted to a live program.\u003c/p\u003e\n\n\u003cp\u003eTo further increase the severity of the vulnerability, it can be chained with another vulnerability. When a user uploads an attachment through an embedded submission form, it\u0026#39;ll create an \u003ccode\u003eAttachment\u003c/code\u003e object that belongs to the \u003ccode\u003eReportDraft\u003c/code\u003e object. In the backend, its attributes will look like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight json\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;id\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;1\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;uploaded_by_id\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;attachable_id\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;attachable_type\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;ReportDraft\u0026quot;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe \u003ccode\u003eattachable_id\u003c/code\u003e and \u003ccode\u003eattachable_type\u003c/code\u003e form a polymorphic relation to any other persistent model in HackerOne\u0026#39;s database. As long as the user is working on its report, the attachment references a \u003ccode\u003eReportDraft\u003c/code\u003e object. On submission, it\u0026#39;ll transfer the ownership to the \u003ccode\u003eReport\u003c/code\u003e that was created – this is the report that customers see. ActiveRecord, the ORM HackerOne uses, has logic to (conveniently) disassociate a polymorphic relation when the model referencing the polymorphic relation overwrites the IDs. To show this, consider the following code example:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight ruby\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e# Create an attachment. At this time, the `attachable_id` and `attachable_type` are set to `NULL`\u003c/span\u003e\n\u003cspan class=\"n\"\u003eattachment\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003eAttachment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ecreate!\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# Create another attachment. At this time, the `attachable_id` and `attachable_type` are set to `NULL`\u003c/span\u003e\n\u003cspan class=\"n\"\u003eanother_attachment\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003eAttachment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ecreate!\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# Create a report draft and reference the first attachment. The `attachable_id` and `attachable_type` of the attachment are updated to reference the created report draft.\u003c/span\u003e\n\u003cspan class=\"n\"\u003ereport_draft\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003eReportDraft\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ecreate!\u003c/span\u003e \u003cspan class=\"ss\"\u003eattachment_ids: \u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eattachment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# Update the attachment IDs of a report draft. This will do two things:\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e#   - update `attachment.attachable_id` to `NULL`\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e#   - update `another_attachment.attachable_type` to `ReportDraft`\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e#   - update `another_attachment.attachable_id` to `report_draft.id`\u003c/span\u003e\n\u003cspan class=\"n\"\u003ereport_draft\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eupdate!\u003c/span\u003e \u003cspan class=\"ss\"\u003eattachment_ids: \u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eanother_attachment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis means that the \u003ccode\u003eattachment\u003c/code\u003e, as created in the above code example, is not referencing any object at all. There is a code path in HackerOne\u0026#39;s platform to get an attachment in this state: upload an attachment using an embedded submission form, then clicking the \u0026quot;X\u0026quot; to remove it, and type one character in the vulnerability information field to trigger a draft sync. This will leave the first attachment in an orphaned state that has its \u003ccode\u003euploaded_by_id\u003c/code\u003e and \u003ccode\u003eattachable_id\u003c/code\u003e set to \u003ccode\u003eNULL\u003c/code\u003e. Going back to the \u003ccode\u003eInteractors::ReportDrafts::UpdateOrCreate\u003c/code\u003e interactor, there\u0026#39;s a method that associates attachments to a \u003ccode\u003eReportDraft\u003c/code\u003e with the following logic:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight ruby\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e# ...\u003c/span\u003e\n\u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003evalid_attachments\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\n    \u003cspan class=\"n\"\u003edraft\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eattachments\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ewith_attached_file\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ewhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"ss\"\u003eid: \u003c/span\u003e\u003cspan class=\"n\"\u003eattachment_ids\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e\n    \u003cspan class=\"no\"\u003eAttachment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ewith_attached_file\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ewhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n      \u003cspan class=\"ss\"\u003eid: \u003c/span\u003e\u003cspan class=\"n\"\u003eattachment_ids\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"ss\"\u003eattachable_id: \u003c/span\u003e\u003cspan class=\"kp\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"ss\"\u003euploaded_by: \u003c/span\u003e\u003cspan class=\"n\"\u003enil_or_current_user\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003euniq\u003c/span\u003e\n\u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# ...\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe code that contains the vulnerability is the second \u003ccode\u003eAttachment\u003c/code\u003e lookup: it selects all attachment objects that don\u0026#39;t have an \u003ccode\u003eattachable_id\u003c/code\u003e set and that are uploaded by an anonymous user. This means that any attachment that was uploaded by an anonymous user and removed the attachment from a draft can be associated with the attacker\u0026#39;s report draft. There are 823 attachments that match this criteria.\u003c/p\u003e\n\n\u003cp\u003eAn attacker can exploit this chain using the following steps:\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003ein an authenticated session, start typing a report to any program. Observe the network traffic for the \u003ccode\u003edraft_sync\u003c/code\u003e endpoint to determine the latest report draft ID, which is included in the response (e.g. 1).\u003c/li\u003e\n\u003cli\u003ein the same session, upload an attachment and observe which ID was associated (e.g. 5).\u003c/li\u003e\n\u003cli\u003esend an email to the program\u0026#39;s email forwarding address (e.g. \u003ca title=\"security@hackerone.com\" href=\"mailto:security@hackerone.com\" rel=\"nofollow noopener noreferrer\"\u003esecurity@hackerone.com\u003c/a\u003e). This will create a report draft with an ID that is one to ~ ten IDs up from the report draft the authenticated user created.\u003c/li\u003e\n\u003cli\u003e in an incognito browser, go to the program\u0026#39;s embedded submission form URL. An example is \u003ca href=\"https://hackerone.com/80b9bc53-a236-445d-a7e4-553828b7d533/embedded_submissions/new\"\u003eHackerOne\u0026#39;s own form\u003c/a\u003e. Start typing and intercept the request to the \u003ccode\u003edraft_sync\u003c/code\u003e endpoint.\u003c/li\u003e\n\u003cli\u003echange the \u003ccode\u003edraft_id\u003c/code\u003e to the ID obtained in step 1 and completely remove the \u003ccode\u003etracer\u003c/code\u003e value from the request.\u003c/li\u003e\n\u003cli\u003eset the \u003ccode\u003eattachment_ids\u003c/code\u003e to an array containing \u003cem\u003eall\u003c/em\u003e possible attachment IDs from 1 to the ID obtained in step 2\u003c/li\u003e\n\u003cli\u003eclaim the report draft through the invitation you received\u003c/li\u003e\n\u003cli\u003ein the UI, observe that the attachments belonging to the victim are attached to the report draft\u003c/li\u003e\n\u003cli\u003ecopy the ID and inline them in the vulnerability information field, e.g. \u003ccode\u003e{F5}\u003c/code\u003e\n\u003c/li\u003e\n\u003cli\u003ein the report preview section, click the link to obtain a copy of the victim\u0026#39;s attachment\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eThe first vulnerability can be used to change the contents of a number of draft reports that were created through the security@ email forwarding feature. However, chaining the two vulnerabilities would increase the severity as it would allow an attacker to associate orphaned \u003ccode\u003eAttachment\u003c/code\u003e objects to its own report draft, potentially containing sensitive information. The attacker does not have to be authenticated in order to exploit this vulnerability.\u003c/p\u003e\n","weakness":{"id":55,"name":"Insecure Direct Object Reference (IDOR)"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":1077716,"file_name":"Screen_Shot_2020-11-13_at_6.12.58_PM.png","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/9SxkxusCYkPnqVT3Zm32EU21?response-content-disposition=attachment%3B%20filename%3D%22Screen_Shot_2020-11-13_at_6.12.58_PM.png%22%3B%20filename%2A%3DUTF-8%27%27Screen_Shot_2020-11-13_at_6.12.58_PM.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQWAHVAIFX%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T041254Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJGMEQCIAlQQeW6HwbMU642M1YS3mKA0cC7KTy63BC3DVlbPFccAiAFIAQSR2lzVefubZOpcwgfR5JfxC1YyaArdgyTaM5Xciq0AwhUEAEaDDAxMzYxOTI3NDg0OSIMhVACX4KCdTCd%2FRw6KpEDH7Ir%2FUR0ClKGTJlQ%2BggEJWfBJRFHumYkljhzQbv215TMk2tcSYABVZuQU7By29oKTWaf8%2BBeeZC2KQaENvlQxHEtdRGiXKF0XzVE4qfCyr815SuN9T2K6CVJoPIeLFEypjDuwQsGbKNhbqV3htO57CPsVo3JmE4pn0EjAQAoKwhcQ7W4aQyCKpTSZcHwAkGzAc5r2%2FwUKgFaCqM7%2BD56irNaH1IkOZQvOetWi4GIt8beRh49gLMuqviagGeZU7IQCf8qAYmfjSFfY4hB0vtZm2XD32PnJ%2BJpLEwTffTL4g%2FTkNVBT6beuo%2FDgy1lRLvaHY2z1pA5kQ92%2BKYfH0i3J0V%2B3KBN4ZC%2B55WOBuk9ewfbb7pNJj8pBSzEZwskCPEWXiUQm9STvO2MinnVY7xSdefc%2FOKi7zzkJtLbo%2B9hiyZhyHwDOTAZil7bQWU0hqtVtXtIk1IjdlkOebf9Qu2bqSEI0i4t6fQhotplXC%2BrYZk3dUhVKr9a00jpPStA9zNEGx4iX4nn4s58WdXQ0QJiw9Qwvrqq%2FwU67AHxTProz94M1mM2Hw5OeQfI2dL3QiFYx6KdQIdl2BWluloDYtvnMBHgUuNoXRWI3cYiUt08p6tWZoL%2F08jg0%2F%2F2zqwS52GSEB%2BhiT75CcK%2BN2pWY36Ifb9jj650q8ZZEOwFwqWa4sZOpoBDWVxNwewz7WAKPgYJg5mvhskAf0i8DqQitLf8cP1Lkaua7opILp4UuFNU3i86VmKhMuVWEXamFdrdpIr6MzJ2aGun4AIriEUORBOYXYkOpUj4Ashkm8EdbpYJ9WptWabRcAw7%2BLit2UyHv7NB9wiqyjdUxAlyy5qyYk5udmRO5veK0g%3D%3D\u0026X-Amz-Signature=0476a638af412b44889c17652123f7bd5dee162524f4a7790725a1fc1c19f7ab","file_size":119353,"type":"image/png"},{"id":1077723,"file_name":"Screen_Shot_2020-11-13_at_6.41.57_PM.png","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/AJ8yLJBwzUcAdxBwo2VfLKU9?response-content-disposition=attachment%3B%20filename%3D%22Screen_Shot_2020-11-13_at_6.41.57_PM.png%22%3B%20filename%2A%3DUTF-8%27%27Screen_Shot_2020-11-13_at_6.41.57_PM.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQWAHVAIFX%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T041254Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJGMEQCIAlQQeW6HwbMU642M1YS3mKA0cC7KTy63BC3DVlbPFccAiAFIAQSR2lzVefubZOpcwgfR5JfxC1YyaArdgyTaM5Xciq0AwhUEAEaDDAxMzYxOTI3NDg0OSIMhVACX4KCdTCd%2FRw6KpEDH7Ir%2FUR0ClKGTJlQ%2BggEJWfBJRFHumYkljhzQbv215TMk2tcSYABVZuQU7By29oKTWaf8%2BBeeZC2KQaENvlQxHEtdRGiXKF0XzVE4qfCyr815SuN9T2K6CVJoPIeLFEypjDuwQsGbKNhbqV3htO57CPsVo3JmE4pn0EjAQAoKwhcQ7W4aQyCKpTSZcHwAkGzAc5r2%2FwUKgFaCqM7%2BD56irNaH1IkOZQvOetWi4GIt8beRh49gLMuqviagGeZU7IQCf8qAYmfjSFfY4hB0vtZm2XD32PnJ%2BJpLEwTffTL4g%2FTkNVBT6beuo%2FDgy1lRLvaHY2z1pA5kQ92%2BKYfH0i3J0V%2B3KBN4ZC%2B55WOBuk9ewfbb7pNJj8pBSzEZwskCPEWXiUQm9STvO2MinnVY7xSdefc%2FOKi7zzkJtLbo%2B9hiyZhyHwDOTAZil7bQWU0hqtVtXtIk1IjdlkOebf9Qu2bqSEI0i4t6fQhotplXC%2BrYZk3dUhVKr9a00jpPStA9zNEGx4iX4nn4s58WdXQ0QJiw9Qwvrqq%2FwU67AHxTProz94M1mM2Hw5OeQfI2dL3QiFYx6KdQIdl2BWluloDYtvnMBHgUuNoXRWI3cYiUt08p6tWZoL%2F08jg0%2F%2F2zqwS52GSEB%2BhiT75CcK%2BN2pWY36Ifb9jj650q8ZZEOwFwqWa4sZOpoBDWVxNwewz7WAKPgYJg5mvhskAf0i8DqQitLf8cP1Lkaua7opILp4UuFNU3i86VmKhMuVWEXamFdrdpIr6MzJ2aGun4AIriEUORBOYXYkOpUj4Ashkm8EdbpYJ9WptWabRcAw7%2BLit2UyHv7NB9wiqyjdUxAlyy5qyYk5udmRO5veK0g%3D%3D\u0026X-Amz-Signature=65973929824bf67b73e80df26b52215657c63189db405b2d41aee7a1e02a2286","file_size":598328,"type":"image/png"}],"allow_singular_disclosure_at":"2020-12-16T23:39:34.926Z","allow_singular_disclosure_after":-1053199.942154593,"singular_disclosure_allowed":true,"vote_count":75,"voters":["nytr0gen","m0chan","mzfr","the_arch_angel","jobert","mashoud1122","gevakun","kapkan","sameerphad72","mirhat","and 65 more..."],"severity":{"rating":"high","score":7.5,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"high","privileges_required":"none","user_interaction":"required","scope":"unchanged","confidentiality":"high","integrity":"high","availability":"none"}},"structured_scope":{"databaseId":3,"asset_type":"URL","asset_identifier":"https://hackerone.com","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":9820743,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2020-11-14T03:30:53.392Z","updated_at":"2020-11-14T03:30:53.392Z","actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9820746,"is_internal":false,"editable":false,"type":"Activities::NotEligibleForBounty","message":"This vulnerability was found by a HackerOne employee and is therefore not eligible for a bounty.","markdown_message":"\u003cp\u003eThis vulnerability was found by a HackerOne employee and is therefore not eligible for a bounty.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-11-14T03:32:03.706Z","updated_at":"2020-11-14T03:32:03.706Z","actor":{"url":"/security","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"HackerOne"}},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9837762,"is_internal":false,"editable":false,"type":"Activities::BugRetesting","message":"A fix for both vulnerabilities was just released, see the code excerpt below. To ease retesting though, I've gone ahead and seeded the database with a draft and an orphaned attachment. If you use the IDs provided below, you can skip step 1, 2, 3, and 6.\n\n**Draft ID**: 764875\n**Attachment ID**: 1082292\n\nThe fix, as shown below, will return a 500 internal server error when the `tracer` value is missing in an anonymous session. You should observe this in step 5. This addresses the first vulnerability. For the second vulnerability, you should observe that the attachment won't be attached to the report draft (step 8).\n\nIn order to retest this end-to-end, you'll need to use a program that has security@ email forwarding and an embedded submission form enabled. You can use security@hackerone.com and https://hackerone.com/80b9bc53-a236-445d-a7e4-553828b7d533/embedded_submissions/new. Feel free to use these to confirm the fix in case you won't use the IDs as provided above.\n\n**Fix**\n```diff\ndiff --git a/app/backend/interactors/report_drafts/update_or_create.rb b/app/backend/interactors/report_drafts/update_or_create.rb\nindex 247cc08f8a..d375d8d83d 100644\n--- a/app/backend/interactors/report_drafts/update_or_create.rb\n+++ b/app/backend/interactors/report_drafts/update_or_create.rb\n@@ -15,6 +15,10 @@ module Interactors\n       private\n \n       def execute\n+        if !tracer.present? \u0026\u0026 current_user.is_a?(UserAuthentication::AnonymousUser)\n+          fail SecurityError, 'tracer has to be present for anonymous access'\n+        end\n+\n         return if draft_id \u0026\u0026 draft.nil?\n \n         draft.update(\n@@ -66,9 +70,8 @@ module Interactors\n       def valid_attachments\n         (\n           draft.attachments.with_attached_file.where(id: attachment_ids) +\n-          Attachment.with_attached_file.where(\n+          Attachment.with_attached_file.drafts.where(\n             id: attachment_ids,\n-            attachable_id: nil,\n             uploaded_by: nil_or_current_user,\n           )\n         ).uniq\ndiff --git a/app/models/attachment.rb b/app/models/attachment.rb\nindex 459c591e69..f19f1de3d6 100644\n--- a/app/models/attachment.rb\n+++ b/app/models/attachment.rb\n@@ -41,7 +41,7 @@ class Attachment \u003c ApplicationRecord\n       message: 'file name must be less than 255 characters long',\n     }\n \n-  scope :drafts, -\u003e { where attachable: nil }\n+  scope :drafts, -\u003e { where attachable_id: nil, attachable_type: nil }\n \n   MARKDOWN_ID_FORMAT = \\\n     /(?\u003cprefix\u003e^|\\s)(?\u003cinline_start\u003e\\{)?F(?\u003cattachment_id\u003e\\d{1,})(?\u003cinline_end\u003e\\})?/.freeze\n```","markdown_message":"\u003cp\u003eA fix for both vulnerabilities was just released, see the code excerpt below. To ease retesting though, I\u0026#39;ve gone ahead and seeded the database with a draft and an orphaned attachment. If you use the IDs provided below, you can skip step 1, 2, 3, and 6.\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eDraft ID\u003c/strong\u003e: 764875\u003cbr\u003e\n\u003cstrong\u003eAttachment ID\u003c/strong\u003e: 1082292\u003c/p\u003e\n\n\u003cp\u003eThe fix, as shown below, will return a 500 internal server error when the \u003ccode\u003etracer\u003c/code\u003e value is missing in an anonymous session. You should observe this in step 5. This addresses the first vulnerability. For the second vulnerability, you should observe that the attachment won\u0026#39;t be attached to the report draft (step 8).\u003c/p\u003e\n\n\u003cp\u003eIn order to retest this end-to-end, you\u0026#39;ll need to use a program that has security@ email forwarding and an embedded submission form enabled. You can use \u003ca title=\"security@hackerone.com\" href=\"mailto:security@hackerone.com\" rel=\"nofollow noopener noreferrer\"\u003esecurity@hackerone.com\u003c/a\u003e and \u003ca title=\"https://hackerone.com/80b9bc53-a236-445d-a7e4-553828b7d533/embedded_submissions/new\" href=\"https://hackerone.com/80b9bc53-a236-445d-a7e4-553828b7d533/embedded_submissions/new\"\u003ehttps://hackerone.com/80b9bc53-a236-445d-a7e4-553828b7d533/embedded_submissions/new\u003c/a\u003e. Feel free to use these to confirm the fix in case you won\u0026#39;t use the IDs as provided above.\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eFix\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight diff\"\u003e\u003ccode\u003e\u003cspan class=\"gh\"\u003ediff --git a/app/backend/interactors/report_drafts/update_or_create.rb b/app/backend/interactors/report_drafts/update_or_create.rb\nindex 247cc08f8a..d375d8d83d 100644\n\u003c/span\u003e\u003cspan class=\"gd\"\u003e--- a/app/backend/interactors/report_drafts/update_or_create.rb\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+++ b/app/backend/interactors/report_drafts/update_or_create.rb\n\u003c/span\u003e\u003cspan class=\"p\"\u003e@@ -15,6 +15,10 @@\u003c/span\u003e module Interactors\n       private\n\n       def execute\n\u003cspan class=\"gi\"\u003e+        if !tracer.present? \u0026amp;\u0026amp; current_user.is_a?(UserAuthentication::AnonymousUser)\n+          fail SecurityError, \u0026#39;tracer has to be present for anonymous access\u0026#39;\n+        end\n+\n\u003c/span\u003e         return if draft_id \u0026amp;\u0026amp; draft.nil?\n\n         draft.update(\n\u003cspan class=\"p\"\u003e@@ -66,9 +70,8 @@\u003c/span\u003e module Interactors\n       def valid_attachments\n         (\n           draft.attachments.with_attached_file.where(id: attachment_ids) +\n\u003cspan class=\"gd\"\u003e-          Attachment.with_attached_file.where(\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+          Attachment.with_attached_file.drafts.where(\n\u003c/span\u003e             id: attachment_ids,\n\u003cspan class=\"gd\"\u003e-            attachable_id: nil,\n\u003c/span\u003e             uploaded_by: nil_or_current_user,\n           )\n         ).uniq\n\u003cspan class=\"gh\"\u003ediff --git a/app/models/attachment.rb b/app/models/attachment.rb\nindex 459c591e69..f19f1de3d6 100644\n\u003c/span\u003e\u003cspan class=\"gd\"\u003e--- a/app/models/attachment.rb\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+++ b/app/models/attachment.rb\n\u003c/span\u003e\u003cspan class=\"p\"\u003e@@ -41,7 +41,7 @@\u003c/span\u003e class Attachment \u0026lt; ApplicationRecord\n       message: \u0026#39;file name must be less than 255 characters long\u0026#39;,\n     }\n\n-  scope :drafts, -\u0026gt; { where attachable: nil }\n\u003cspan class=\"gi\"\u003e+  scope :drafts, -\u0026gt; { where attachable_id: nil, attachable_type: nil }\n\u003c/span\u003e\n   MARKDOWN_ID_FORMAT = \\\n     /(?\u0026lt;prefix\u0026gt;^|\\s)(?\u0026lt;inline_start\u0026gt;\\{)?F(?\u0026lt;attachment_id\u0026gt;\\d{1,})(?\u0026lt;inline_end\u0026gt;\\})?/.freeze\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","automated_response":false,"created_at":"2020-11-16T22:11:36.006Z","updated_at":"2020-11-16T22:11:36.174Z","actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","report_retest":{"id":3074,"retest_subscription":{"triage":false}},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9837805,"is_internal":false,"editable":false,"type":"Activities::ExternalUserJoined","message":"","markdown_message":"","automated_response":false,"created_at":"2020-11-16T22:20:35.763Z","updated_at":"2020-11-16T22:20:35.763Z","additional_data":{"report_retest_user_id":8615},"actor":{"username":"haxta4ok00","cleared":false,"url":"/haxta4ok00","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/049/175/8449afdd3403f4de00b34719ee09823bad1c0a06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9838134,"is_internal":false,"editable":false,"type":"Activities::UserCompletedRetest","message":"Hi @jobert -- After trying to use this PoC, When i  try to delete the tracer parameter, error 500 is returned and the files are not attached!  Since this fixes the first vulnerability , it won't work for the second!\n\nNice find @jobert , and good work to fix!\n\n\n","markdown_message":"\u003cp\u003eHi \u003ca href=\"/jobert\"\u003e@jobert\u003c/a\u003e -- After trying to use this PoC, When i  try to delete the tracer parameter, error 500 is returned and the files are not attached!  Since this fixes the first vulnerability , it won\u0026#39;t work for the second!\u003c/p\u003e\n\n\u003cp\u003eNice find \u003ca href=\"/jobert\"\u003e@jobert\u003c/a\u003e , and good work to fix!\u003c/p\u003e\n","automated_response":false,"created_at":"2020-11-16T23:23:18.347Z","updated_at":"2020-11-16T23:23:18.347Z","actor":{"username":"haxta4ok00","cleared":false,"url":"/haxta4ok00","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/049/175/8449afdd3403f4de00b34719ee09823bad1c0a06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9838146,"is_internal":false,"editable":false,"type":"Activities::ReportRetestApproved","message":"Thanks for confirming, @haxta4ok00, it's much appreciated!","markdown_message":"\u003cp\u003eThanks for confirming, \u003ca href=\"/haxta4ok00\"\u003e@haxta4ok00\u003c/a\u003e, it\u0026#39;s much appreciated!\u003c/p\u003e\n","automated_response":false,"created_at":"2020-11-16T23:25:55.453Z","updated_at":"2020-11-16T23:25:55.453Z","actor":{"url":"/security","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"HackerOne"}},"genius_execution_id":null,"team_handle":"security","report_retest_user":{"user":{"username":"haxta4ok00"},"report_retest":{"retest_subscription":{"tag":"new","triage":false,"awarding_retesters":true}}},"actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9838147,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","markdown_message":"","automated_response":false,"created_at":"2020-11-16T23:25:55.627Z","updated_at":"2020-11-16T23:25:55.627Z","actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"reporter":{"username":"jobert","url":"/jobert"},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9838196,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"The incident response team ran a query that determined which attachments ever were attached to multiple `ReportDraft` objects. In total, 15 cases were identified. The team determined, after manually auditing these, that none of these were related to any malicious intent.","markdown_message":"\u003cp\u003eThe incident response team ran a query that determined which attachments ever were attached to multiple \u003ccode\u003eReportDraft\u003c/code\u003e objects. In total, 15 cases were identified. The team determined, after manually auditing these, that none of these were related to any malicious intent.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-11-16T23:39:34.840Z","updated_at":"2020-11-17T00:20:56.560Z","first_to_agree":true,"actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9838373,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-11-17T00:42:05.604Z","updated_at":"2020-11-17T00:42:05.604Z","actor":{"username":"bencode","cleared":false,"url":"/bencode","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/117/ddaa1da4e004e1234c6857c42f9bfa8df85b5ccf_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9838374,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-11-17T00:42:05.699Z","updated_at":"2020-11-17T00:42:05.699Z","actor":{"username":"bencode","cleared":false,"url":"/bencode","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/117/ddaa1da4e004e1234c6857c42f9bfa8df85b5ccf_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}