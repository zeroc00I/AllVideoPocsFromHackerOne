{"id":7277,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC83Mjc3","url":"https://hackerone.com/reports/7277","title":"TLS Triple Handshake Attack","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2014-03-03T15:20:55.000Z","submitted_at":"2014-03-03T15:20:55.000Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"prosecco-inria","url":"/prosecco-inria","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/001/622/679da80a2cf472ca928f6b28f1a6e20f83612325_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":20,"url":"https://hackerone.com/internet","handle":"internet","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/e3e1c58882b2645d9108ec102731a354cbf5852e_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/e3e1c58882b2645d9108ec102731a354cbf5852e_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"The Internet","twitter_handle":null,"website":"","about":"Hack all the things."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2014-03-03T15:20:55.000Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2014-03-03T15:20:55.000Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"More details are at https://secure-resumption.com [2]\n\nScenario\n======\nConsider a client C that normally authenticates to a server S using a client certificate.  If C uses the same certificate to authenticate to a malicious server M, then we show that M can use C's certificate to authenticate its own connection to S.\n\nThe attack relies on the combination of an initial RSA or DHE handshake, followed by session resumption on a new connection, followed by a client-authenticated renegotiation. During the first two handshakes, C has a connection to M and M has a connection to S. During the third handshake, M is able to authenticate as C to S and as S to C.\n\nThis server-based man-in-the-middle attack should normally have been prevented by the Renegotiation Indication (RI) extension [3] but by injecting session resumption between the two full handshakes, we are able to bypass the renegotiation countermeasure.\n\nTriple Handshake Attack\n================\nI'll briefly summarise the attack below for an initial RSA key exchange.  The webpage [2] has diagrams that will be easier to follow, describes more attack variants, and provides some disclosure status.\n\nThe attack proceeds in three steps:\n\nStep 1. (Initial Handshakes C-M, M-S)\n\n- C connects to M and M connects to S, both handshakes use RSA.\n- M forwards C's and S's client hellos to each other.\n- M receives an encrypted PMS from C and reencrypts it towards S.\n- Both handshakes complete with new sessions and record keys.\n- Both sessions have the same master secret, random nonces, and session id.  (M knows the master secret and record keys since it participated in both handshakes)\n\nStep 2. (Session Resumption C-M, M-S)\n\n- C resumes its session with M on a new connection.\t     \n- M resumes its session with S on a new connection.\n- M forwards all the abbreviated handshake messages unchanged between C and S.\n- Note that the RI extensions on both handshakes are empty, since it is the first handshake on the connection\n- Both handshakes complete with new record keys (and reuse old sessions)\n- Both connections have the same record keys and handshake logs (verify data)\n  (M still knows the record keys and can send messages in either direction.)\n\nStep 3. (Renegotiation C-M-S)\n\n- S requests M for renegotiation with client certificate. \n- M requests C for renegotiation with client certificate.\n- M forwards all renegotiation messages unchanged between C and S \n- Note that since the handshake logs in the preceding handshake were the same, the RI extensions on both handshakes will be the same.\n- Both handshakes complete with new mutually-authenticated sessions and record keys. C now thinks it is connected to S and S thinks it is connected to C.\n- (M does not know the new record keys but its previous messages to S on the same connection \n  may be treated as authenticated by C.)\n\nAt the end of Step 3, S has an incoming connection on which it initially received data from an anonymous client (M) and later received data from an authenticated client (C). This breaks the intended guarantees of the RI extension.\n\nCountermeasures \n===========\nDuring Step 3, C has a connection on which it first received M's certificate and later S's certificate. If C refuses to accept this change of server identity, then it can prevent Step 3 of the attack. Indeed, we recommend mainstream web browsers and HTTPS libraries should systematically forbid the change of server identities during renegotiation.\n\nHowever, already at the end of Step 2, a number of connection and session parameters, such as the tls-unique channel binding for the two connections are the same. So any application-level mechanism that relies on the TLS master secret [4] or channel bindings [5] or exports TLS keying material [6] is vulnerable to a similar man-in-the-middle attack.\n\nWe argue that the core vulnerability here is that the TLS master secret is not bound to enough elements of the TLS session. We propose a new TLS extension that binds the master secret to the hash of the all relevant handshake messages in the initial handshake.\n\nThe proposed draft is available at: http://secure-resumption.com/draft-bhargavan-tls-session-hash-00.txt\n\nThe key idea is that each full handshake is associated with a session hash, computed as\n\t\n```\n\tsession_hash = Hash(handshake_messages) \n```\n\t\nwhere handshake_messages consist of all messages up to and including the ClientKeyExchange.  The extended master secret computation enabled by the extension is then computed as\n\t\n```\n\tmaster_secret = PRF(pre_master_secret, \n                                        \"extended master secret\", \n                                         session_hash) [0..47]; \n```\n\t\nWe've implemented this extension in OpenSSL without much difficulty.  Changing the master secret derivation may seem radical, but we believe it is the main way to counter future attacks that may rely on the session synchronization (step 1) that we exploit here.\n\nAn alternative countermeasure would be an extension (along the lines of [3]) that includes the session hash as defined above in the ClientHello and ServerHello messages of the abbreviated handshake. This would provide an explicit link between the resumption handshake and its original full handshake, and hence prevent the renegotiation attack described above.\n\nWe welcome comments and suggestions.\n-Karthik Bhargavan, Antoine Delignat-Lavaud, and Alfredo Pironti\n\n[1] http://mitls.org\n[2] https://secure-resumption.com\n[3] RFC5746: Transport Layer Security Renegotiation Indication Extension\n[4] The Compound Authentication Binding Problem (draft-puthenkulam-eap-binding-04)\n[5] RFC5929: Channel Bindings for TLS\n[6] RFC5705: Keying Material Exporters for Transport Layer Security\n","vulnerability_information_html":"\u003cp\u003eMore details are at \u003ca title=\"https://secure-resumption.com\" href=\"/redirect?url=https%3A%2F%2Fsecure-resumption.com\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://secure-resumption.com\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e [2]\u003c/p\u003e\n\n\u003ch1 id=\"scenario\"\u003eScenario\u003c/h1\u003e\n\n\u003cp\u003eConsider a client C that normally authenticates to a server S using a client certificate.  If C uses the same certificate to authenticate to a malicious server M, then we show that M can use C\u0026#39;s certificate to authenticate its own connection to S.\u003c/p\u003e\n\n\u003cp\u003eThe attack relies on the combination of an initial RSA or DHE handshake, followed by session resumption on a new connection, followed by a client-authenticated renegotiation. During the first two handshakes, C has a connection to M and M has a connection to S. During the third handshake, M is able to authenticate as C to S and as S to C.\u003c/p\u003e\n\n\u003cp\u003eThis server-based man-in-the-middle attack should normally have been prevented by the Renegotiation Indication (RI) extension [3] but by injecting session resumption between the two full handshakes, we are able to bypass the renegotiation countermeasure.\u003c/p\u003e\n\n\u003ch1 id=\"triple-handshake-attack\"\u003eTriple Handshake Attack\u003c/h1\u003e\n\n\u003cp\u003eI\u0026#39;ll briefly summarise the attack below for an initial RSA key exchange.  The webpage [2] has diagrams that will be easier to follow, describes more attack variants, and provides some disclosure status.\u003c/p\u003e\n\n\u003cp\u003eThe attack proceeds in three steps:\u003c/p\u003e\n\n\u003cp\u003eStep 1. (Initial Handshakes C-M, M-S)\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eC connects to M and M connects to S, both handshakes use RSA.\u003c/li\u003e\n\u003cli\u003eM forwards C\u0026#39;s and S\u0026#39;s client hellos to each other.\u003c/li\u003e\n\u003cli\u003eM receives an encrypted PMS from C and reencrypts it towards S.\u003c/li\u003e\n\u003cli\u003eBoth handshakes complete with new sessions and record keys.\u003c/li\u003e\n\u003cli\u003eBoth sessions have the same master secret, random nonces, and session id.  (M knows the master secret and record keys since it participated in both handshakes)\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eStep 2. (Session Resumption C-M, M-S)\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eC resumes its session with M on a new connection.\u003cbr\u003e\n\u003c/li\u003e\n\u003cli\u003eM resumes its session with S on a new connection.\u003c/li\u003e\n\u003cli\u003eM forwards all the abbreviated handshake messages unchanged between C and S.\u003c/li\u003e\n\u003cli\u003eNote that the RI extensions on both handshakes are empty, since it is the first handshake on the connection\u003c/li\u003e\n\u003cli\u003eBoth handshakes complete with new record keys (and reuse old sessions)\u003c/li\u003e\n\u003cli\u003eBoth connections have the same record keys and handshake logs (verify data)\n(M still knows the record keys and can send messages in either direction.)\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eStep 3. (Renegotiation C-M-S)\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eS requests M for renegotiation with client certificate. \u003c/li\u003e\n\u003cli\u003eM requests C for renegotiation with client certificate.\u003c/li\u003e\n\u003cli\u003eM forwards all renegotiation messages unchanged between C and S \u003c/li\u003e\n\u003cli\u003eNote that since the handshake logs in the preceding handshake were the same, the RI extensions on both handshakes will be the same.\u003c/li\u003e\n\u003cli\u003eBoth handshakes complete with new mutually-authenticated sessions and record keys. C now thinks it is connected to S and S thinks it is connected to C.\u003c/li\u003e\n\u003cli\u003e(M does not know the new record keys but its previous messages to S on the same connection \nmay be treated as authenticated by C.)\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eAt the end of Step 3, S has an incoming connection on which it initially received data from an anonymous client (M) and later received data from an authenticated client (C). This breaks the intended guarantees of the RI extension.\u003c/p\u003e\n\n\u003ch1 id=\"countermeasures\"\u003eCountermeasures \u003c/h1\u003e\n\n\u003cp\u003eDuring Step 3, C has a connection on which it first received M\u0026#39;s certificate and later S\u0026#39;s certificate. If C refuses to accept this change of server identity, then it can prevent Step 3 of the attack. Indeed, we recommend mainstream web browsers and HTTPS libraries should systematically forbid the change of server identities during renegotiation.\u003c/p\u003e\n\n\u003cp\u003eHowever, already at the end of Step 2, a number of connection and session parameters, such as the tls-unique channel binding for the two connections are the same. So any application-level mechanism that relies on the TLS master secret [4] or channel bindings [5] or exports TLS keying material [6] is vulnerable to a similar man-in-the-middle attack.\u003c/p\u003e\n\n\u003cp\u003eWe argue that the core vulnerability here is that the TLS master secret is not bound to enough elements of the TLS session. We propose a new TLS extension that binds the master secret to the hash of the all relevant handshake messages in the initial handshake.\u003c/p\u003e\n\n\u003cp\u003eThe proposed draft is available at: \u003ca title=\"http://secure-resumption.com/draft-bhargavan-tls-session-hash-00.txt\" href=\"/redirect?url=http%3A%2F%2Fsecure-resumption.com%2Fdraft-bhargavan-tls-session-hash-00.txt\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttp://secure-resumption.com/draft-bhargavan-tls-session-hash-00.txt\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eThe key idea is that each full handshake is associated with a session hash, computed as\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e    session_hash = Hash(handshake_messages) \n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003ewhere handshake_messages consist of all messages up to and including the ClientKeyExchange.  The extended master secret computation enabled by the extension is then computed as\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e    master_secret = PRF(pre_master_secret, \n                                        \u0026quot;extended master secret\u0026quot;, \n                                         session_hash) [0..47]; \n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eWe\u0026#39;ve implemented this extension in OpenSSL without much difficulty.  Changing the master secret derivation may seem radical, but we believe it is the main way to counter future attacks that may rely on the session synchronization (step 1) that we exploit here.\u003c/p\u003e\n\n\u003cp\u003eAn alternative countermeasure would be an extension (along the lines of [3]) that includes the session hash as defined above in the ClientHello and ServerHello messages of the abbreviated handshake. This would provide an explicit link between the resumption handshake and its original full handshake, and hence prevent the renegotiation attack described above.\u003c/p\u003e\n\n\u003cp\u003eWe welcome comments and suggestions.\u003cbr\u003e\n-Karthik Bhargavan, Antoine Delignat-Lavaud, and Alfredo Pironti\u003c/p\u003e\n\n\u003cp\u003e[1] \u003ca title=\"http://mitls.org\" href=\"/redirect?url=http%3A%2F%2Fmitls.org\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttp://mitls.org\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003cbr\u003e\n[2] \u003ca title=\"https://secure-resumption.com\" href=\"/redirect?url=https%3A%2F%2Fsecure-resumption.com\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://secure-resumption.com\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003cbr\u003e\n[3] RFC5746: Transport Layer Security Renegotiation Indication Extension\u003cbr\u003e\n[4] The Compound Authentication Binding Problem (draft-puthenkulam-eap-binding-04)\u003cbr\u003e\n[5] RFC5929: Channel Bindings for TLS\u003cbr\u003e\n[6] RFC5705: Keying Material Exporters for Transport Layer Security\u003c/p\u003e\n","bounty_amount":"7500.0","formatted_bounty":"$7,500","original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":10,"voters":["madrobot","nigba","4mit44","in_vi_sible","find0xt","deb_runknown","aminesh","garry-sharma","tinydancer","jordan8908643257888"],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":29174,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2014-04-12T03:29:00.464Z","updated_at":"2014-04-12T03:29:00.464Z","actor":{"url":"/internet","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/e3e1c58882b2645d9108ec102731a354cbf5852e_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"The Internet"}},"bounty_amount":"7500.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"internet","collaborator":{"username":"prosecco-inria","url":"/prosecco-inria"},"actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1196071,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":null,"markdown_message":"","automated_response":false,"created_at":"2014-04-12T03:29:00.464Z","updated_at":"2016-09-15T13:28:48.881Z","actor":{"url":"/internet","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/e3e1c58882b2645d9108ec102731a354cbf5852e_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"The Internet"}},"reporter":{"username":"prosecco-inria","url":"/prosecco-inria"},"genius_execution_id":null,"team_handle":"internet","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}