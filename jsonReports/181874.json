{"id":181874,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xODE4NzQ=","url":"https://hackerone.com/reports/181874","title":"SIGSEGV when invalid argument on remove_method","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2016-11-13T05:35:56.082Z","submitted_at":"2016-11-13T05:35:56.082Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"jpenalbae","url":"/jpenalbae","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":15668,"url":"https://hackerone.com/shopify-scripts","handle":"shopify-scripts","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"shopify-scripts","twitter_handle":"","website":"","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2016-12-17T02:30:48.759Z","bug_reporter_agreed_on_going_public_at":"2016-12-17T02:30:48.705Z","team_member_agreed_on_going_public_at":"2016-12-16T19:51:25.211Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"There is an invalid memory read on mruby when calling to `remove_method` with invalid arguments which causes a SIGSEGV which leads into denial of service.\n\n## Sample\n\nThe following code tries to remove a method using a `nil` as argument\n```ruby\nclass Child\n   remove_method nil\nend\n```\n\nThere are many other variants, such as using a float, an integer, a string, a Class, etc... Which obviously are non valid method symbols.\n```ruby\nclass Child\n   remove_method 1\n   remove_method 2.123\n   remove_method 'aaaa'\n   remove_method Child\nend\n```\n\n## Crash\n\nHere we can see the crash (full crash output attached)\n```\n$ ruby bin/sandbox ../triage/uniq/min/segv/mrb_type \u003e /tmp/full-crash.log\nbin/sandbox:20: [BUG] Segmentation fault at 0x0000000000000e\nruby 2.3.1p112 (2016-04-26) [x86_64-linux-gnu]\n\n-- Control frame information -----------------------------------------------\nc:0003 p:---- s:0010 e:000009 CFUNC  :sandbox_eval\nc:0002 p:0201 s:0005 E:001e48 EVAL   bin/sandbox:20 [FINISH]\nc:0001 p:0000 s:0002 E:001e00 (none) [FINISH]\n\n-- Ruby level backtrace information ----------------------------------------\nbin/sandbox:20:in `\u003cmain\u003e'\nbin/sandbox:20:in `sandbox_eval'\n\n-- Machine register context ------------------------------------------------\n RIP: 0x00007f8c4d77d554 RBP: 0x00007f8c4c2fe4e0 RSP: 0x00007f8c4c2fc898\n RAX: 0x000000000000008f RBX: 0x0000000000000006 RCX: 0x00007f8c4d7fbf83\n RDX: 0x000000000000008f RDI: 0x00007f8c4c2fe4e0 RSI: 0x0000000000000006\n  R8: 0x00007f8c4d7f842f  R9: 0x00007f8c4c2fe010 R10: 0x0000000000000191\n R11: 0x00007f8c4d77d540 R12: 0x0000000000000010 R13: 0x000000000000008f\n R14: 0x00007f8c4c306160 R15: 0x00007f8c4c306100 EFL: 0x0000000000010246\n\n-- C level backtrace information -------------------------------------------\n/usr/lib/x86_64-linux-gnu/libruby-2.3.so.2.3 [0x7f8c51a96ea5]\n/usr/lib/x86_64-linux-gnu/libruby-2.3.so.2.3 [0x7f8c51a970dc]\n/usr/lib/x86_64-linux-gnu/libruby-2.3.so.2.3 [0x7f8c51971364]\n/usr/lib/x86_64-linux-gnu/libruby-2.3.so.2.3 [0x7f8c51a22dbe]\n/lib/x86_64-linux-gnu/libpthread.so.0 [0x7f8c516f5ed0]\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_respond_to+0x14) [0x7f8c4d77d554] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/include/mruby/boxing_word.h:71\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_check_convert_type+0x6b) [0x7f8c4d78c63b] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/object.c:310\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_check_string_type+0x1c) [0x7f8c4d7897cc] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/string.c:1743\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(join_ary+0xad) [0x7f8c4d78fe0d] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/array.c:1007\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_ary_join+0x2e) [0x7f8c4d790dbe] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/array.c:1031\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_vformat+0x14b) [0x7f8c4d7a28cb] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/error.c:345\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_name_error+0x92) [0x7f8c4d7a2ae2] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/error.c:382\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_mod_remove_method+0x137) [0x7f8c4d77c3c7] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/class.c:1985\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_vm_exec+0x762) [0x7f8c4d795cf2] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/vm.c:1165\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_vm_run+0x57) [0x7f8c4d79b567] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/vm.c:766\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mruby_engine_monitored_eval+0x113) [0x7f8c4d76f173] ../../../../ext/mruby_engine/eval_monitored.c:68\n/lib/x86_64-linux-gnu/libpthread.so.0 [0x7f8c516ec464]\n/lib/x86_64-linux-gnu/libc.so.6(__clone+0x6d) [0x7f8c50a6830d]\n\n```\n\n## Crash debug\n\n```\n(gdb) r\nStarting program: /usr/bin/ruby bin/sandbox /tmp/crasher.rb\n[Thread debugging using libthread_db enabled]\nUsing host libthread_db library \"/lib/x86_64-linux-gnu/libthread_db.so.1\".\n[New Thread 0x7ffff7ff5700 (LWP 21707)]\n[New Thread 0x7ffff2348700 (LWP 21758)]\n\nProgram received signal SIGSEGV, Segmentation fault.\n[Switching to Thread 0x7ffff2348700 (LWP 21758)]\nmrb_class (v=..., mrb=mrb@entry=0x7ffff23494e0) at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/include/mruby/class.h:50\n50          return mrb_obj_ptr(v)-\u003ec;\n(gdb) x/1i $rip\n=\u003e 0x7ffff37c8554 \u003cmrb_respond_to+20\u003e:  mov    rsi,QWORD PTR [rsi+0x8]\n(gdb) i r rsi\nrsi            0x6      6\n(gdb) x/1xg $rsi+0x8\n0xe:    Cannot access memory at address 0xe\n```\n\nThe crash happens at `ext/mruby_engine/mruby/include/mruby/class.h:50`\n```c\nstatic inline struct RClass*\nmrb_class(mrb_state *mrb, mrb_value v)\n{\n  switch (mrb_type(v)) {\n  case MRB_TT_FALSE:\n    if (mrb_fixnum(v))\n      return mrb-\u003efalse_class;\n    return mrb-\u003enil_class;\n  case MRB_TT_TRUE:\n    return mrb-\u003etrue_class;\n  case MRB_TT_SYMBOL:\n    return mrb-\u003esymbol_class;\n  case MRB_TT_FIXNUM:\n    return mrb-\u003efixnum_class;\n  case MRB_TT_FLOAT:\n    return mrb-\u003efloat_class;\n  case MRB_TT_CPTR:\n    return mrb-\u003eobject_class;\n  case MRB_TT_ENV:\n    return NULL;\n  default:\n    return mrb_obj_ptr(v)-\u003ec;  /* BUG: Bad memory access */\n  }\n}\n```\n\nIf we check the vale `v`:\n```\n(gdb) print v\n$1 = {\n  value = {\n    p = 0x6,\n    {\n      i_flag = 0,\n      i = 3\n    },\n    {\n      sym_flag = 6,\n      sym = 0\n    },\n    bp = 0x6,\n    fp = 0x6,\n    vp = 0x6\n  },\n  w = 6\n}\n```\n`mrb_obj_ptr` is the following macro\n```c\n#define mrb_obj_ptr(v)   ((struct RObject*)(mrb_ptr(v)))\n```\n\nSo `mrb_obj_ptr(v)-\u003ec` would be equivalent to this:\n```\n(gdb) print ((struct RObject*)v)-\u003ec\nCannot access memory at address 0xe\n(gdb) print \u0026((struct RObject*)v)-\u003ec\n$2 = (struct RClass **) 0xe\n```\n\nIf we check the backtrace:\n```\n(gdb) bt\n#0  mrb_class (v=..., mrb=mrb@entry=0x7ffff23494e0) at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/include/mruby/class.h:50\n#1  mrb_respond_to (mrb=mrb@entry=0x7ffff23494e0, obj=obj@entry=..., mid=mid@entry=143)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/class.c:1492\n#2  0x00007ffff37d763b in convert_type (raise=0 '\\000', method=0x7ffff384342f \"to_str\", tname=0x7ffff3844446 \"String\", val=..., mrb=0x7ffff23494e0)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/object.c:310\n#3  mrb_check_convert_type (mrb=mrb@entry=0x7ffff23494e0, val=..., type=type@entry=MRB_TT_STRING, tname=tname@entry=0x7ffff3844446 \"String\",\n    method=method@entry=0x7ffff384342f \"to_str\") at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/object.c:352\n#4  0x00007ffff37d47cc in mrb_check_string_type (mrb=mrb@entry=0x7ffff23494e0, str=..., str@entry=...)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/string.c:1743\n#5  0x00007ffff37dae0d in join_ary (mrb=mrb@entry=0x7ffff23494e0, ary=ary@entry=..., sep=sep@entry=..., list=...)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/array.c:1007\n#6  0x00007ffff37dbdbe in mrb_ary_join (mrb=mrb@entry=0x7ffff23494e0, ary=ary@entry=..., sep=...)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/array.c:1031\n#7  0x00007ffff37ed8cb in mrb_vformat (mrb=mrb@entry=0x7ffff23494e0, format=0x7ffff3843547 \"method '%S' not defined in %S\", ap=ap@entry=0x7ffff23479a8)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/error.c:345\n#8  0x00007ffff37edae2 in mrb_name_error (mrb=mrb@entry=0x7ffff23494e0, id=id@entry=0, fmt=fmt@entry=0x7ffff3843547 \"method '%S' not defined in %S\")\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/error.c:382\n#9  0x00007ffff37c73c7 in remove_method (mid=0, mod=..., mrb=0x7ffff23494e0)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/class.c:1985\n#10 mrb_mod_remove_method (mrb=0x7ffff23494e0, mod=...) at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/class.c:2006\n#11 0x00007ffff37e0cf2 in mrb_vm_exec (mrb=mrb@entry=0x7ffff23494e0, proc=\u003coptimized out\u003e, proc@entry=0x7ffff2351520, pc=\u003coptimized out\u003e)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/vm.c:1165\n#12 0x00007ffff37e6567 in mrb_vm_run (mrb=0x7ffff23494e0, proc=0x7ffff2351520, self=..., stack_keep=stack_keep@entry=0)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/vm.c:766\n#13 0x00007ffff37ba173 in mruby_engine_monitored_eval (data=0x7ffff23493e0) at ../../../../ext/mruby_engine/eval_monitored.c:68\n#14 0x00007ffff7737464 in start_thread (arg=0x7ffff2348700) at pthread_create.c:333\n#15 0x00007ffff6ab330d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109\n(gdb)\n```\n\nWe can see that whenever the desired method to delete is not found, mruby will raise an error. This is handled by `remove_method()` at `ext/mruby_engine/mruby/src/class.c:1985`:\n```c\nstatic void\nremove_method(mrb_state *mrb, mrb_value mod, mrb_sym mid)\n{\n  struct RClass *c = mrb_class_ptr(mod);\n  khash_t(mt) *h = find_origin(c)-\u003emt;\n  khiter_t k;\n\n  if (h) {\n    k = kh_get(mt, mrb, h, mid);\n    if (k != kh_end(h)) {\n      kh_del(mt, mrb, h, k);\n      mrb_funcall(mrb, mod, \"method_removed\", 1, mrb_symbol_value(mid));\n      return;\n    }\n  }\n\n  mrb_name_error(mrb, mid, \"method '%S' not defined in %S\",\n    mrb_sym2str(mrb, mid), mod);  /* \u003c--- Raise an error */\n}\n```\n\nLater on, mruby tries to convert the symbol in order to print it which is what causes the crash.\n\n## Proposed fix\n\nAs the arguments for `remove_method()` should at least be a method type symbol. I propose the following check at `mrb_mod_remove_method()`\n```diff\ndiff --git a/src/class.c b/src/class.c\nindex 47a6c84..a898b46 100644\n--- a/src/class.c\n+++ b/src/class.c\n@@ -2003,6 +2003,11 @@ mrb_mod_remove_method(mrb_state *mrb, mrb_value mod)\n\n   mrb_get_args(mrb, \"*\", \u0026argv, \u0026argc);\n   while (argc--) {\n+\n+    /* Crash fix. Ignore invalid types */\n+    if ((!argv-\u003evalue.sym) || (argv-\u003evalue.sym_flag != MRB_SYMBOL_FLAG))\n+      mrb_raise(mrb, E_TYPE_ERROR, \"Invalid type for remove_method\");\n+\n     remove_method(mrb, mod, mrb_symbol(*argv));\n     argv++;\n   }\n```\n\nmruby with the fix applied stops the crash:\n```\n$ bin/sandbox /tmp/crasher.rb\nbin/sandbox:20:in `sandbox_eval': Invalid type for remove_method (MRubyEngine::EngineRuntimeError)\n        from bin/sandbox:20:in `\u003cmain\u003e'\n```\n\n## Impact\nThis is not exploitable and its impact its limited to DoS of the service running the ruby sandbox.","vulnerability_information_html":"\u003cp\u003eThere is an invalid memory read on mruby when calling to \u003ccode\u003eremove_method\u003c/code\u003e with invalid arguments which causes a SIGSEGV which leads into denial of service.\u003c/p\u003e\n\n\u003ch2 id=\"sample\"\u003eSample\u003c/h2\u003e\n\n\u003cp\u003eThe following code tries to remove a method using a \u003ccode\u003enil\u003c/code\u003e as argument\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight ruby\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eChild\u003c/span\u003e\n   \u003cspan class=\"n\"\u003eremove_method\u003c/span\u003e \u003cspan class=\"kp\"\u003enil\u003c/span\u003e\n\u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThere are many other variants, such as using a float, an integer, a string, a Class, etc... Which obviously are non valid method symbols.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight ruby\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eChild\u003c/span\u003e\n   \u003cspan class=\"n\"\u003eremove_method\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n   \u003cspan class=\"n\"\u003eremove_method\u003c/span\u003e \u003cspan class=\"mf\"\u003e2.123\u003c/span\u003e\n   \u003cspan class=\"n\"\u003eremove_method\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;aaaa\u0026#39;\u003c/span\u003e\n   \u003cspan class=\"n\"\u003eremove_method\u003c/span\u003e \u003cspan class=\"no\"\u003eChild\u003c/span\u003e\n\u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"crash\"\u003eCrash\u003c/h2\u003e\n\n\u003cp\u003eHere we can see the crash (full crash output attached)\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e$ ruby bin/sandbox ../triage/uniq/min/segv/mrb_type \u0026gt; /tmp/full-crash.log\nbin/sandbox:20: [BUG] Segmentation fault at 0x0000000000000e\nruby 2.3.1p112 (2016-04-26) [x86_64-linux-gnu]\n\n-- Control frame information -----------------------------------------------\nc:0003 p:---- s:0010 e:000009 CFUNC  :sandbox_eval\nc:0002 p:0201 s:0005 E:001e48 EVAL   bin/sandbox:20 [FINISH]\nc:0001 p:0000 s:0002 E:001e00 (none) [FINISH]\n\n-- Ruby level backtrace information ----------------------------------------\nbin/sandbox:20:in `\u0026lt;main\u0026gt;\u0026#39;\nbin/sandbox:20:in `sandbox_eval\u0026#39;\n\n-- Machine register context ------------------------------------------------\n RIP: 0x00007f8c4d77d554 RBP: 0x00007f8c4c2fe4e0 RSP: 0x00007f8c4c2fc898\n RAX: 0x000000000000008f RBX: 0x0000000000000006 RCX: 0x00007f8c4d7fbf83\n RDX: 0x000000000000008f RDI: 0x00007f8c4c2fe4e0 RSI: 0x0000000000000006\n  R8: 0x00007f8c4d7f842f  R9: 0x00007f8c4c2fe010 R10: 0x0000000000000191\n R11: 0x00007f8c4d77d540 R12: 0x0000000000000010 R13: 0x000000000000008f\n R14: 0x00007f8c4c306160 R15: 0x00007f8c4c306100 EFL: 0x0000000000010246\n\n-- C level backtrace information -------------------------------------------\n/usr/lib/x86_64-linux-gnu/libruby-2.3.so.2.3 [0x7f8c51a96ea5]\n/usr/lib/x86_64-linux-gnu/libruby-2.3.so.2.3 [0x7f8c51a970dc]\n/usr/lib/x86_64-linux-gnu/libruby-2.3.so.2.3 [0x7f8c51971364]\n/usr/lib/x86_64-linux-gnu/libruby-2.3.so.2.3 [0x7f8c51a22dbe]\n/lib/x86_64-linux-gnu/libpthread.so.0 [0x7f8c516f5ed0]\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_respond_to+0x14) [0x7f8c4d77d554] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/include/mruby/boxing_word.h:71\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_check_convert_type+0x6b) [0x7f8c4d78c63b] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/object.c:310\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_check_string_type+0x1c) [0x7f8c4d7897cc] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/string.c:1743\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(join_ary+0xad) [0x7f8c4d78fe0d] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/array.c:1007\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_ary_join+0x2e) [0x7f8c4d790dbe] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/array.c:1031\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_vformat+0x14b) [0x7f8c4d7a28cb] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/error.c:345\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_name_error+0x92) [0x7f8c4d7a2ae2] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/error.c:382\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_mod_remove_method+0x137) [0x7f8c4d77c3c7] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/class.c:1985\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_vm_exec+0x762) [0x7f8c4d795cf2] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/vm.c:1165\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_vm_run+0x57) [0x7f8c4d79b567] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/vm.c:766\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mruby_engine_monitored_eval+0x113) [0x7f8c4d76f173] ../../../../ext/mruby_engine/eval_monitored.c:68\n/lib/x86_64-linux-gnu/libpthread.so.0 [0x7f8c516ec464]\n/lib/x86_64-linux-gnu/libc.so.6(__clone+0x6d) [0x7f8c50a6830d]\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"crash-debug\"\u003eCrash debug\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e(gdb) r\nStarting program: /usr/bin/ruby bin/sandbox /tmp/crasher.rb\n[Thread debugging using libthread_db enabled]\nUsing host libthread_db library \u0026quot;/lib/x86_64-linux-gnu/libthread_db.so.1\u0026quot;.\n[New Thread 0x7ffff7ff5700 (LWP 21707)]\n[New Thread 0x7ffff2348700 (LWP 21758)]\n\nProgram received signal SIGSEGV, Segmentation fault.\n[Switching to Thread 0x7ffff2348700 (LWP 21758)]\nmrb_class (v=..., mrb=mrb@entry=0x7ffff23494e0) at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/include/mruby/class.h:50\n50          return mrb_obj_ptr(v)-\u0026gt;c;\n(gdb) x/1i $rip\n=\u0026gt; 0x7ffff37c8554 \u0026lt;mrb_respond_to+20\u0026gt;:  mov    rsi,QWORD PTR [rsi+0x8]\n(gdb) i r rsi\nrsi            0x6      6\n(gdb) x/1xg $rsi+0x8\n0xe:    Cannot access memory at address 0xe\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe crash happens at \u003ccode\u003eext/mruby_engine/mruby/include/mruby/class.h:50\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight c\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kr\"\u003einline\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eRClass\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\n\u003cspan class=\"nf\"\u003emrb_class\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emrb_state\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emrb_value\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eswitch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emrb_type\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003eMRB_TT_FALSE\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emrb_fixnum\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n      \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003efalse_class\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003enil_class\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003eMRB_TT_TRUE\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etrue_class\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003eMRB_TT_SYMBOL\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003esymbol_class\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003eMRB_TT_FIXNUM\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003efixnum_class\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003eMRB_TT_FLOAT\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003efloat_class\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003eMRB_TT_CPTR\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eobject_class\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003eMRB_TT_ENV\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"nl\"\u003edefault:\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003emrb_obj_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"cm\"\u003e/* BUG: Bad memory access */\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eIf we check the vale \u003ccode\u003ev\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e(gdb) print v\n$1 = {\n  value = {\n    p = 0x6,\n    {\n      i_flag = 0,\n      i = 3\n    },\n    {\n      sym_flag = 6,\n      sym = 0\n    },\n    bp = 0x6,\n    fp = 0x6,\n    vp = 0x6\n  },\n  w = 6\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003emrb_obj_ptr\u003c/code\u003e is the following macro\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight c\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e#define mrb_obj_ptr(v)   ((struct RObject*)(mrb_ptr(v)))\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eSo \u003ccode\u003emrb_obj_ptr(v)-\u0026gt;c\u003c/code\u003e would be equivalent to this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e(gdb) print ((struct RObject*)v)-\u0026gt;c\nCannot access memory at address 0xe\n(gdb) print \u0026amp;((struct RObject*)v)-\u0026gt;c\n$2 = (struct RClass **) 0xe\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eIf we check the backtrace:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e(gdb) bt\n#0  mrb_class (v=..., mrb=mrb@entry=0x7ffff23494e0) at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/include/mruby/class.h:50\n#1  mrb_respond_to (mrb=mrb@entry=0x7ffff23494e0, obj=obj@entry=..., mid=mid@entry=143)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/class.c:1492\n#2  0x00007ffff37d763b in convert_type (raise=0 \u0026#39;\\000\u0026#39;, method=0x7ffff384342f \u0026quot;to_str\u0026quot;, tname=0x7ffff3844446 \u0026quot;String\u0026quot;, val=..., mrb=0x7ffff23494e0)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/object.c:310\n#3  mrb_check_convert_type (mrb=mrb@entry=0x7ffff23494e0, val=..., type=type@entry=MRB_TT_STRING, tname=tname@entry=0x7ffff3844446 \u0026quot;String\u0026quot;,\n    method=method@entry=0x7ffff384342f \u0026quot;to_str\u0026quot;) at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/object.c:352\n#4  0x00007ffff37d47cc in mrb_check_string_type (mrb=mrb@entry=0x7ffff23494e0, str=..., str@entry=...)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/string.c:1743\n#5  0x00007ffff37dae0d in join_ary (mrb=mrb@entry=0x7ffff23494e0, ary=ary@entry=..., sep=sep@entry=..., list=...)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/array.c:1007\n#6  0x00007ffff37dbdbe in mrb_ary_join (mrb=mrb@entry=0x7ffff23494e0, ary=ary@entry=..., sep=...)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/array.c:1031\n#7  0x00007ffff37ed8cb in mrb_vformat (mrb=mrb@entry=0x7ffff23494e0, format=0x7ffff3843547 \u0026quot;method \u0026#39;%S\u0026#39; not defined in %S\u0026quot;, ap=ap@entry=0x7ffff23479a8)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/error.c:345\n#8  0x00007ffff37edae2 in mrb_name_error (mrb=mrb@entry=0x7ffff23494e0, id=id@entry=0, fmt=fmt@entry=0x7ffff3843547 \u0026quot;method \u0026#39;%S\u0026#39; not defined in %S\u0026quot;)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/error.c:382\n#9  0x00007ffff37c73c7 in remove_method (mid=0, mod=..., mrb=0x7ffff23494e0)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/class.c:1985\n#10 mrb_mod_remove_method (mrb=0x7ffff23494e0, mod=...) at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/class.c:2006\n#11 0x00007ffff37e0cf2 in mrb_vm_exec (mrb=mrb@entry=0x7ffff23494e0, proc=\u0026lt;optimized out\u0026gt;, proc@entry=0x7ffff2351520, pc=\u0026lt;optimized out\u0026gt;)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/vm.c:1165\n#12 0x00007ffff37e6567 in mrb_vm_run (mrb=0x7ffff23494e0, proc=0x7ffff2351520, self=..., stack_keep=stack_keep@entry=0)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/vm.c:766\n#13 0x00007ffff37ba173 in mruby_engine_monitored_eval (data=0x7ffff23493e0) at ../../../../ext/mruby_engine/eval_monitored.c:68\n#14 0x00007ffff7737464 in start_thread (arg=0x7ffff2348700) at pthread_create.c:333\n#15 0x00007ffff6ab330d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109\n(gdb)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eWe can see that whenever the desired method to delete is not found, mruby will raise an error. This is handled by \u003ccode\u003eremove_method()\u003c/code\u003e at \u003ccode\u003eext/mruby_engine/mruby/src/class.c:1985\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight c\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\n\u003cspan class=\"nf\"\u003eremove_method\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emrb_state\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emrb_value\u003c/span\u003e \u003cspan class=\"n\"\u003emod\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emrb_sym\u003c/span\u003e \u003cspan class=\"n\"\u003emid\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eRClass\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emrb_class_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emod\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"n\"\u003ekhash_t\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eh\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efind_origin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emt\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"n\"\u003ekhiter_t\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ekh_get\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emt\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emid\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003ekh_end\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"n\"\u003ekh_del\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emt\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n      \u003cspan class=\"n\"\u003emrb_funcall\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emod\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026quot;method_removed\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emrb_symbol_value\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emid\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n      \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"n\"\u003emrb_name_error\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emid\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026quot;method \u0026#39;%S\u0026#39; not defined in %S\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003emrb_sym2str\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emid\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003emod\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \u003cspan class=\"cm\"\u003e/* \u0026lt;--- Raise an error */\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eLater on, mruby tries to convert the symbol in order to print it which is what causes the crash.\u003c/p\u003e\n\n\u003ch2 id=\"proposed-fix\"\u003eProposed fix\u003c/h2\u003e\n\n\u003cp\u003eAs the arguments for \u003ccode\u003eremove_method()\u003c/code\u003e should at least be a method type symbol. I propose the following check at \u003ccode\u003emrb_mod_remove_method()\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight diff\"\u003e\u003ccode\u003e\u003cspan class=\"gh\"\u003ediff --git a/src/class.c b/src/class.c\nindex 47a6c84..a898b46 100644\n\u003c/span\u003e\u003cspan class=\"gd\"\u003e--- a/src/class.c\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+++ b/src/class.c\n\u003c/span\u003e\u003cspan class=\"p\"\u003e@@ -2003,6 +2003,11 @@\u003c/span\u003e mrb_mod_remove_method(mrb_state *mrb, mrb_value mod)\n\n   mrb_get_args(mrb, \u0026quot;*\u0026quot;, \u0026amp;argv, \u0026amp;argc);\n   while (argc--) {\n\u003cspan class=\"gi\"\u003e+\n+    /* Crash fix. Ignore invalid types */\n+    if ((!argv-\u0026gt;value.sym) || (argv-\u0026gt;value.sym_flag != MRB_SYMBOL_FLAG))\n+      mrb_raise(mrb, E_TYPE_ERROR, \u0026quot;Invalid type for remove_method\u0026quot;);\n+\n\u003c/span\u003e     remove_method(mrb, mod, mrb_symbol(*argv));\n     argv++;\n   }\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003emruby with the fix applied stops the crash:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e$ bin/sandbox /tmp/crasher.rb\nbin/sandbox:20:in `sandbox_eval\u0026#39;: Invalid type for remove_method (MRubyEngine::EngineRuntimeError)\n        from bin/sandbox:20:in `\u0026lt;main\u0026gt;\u0026#39;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eThis is not exploitable and its impact its limited to DoS of the service running the ruby sandbox.\u003c/p\u003e\n","bounty_amount":"10000.0","formatted_bounty":"$10,000","weakness":{"id":48,"name":"Denial of Service"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":134419,"file_name":"crasher.rb","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/134/419/875cc25b77a18c61df16d11f9bc6df2903421862/crasher.rb?response-content-disposition=attachment%3B%20filename%3D%22crasher.rb%22%3B%20filename%2A%3DUTF-8%27%27crasher.rb\u0026response-content-type=text%2Fx-c%2B%2B\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQYENXQUKC%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T044547Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIHXwr%2Bz%2B7j54GXjIZDeFjE7V4KhtcLVpveDKyRp%2FgHMpAiEA%2FzBLaI4tlPUnNvgzY0X8n68OkDDLSfCBmjTZSd2A%2BM8qtAMIVRABGgwwMTM2MTkyNzQ4NDkiDOLyu53NKIhzdiDnLyqRA1YiznmwUquOZL6cfEwHlrCEbfV1uip5mxrCKpzmpc9DKyYejzEqNMg8%2Fo1XQZiQbQ9Mn8QGMjtqUBvpzsRmfLsdw4KO6Yix26%2Foq9H6jcEfUIX3EyFaY0ofGk42HT5lnakJ%2FUAtv5lyqirA3laDcoq6u60WpxBZh0jLi92Ajs9kGkzDbgWJPXMK2%2FlVglZWa%2BjQNhDftrEqJh4ZV%2FIwfbcJ6s89eju9B4Xkun1IUiVjrUtA5LTMlkDAEwqtGdl3pucepUSB2hZBvbqUfgiT65T%2BpLDNg0LFqEXPPPqqyrYG3%2BqTXIZxR1FfbdXOQjx1UoPwboCHOwSOpOKGaPs6TEM2o6Sg2U%2BGvuy3dMdtNBCfH4SIfBdeUa84eWUftCR4OwBiC0F1Cl6iPIZXa92zkJSAVTz9swPvr%2BghYLYGIjX%2F8jqVGlADsLB1sl%2BqlNRFkwYrvTDOWwnYmDuvQmmhpAQ6Mg%2Fp05v07WKHRsbG%2BAUzVJ3M02i0HIdWCGKjqKXgGZi%2FLBrHUEV9bzaVWmpeFEE3MObUqv8FOusBMEus3670kEKa62xVKQkID%2Fav5Xylzf384wPv9i4fBKmwghqKR67wSDPkErUtnTlN6wJNos0uBd5jibop6zjPh%2BDMaeI%2Bt4z0CbNpMS83WKn2xS%2FvSK0QFyg217PkDWCKklNPmbumtDteHdU2qRRX%2BQwVoTBmoRFgs97OyKXEz2rc7ZIcHuDnAibsNVPNZEuX9m%2B04KKBBkwdIr0sY3zEiVHvTVxPYBSsKfBPuZwzi6W3T3aq%2BF9l860FnFBaV964%2BlbASqZkuTd4cEZ8C2GJad6RyY164GfHgpKnmQ6aYbLhiDTz0xF3adlmhg%3D%3D\u0026X-Amz-Signature=a7c285120421b5dc702d091a824bf9dfda5f5507a204c143a2032cac9e03e632","file_size":105,"type":"text/x-c++"},{"id":134420,"file_name":"full-crash.log","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/134/420/d89cc0e09814c1af6048e3b0e89819dbc69d6853/full-crash.log?response-content-disposition=attachment%3B%20filename%3D%22full-crash.log%22%3B%20filename%2A%3DUTF-8%27%27full-crash.log\u0026response-content-type=text%2Fplain\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQYENXQUKC%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T044547Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIHXwr%2Bz%2B7j54GXjIZDeFjE7V4KhtcLVpveDKyRp%2FgHMpAiEA%2FzBLaI4tlPUnNvgzY0X8n68OkDDLSfCBmjTZSd2A%2BM8qtAMIVRABGgwwMTM2MTkyNzQ4NDkiDOLyu53NKIhzdiDnLyqRA1YiznmwUquOZL6cfEwHlrCEbfV1uip5mxrCKpzmpc9DKyYejzEqNMg8%2Fo1XQZiQbQ9Mn8QGMjtqUBvpzsRmfLsdw4KO6Yix26%2Foq9H6jcEfUIX3EyFaY0ofGk42HT5lnakJ%2FUAtv5lyqirA3laDcoq6u60WpxBZh0jLi92Ajs9kGkzDbgWJPXMK2%2FlVglZWa%2BjQNhDftrEqJh4ZV%2FIwfbcJ6s89eju9B4Xkun1IUiVjrUtA5LTMlkDAEwqtGdl3pucepUSB2hZBvbqUfgiT65T%2BpLDNg0LFqEXPPPqqyrYG3%2BqTXIZxR1FfbdXOQjx1UoPwboCHOwSOpOKGaPs6TEM2o6Sg2U%2BGvuy3dMdtNBCfH4SIfBdeUa84eWUftCR4OwBiC0F1Cl6iPIZXa92zkJSAVTz9swPvr%2BghYLYGIjX%2F8jqVGlADsLB1sl%2BqlNRFkwYrvTDOWwnYmDuvQmmhpAQ6Mg%2Fp05v07WKHRsbG%2BAUzVJ3M02i0HIdWCGKjqKXgGZi%2FLBrHUEV9bzaVWmpeFEE3MObUqv8FOusBMEus3670kEKa62xVKQkID%2Fav5Xylzf384wPv9i4fBKmwghqKR67wSDPkErUtnTlN6wJNos0uBd5jibop6zjPh%2BDMaeI%2Bt4z0CbNpMS83WKn2xS%2FvSK0QFyg217PkDWCKklNPmbumtDteHdU2qRRX%2BQwVoTBmoRFgs97OyKXEz2rc7ZIcHuDnAibsNVPNZEuX9m%2B04KKBBkwdIr0sY3zEiVHvTVxPYBSsKfBPuZwzi6W3T3aq%2BF9l860FnFBaV964%2BlbASqZkuTd4cEZ8C2GJad6RyY164GfHgpKnmQ6aYbLhiDTz0xF3adlmhg%3D%3D\u0026X-Amz-Signature=2c3b6da46854cfcf77d299208b602d431fe564eb0143200d46826843aef30e7e","file_size":33763,"type":"text/plain"},{"id":134422,"file_name":"proposed-fix.patch","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/134/422/c190a0e6cac0e6f3716c04a3ce56e552e0d7e089/proposed-fix.patch?response-content-disposition=attachment%3B%20filename%3D%22proposed-fix.patch%22%3B%20filename%2A%3DUTF-8%27%27proposed-fix.patch\u0026response-content-type=text%2Fx-diff\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQYENXQUKC%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T044547Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIHXwr%2Bz%2B7j54GXjIZDeFjE7V4KhtcLVpveDKyRp%2FgHMpAiEA%2FzBLaI4tlPUnNvgzY0X8n68OkDDLSfCBmjTZSd2A%2BM8qtAMIVRABGgwwMTM2MTkyNzQ4NDkiDOLyu53NKIhzdiDnLyqRA1YiznmwUquOZL6cfEwHlrCEbfV1uip5mxrCKpzmpc9DKyYejzEqNMg8%2Fo1XQZiQbQ9Mn8QGMjtqUBvpzsRmfLsdw4KO6Yix26%2Foq9H6jcEfUIX3EyFaY0ofGk42HT5lnakJ%2FUAtv5lyqirA3laDcoq6u60WpxBZh0jLi92Ajs9kGkzDbgWJPXMK2%2FlVglZWa%2BjQNhDftrEqJh4ZV%2FIwfbcJ6s89eju9B4Xkun1IUiVjrUtA5LTMlkDAEwqtGdl3pucepUSB2hZBvbqUfgiT65T%2BpLDNg0LFqEXPPPqqyrYG3%2BqTXIZxR1FfbdXOQjx1UoPwboCHOwSOpOKGaPs6TEM2o6Sg2U%2BGvuy3dMdtNBCfH4SIfBdeUa84eWUftCR4OwBiC0F1Cl6iPIZXa92zkJSAVTz9swPvr%2BghYLYGIjX%2F8jqVGlADsLB1sl%2BqlNRFkwYrvTDOWwnYmDuvQmmhpAQ6Mg%2Fp05v07WKHRsbG%2BAUzVJ3M02i0HIdWCGKjqKXgGZi%2FLBrHUEV9bzaVWmpeFEE3MObUqv8FOusBMEus3670kEKa62xVKQkID%2Fav5Xylzf384wPv9i4fBKmwghqKR67wSDPkErUtnTlN6wJNos0uBd5jibop6zjPh%2BDMaeI%2Bt4z0CbNpMS83WKn2xS%2FvSK0QFyg217PkDWCKklNPmbumtDteHdU2qRRX%2BQwVoTBmoRFgs97OyKXEz2rc7ZIcHuDnAibsNVPNZEuX9m%2B04KKBBkwdIr0sY3zEiVHvTVxPYBSsKfBPuZwzi6W3T3aq%2BF9l860FnFBaV964%2BlbASqZkuTd4cEZ8C2GJad6RyY164GfHgpKnmQ6aYbLhiDTz0xF3adlmhg%3D%3D\u0026X-Amz-Signature=5c9cf58b1562df75a4a0812fc3301f1eb94a37fb5f114cfcf74925888fc82a81","file_size":503,"type":"text/x-diff"}],"allow_singular_disclosure_at":"2017-01-15T19:51:25.252Z","allow_singular_disclosure_after":-124707262.54401635,"singular_disclosure_allowed":true,"vote_count":9,"voters":["madrobot","mpz","eveeez","japz","spetr0x","scept1c","bvdbijl","no-longer-with-company","xcom"],"severity":{"rating":"high","author_type":"Team"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1299454,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for your report! We've reproduced the issue, and our engineering team is investigating.","markdown_message":"\u003cp\u003eThank you for your report! We\u0026#39;ve reproduced the issue, and our engineering team is investigating.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-14T22:43:53.046Z","updated_at":"2016-11-14T22:43:53.046Z","actor":{"username":"bvdbijl","cleared":false,"url":"/bvdbijl","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1299462,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thank you for your report! We've reproduced the issue, and our engineering team is investigating.","markdown_message":"\u003cp\u003eThank you for your report! We\u0026#39;ve reproduced the issue, and our engineering team is investigating.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-14T22:47:36.109Z","updated_at":"2016-11-14T22:47:36.109Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1299463,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","markdown_message":"","automated_response":false,"created_at":"2016-11-14T22:47:42.973Z","updated_at":"2016-11-14T22:47:42.973Z","additional_data":{"old_severity":null,"new_severity":"High","old_severity_id":null,"new_severity_id":7553},"actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1303161,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Hi @jpenalbae, thanks again for the report and the patch. We've deployed a fix for this in our production environment as of earlier today.\n\nI'm marking this issue as resolved now but we still need to fix this bug upstream before we can assess the impact \u0026 determine a final bounty amount. This may take a few weeks since we received a large number of valid issues and we want to calibrate our payouts across all of them.","markdown_message":"\u003cp\u003eHi \u003ca href=\"/jpenalbae\"\u003e@jpenalbae\u003c/a\u003e, thanks again for the report and the patch. We\u0026#39;ve deployed a fix for this in our production environment as of earlier today.\u003c/p\u003e\n\n\u003cp\u003eI\u0026#39;m marking this issue as resolved now but we still need to fix this bug upstream before we can assess the impact \u0026amp; determine a final bounty amount. This may take a few weeks since we received a large number of valid issues and we want to calibrate our payouts across all of them.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-16T21:16:13.956Z","updated_at":"2016-11-16T21:16:13.956Z","actor":{"username":"francoischagnon","cleared":false,"url":"/francoischagnon","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/168/5d577fe97283a5483331257b629b6287ed4d287b_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"jpenalbae","url":"/jpenalbae"},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1319225,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"The fix for this issue has been merged upstream: https://github.com/mruby/mruby/pull/3284/files","markdown_message":"\u003cp\u003eThe fix for this issue has been merged upstream: \u003ca title=\"https://github.com/mruby/mruby/pull/3284/files\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fmruby%2Fmruby%2Fpull%2F3284%2Ffiles\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/mruby/mruby/pull/3284/files\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-25T15:43:23.941Z","updated_at":"2016-11-25T15:43:23.941Z","actor":{"username":"francoischagnon","cleared":false,"url":"/francoischagnon","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/168/5d577fe97283a5483331257b629b6287ed4d287b_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1370030,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks for helping improve the security of Shopify Scripts and the mruby project!","markdown_message":"\u003cp\u003eThanks for helping improve the security of Shopify Scripts and the mruby project!\u003c/p\u003e\n","automated_response":false,"created_at":"2016-12-16T19:51:19.037Z","updated_at":"2016-12-16T19:51:19.037Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"shopify-scripts"}},"bounty_amount":"10000.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"shopify-scripts","collaborator":{"username":"jpenalbae","url":"/jpenalbae"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1370031,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2016-12-16T19:51:25.230Z","updated_at":"2016-12-16T19:51:25.230Z","first_to_agree":true,"actor":{"username":"andrewdunbar","cleared":false,"url":"/andrewdunbar","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/164/5b0e89675ed6dbb9df87223e9f8f58e2125bb56b_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1370767,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2016-12-17T02:30:48.728Z","updated_at":"2016-12-17T02:30:48.728Z","actor":{"username":"jpenalbae","cleared":false,"url":"/jpenalbae","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1370768,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2016-12-17T02:30:48.782Z","updated_at":"2016-12-17T02:30:48.782Z","actor":{"username":"jpenalbae","cleared":false,"url":"/jpenalbae","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}