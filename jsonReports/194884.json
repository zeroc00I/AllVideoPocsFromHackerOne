{"id":194884,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xOTQ4ODQ=","url":"https://hackerone.com/reports/194884","title":"Heap use-after-free during range creation","state":"Closed","substate":"resolved","severity_rating":"low","readable_substate":"Resolved","created_at":"2016-12-30T22:45:58.314Z","submitted_at":"2016-12-30T22:45:58.314Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"titanous","url":"/titanous","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/002/226/4a5ed7749ff0c45f6b1d4a15971edf4a1a2e5cf7_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":15668,"url":"https://hackerone.com/shopify-scripts","handle":"shopify-scripts","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"shopify-scripts","twitter_handle":"","website":"","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2017-02-07T01:23:46.866Z","bug_reporter_agreed_on_going_public_at":"2017-02-07T01:23:46.811Z","team_member_agreed_on_going_public_at":"2017-02-07T01:22:42.628Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"`range_check` can trigger a stack extension via `mrb_funcall` if there are many arguments passed to the equivalence test. The stack extension changes the address of the stack, though the old stack address is used when assigning the value of the range. This causes a write into the old heap allocation, which has already been freed. This may be exploitable, but I didn't spend too much time exploring it.\n\n This program demonstrates the crash:\n\n```ruby\n[][0,0]..[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]\n```\n\nHere's the ASAN report:\n\n```text\n==30925==ERROR: AddressSanitizer: heap-use-after-free on address 0x61d00001e090 at pc 0x0000004ae8ac bp 0x7ffc0a539cd0 sp 0x7ffc0a539480\nWRITE of size 16 at 0x61d00001e090 thread T0\n    #0 0x4ae8ab in __asan_memcpy (/vagrant/bin/mruby+0x4ae8ab)\n    #1 0x646186 in mrb_vm_exec /vagrant/src/vm.c:2414:27\n    #2 0x61e2eb in mrb_vm_run /vagrant/src/vm.c:772:10\n    #3 0x64a628 in mrb_top_run /vagrant/src/vm.c:2490:12\n    #4 0x674229 in mrb_load_exec /vagrant/mrbgems/mruby-compiler/core/parse.y:5755:7\n    #5 0x674ec5 in mrb_load_file_cxt /vagrant/mrbgems/mruby-compiler/core/parse.y:5764:10\n    #6 0x4f3af5 in main /vagrant/mrbgems/mruby-bin-mruby/tools/mruby/mruby.c:232:11\n    #7 0x7facbbfc1f44 in __libc_start_main /build/eglibc-oGUzwX/eglibc-2.19/csu/libc-start.c:287\n    #8 0x41a505 in _start (/vagrant/bin/mruby+0x41a505)\n\n0x61d00001e090 is located 16 bytes inside of 2048-byte region [0x61d00001e080,0x61d00001e880)\nfreed by thread T0 here:\n    #0 0x4c4c0d in realloc (/vagrant/bin/mruby+0x4c4c0d)\n    #1 0x5bfde5 in mrb_default_allocf /vagrant/src/state.c:60:12\n    #2 0x550396 in mrb_realloc_simple /vagrant/src/gc.c:201:8\n    #3 0x5509e4 in mrb_realloc /vagrant/src/gc.c:215:8\n    #4 0x64ade2 in stack_extend_alloc /vagrant/src/vm.c:155:33\n    #5 0x617db1 in stack_extend /vagrant/src/vm.c:172:5\n    #6 0x61591f in mrb_funcall_with_block /vagrant/src/vm.c:394:7\n    #7 0x613c3c in mrb_funcall_argv /vagrant/src/vm.c:432:10\n    #8 0x613745 in mrb_funcall /vagrant/src/vm.c:323:10\n    #9 0x5b564b in range_check /vagrant/src/range.c:40:10\n    #10 0x5b4ec2 in mrb_range_new /vagrant/src/range.c:52:3\n    #11 0x646099 in mrb_vm_exec /vagrant/src/vm.c:2414:27\n    #12 0x61e2eb in mrb_vm_run /vagrant/src/vm.c:772:10\n    #13 0x64a628 in mrb_top_run /vagrant/src/vm.c:2490:12\n    #14 0x674229 in mrb_load_exec /vagrant/mrbgems/mruby-compiler/core/parse.y:5755:7\n    #15 0x674ec5 in mrb_load_file_cxt /vagrant/mrbgems/mruby-compiler/core/parse.y:5764:10\n    #16 0x4f3af5 in main /vagrant/mrbgems/mruby-bin-mruby/tools/mruby/mruby.c:232:11\n    #17 0x7facbbfc1f44 in __libc_start_main /build/eglibc-oGUzwX/eglibc-2.19/csu/libc-start.c:287\n\npreviously allocated by thread T0 here:\n    #0 0x4c4c0d in realloc (/vagrant/bin/mruby+0x4c4c0d)\n    #1 0x5bfde5 in mrb_default_allocf /vagrant/src/state.c:60:12\n    #2 0x550396 in mrb_realloc_simple /vagrant/src/gc.c:201:8\n    #3 0x5509e4 in mrb_realloc /vagrant/src/gc.c:215:8\n    #4 0x551323 in mrb_malloc /vagrant/src/gc.c:236:10\n    #5 0x5513bd in mrb_calloc /vagrant/src/gc.c:254:9\n    #6 0x616b79 in stack_init /vagrant/src/vm.c:92:28\n    #7 0x614950 in mrb_funcall_with_block /vagrant/src/vm.c:360:7\n    #8 0x61436a in mrb_funcall_with_block /vagrant/src/vm.c:338:13\n    #9 0x613c3c in mrb_funcall_argv /vagrant/src/vm.c:432:10\n    #10 0x524317 in mrb_obj_new /vagrant/src/class.c:1396:3\n    #11 0x53edee in mrb_exc_new_str /vagrant/src/error.c:32:10\n    #12 0x5484ee in mrb_init_exception /vagrant/src/error.c:534:20\n    #13 0x6a29f0 in mrb_init_core /vagrant/src/init.c:41:3\n    #14 0x5bfd85 in mrb_open_core /vagrant/src/state.c:47:3\n    #15 0x5bff2c in mrb_open_allocf /vagrant/src/state.c:107:20\n    #16 0x5bfefa in mrb_open /vagrant/src/state.c:99:20\n    #17 0x4f29d3 in main /vagrant/mrbgems/mruby-bin-mruby/tools/mruby/mruby.c:172:20\n    #18 0x7facbbfc1f44 in __libc_start_main /build/eglibc-oGUzwX/eglibc-2.19/csu/libc-start.c:287\n\nSUMMARY: AddressSanitizer: heap-use-after-free (/vagrant/bin/mruby+0x4ae8ab) in __asan_memcpy\nShadow bytes around the buggy address:\n  0x0c3a7fffbbc0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\n  0x0c3a7fffbbd0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\n  0x0c3a7fffbbe0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\n  0x0c3a7fffbbf0: fd fd fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c3a7fffbc00: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n=\u003e0x0c3a7fffbc10: fd fd[fd]fd fd fd fd fd fd fd fd fd fd fd fd fd\n  0x0c3a7fffbc20: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\n  0x0c3a7fffbc30: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\n  0x0c3a7fffbc40: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\n  0x0c3a7fffbc50: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\n  0x0c3a7fffbc60: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07\n  Heap left redzone:       fa\n  Heap right redzone:      fb\n  Freed heap region:       fd\n  Stack left redzone:      f1\n  Stack mid redzone:       f2\n  Stack right redzone:     f3\n  Stack partial redzone:   f4\n  Stack after return:      f5\n  Stack use after scope:   f8\n  Global redzone:          f9\n  Global init order:       f6\n  Poisoned by user:        f7\n  Container overflow:      fc\n  Array cookie:            ac\n  Intra object redzone:    bb\n  ASan internal:           fe\n  Left alloca redzone:     ca\n  Right alloca redzone:    cb\n==30925==ABORTING\n```\n\nThis patch fixes the bug:\n\n```patch\nFrom ec7d6b4078f25bcc7c25b210e2d69c910ea9b923 Mon Sep 17 00:00:00 2001\nFrom: Jonathan Rudenberg \u003cjonathan@titanous.com\u003e\nDate: Fri, 30 Dec 2016 17:44:25 -0500\nSubject: [PATCH] Fix heap use-after-free during range creation\n\n---\n src/vm.c | 3 ++-\n 1 file changed, 2 insertions(+), 1 deletion(-)\n\ndiff --git a/src/vm.c b/src/vm.c\nindex cca0fd03..368b75a9 100644\n--- a/src/vm.c\n+++ b/src/vm.c\n@@ -2411,7 +2411,8 @@ RETRY_TRY_BLOCK:\n     CASE(OP_RANGE) {\n       /* A B C  R(A) := range_new(R(B),R(B+1),C) */\n       int b = GETARG_B(i);\n-      regs[GETARG_A(i)] = mrb_range_new(mrb, regs[b], regs[b+1], GETARG_C(i));\n+      mrb_value res = mrb_range_new(mrb, regs[b], regs[b+1], GETARG_C(i));\n+      regs[GETARG_A(i)] = res;\n       ARENA_RESTORE(mrb, ai);\n       NEXT;\n     }\n-- \n2.11.0\n```\n","vulnerability_information_html":"\u003cp\u003e\u003ccode\u003erange_check\u003c/code\u003e can trigger a stack extension via \u003ccode\u003emrb_funcall\u003c/code\u003e if there are many arguments passed to the equivalence test. The stack extension changes the address of the stack, though the old stack address is used when assigning the value of the range. This causes a write into the old heap allocation, which has already been freed. This may be exploitable, but I didn\u0026#39;t spend too much time exploring it.\u003c/p\u003e\n\n\u003cp\u003eThis program demonstrates the crash:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight ruby\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e[][\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e..\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eHere\u0026#39;s the ASAN report:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e==30925==ERROR: AddressSanitizer: heap-use-after-free on address 0x61d00001e090 at pc 0x0000004ae8ac bp 0x7ffc0a539cd0 sp 0x7ffc0a539480\nWRITE of size 16 at 0x61d00001e090 thread T0\n    #0 0x4ae8ab in __asan_memcpy (/vagrant/bin/mruby+0x4ae8ab)\n    #1 0x646186 in mrb_vm_exec /vagrant/src/vm.c:2414:27\n    #2 0x61e2eb in mrb_vm_run /vagrant/src/vm.c:772:10\n    #3 0x64a628 in mrb_top_run /vagrant/src/vm.c:2490:12\n    #4 0x674229 in mrb_load_exec /vagrant/mrbgems/mruby-compiler/core/parse.y:5755:7\n    #5 0x674ec5 in mrb_load_file_cxt /vagrant/mrbgems/mruby-compiler/core/parse.y:5764:10\n    #6 0x4f3af5 in main /vagrant/mrbgems/mruby-bin-mruby/tools/mruby/mruby.c:232:11\n    #7 0x7facbbfc1f44 in __libc_start_main /build/eglibc-oGUzwX/eglibc-2.19/csu/libc-start.c:287\n    #8 0x41a505 in _start (/vagrant/bin/mruby+0x41a505)\n\n0x61d00001e090 is located 16 bytes inside of 2048-byte region [0x61d00001e080,0x61d00001e880)\nfreed by thread T0 here:\n    #0 0x4c4c0d in realloc (/vagrant/bin/mruby+0x4c4c0d)\n    #1 0x5bfde5 in mrb_default_allocf /vagrant/src/state.c:60:12\n    #2 0x550396 in mrb_realloc_simple /vagrant/src/gc.c:201:8\n    #3 0x5509e4 in mrb_realloc /vagrant/src/gc.c:215:8\n    #4 0x64ade2 in stack_extend_alloc /vagrant/src/vm.c:155:33\n    #5 0x617db1 in stack_extend /vagrant/src/vm.c:172:5\n    #6 0x61591f in mrb_funcall_with_block /vagrant/src/vm.c:394:7\n    #7 0x613c3c in mrb_funcall_argv /vagrant/src/vm.c:432:10\n    #8 0x613745 in mrb_funcall /vagrant/src/vm.c:323:10\n    #9 0x5b564b in range_check /vagrant/src/range.c:40:10\n    #10 0x5b4ec2 in mrb_range_new /vagrant/src/range.c:52:3\n    #11 0x646099 in mrb_vm_exec /vagrant/src/vm.c:2414:27\n    #12 0x61e2eb in mrb_vm_run /vagrant/src/vm.c:772:10\n    #13 0x64a628 in mrb_top_run /vagrant/src/vm.c:2490:12\n    #14 0x674229 in mrb_load_exec /vagrant/mrbgems/mruby-compiler/core/parse.y:5755:7\n    #15 0x674ec5 in mrb_load_file_cxt /vagrant/mrbgems/mruby-compiler/core/parse.y:5764:10\n    #16 0x4f3af5 in main /vagrant/mrbgems/mruby-bin-mruby/tools/mruby/mruby.c:232:11\n    #17 0x7facbbfc1f44 in __libc_start_main /build/eglibc-oGUzwX/eglibc-2.19/csu/libc-start.c:287\n\npreviously allocated by thread T0 here:\n    #0 0x4c4c0d in realloc (/vagrant/bin/mruby+0x4c4c0d)\n    #1 0x5bfde5 in mrb_default_allocf /vagrant/src/state.c:60:12\n    #2 0x550396 in mrb_realloc_simple /vagrant/src/gc.c:201:8\n    #3 0x5509e4 in mrb_realloc /vagrant/src/gc.c:215:8\n    #4 0x551323 in mrb_malloc /vagrant/src/gc.c:236:10\n    #5 0x5513bd in mrb_calloc /vagrant/src/gc.c:254:9\n    #6 0x616b79 in stack_init /vagrant/src/vm.c:92:28\n    #7 0x614950 in mrb_funcall_with_block /vagrant/src/vm.c:360:7\n    #8 0x61436a in mrb_funcall_with_block /vagrant/src/vm.c:338:13\n    #9 0x613c3c in mrb_funcall_argv /vagrant/src/vm.c:432:10\n    #10 0x524317 in mrb_obj_new /vagrant/src/class.c:1396:3\n    #11 0x53edee in mrb_exc_new_str /vagrant/src/error.c:32:10\n    #12 0x5484ee in mrb_init_exception /vagrant/src/error.c:534:20\n    #13 0x6a29f0 in mrb_init_core /vagrant/src/init.c:41:3\n    #14 0x5bfd85 in mrb_open_core /vagrant/src/state.c:47:3\n    #15 0x5bff2c in mrb_open_allocf /vagrant/src/state.c:107:20\n    #16 0x5bfefa in mrb_open /vagrant/src/state.c:99:20\n    #17 0x4f29d3 in main /vagrant/mrbgems/mruby-bin-mruby/tools/mruby/mruby.c:172:20\n    #18 0x7facbbfc1f44 in __libc_start_main /build/eglibc-oGUzwX/eglibc-2.19/csu/libc-start.c:287\n\nSUMMARY: AddressSanitizer: heap-use-after-free (/vagrant/bin/mruby+0x4ae8ab) in __asan_memcpy\nShadow bytes around the buggy address:\n  0x0c3a7fffbbc0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\n  0x0c3a7fffbbd0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\n  0x0c3a7fffbbe0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\n  0x0c3a7fffbbf0: fd fd fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c3a7fffbc00: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n=\u0026gt;0x0c3a7fffbc10: fd fd[fd]fd fd fd fd fd fd fd fd fd fd fd fd fd\n  0x0c3a7fffbc20: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\n  0x0c3a7fffbc30: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\n  0x0c3a7fffbc40: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\n  0x0c3a7fffbc50: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\n  0x0c3a7fffbc60: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07\n  Heap left redzone:       fa\n  Heap right redzone:      fb\n  Freed heap region:       fd\n  Stack left redzone:      f1\n  Stack mid redzone:       f2\n  Stack right redzone:     f3\n  Stack partial redzone:   f4\n  Stack after return:      f5\n  Stack use after scope:   f8\n  Global redzone:          f9\n  Global init order:       f6\n  Poisoned by user:        f7\n  Container overflow:      fc\n  Array cookie:            ac\n  Intra object redzone:    bb\n  ASan internal:           fe\n  Left alloca redzone:     ca\n  Right alloca redzone:    cb\n==30925==ABORTING\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis patch fixes the bug:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight diff\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003eFrom ec7d6b4078f25bcc7c25b210e2d69c910ea9b923 Mon Sep 17 00:00:00 2001\nFrom: Jonathan Rudenberg \u0026lt;jonathan@titanous.com\u0026gt;\nDate: Fri, 30 Dec 2016 17:44:25 -0500\nSubject: [PATCH] Fix heap use-after-free during range creation\n\u003c/span\u003e\n---\n src/vm.c | 3 ++-\n 1 file changed, 2 insertions(+), 1 deletion(-)\n\ndiff --git a/src/vm.c b/src/vm.c\n\u003cspan class=\"gh\"\u003eindex cca0fd03..368b75a9 100644\n\u003c/span\u003e\u003cspan class=\"gd\"\u003e--- a/src/vm.c\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+++ b/src/vm.c\n\u003c/span\u003e\u003cspan class=\"p\"\u003e@@ -2411,7 +2411,8 @@\u003c/span\u003e RETRY_TRY_BLOCK:\n     CASE(OP_RANGE) {\n       /* A B C  R(A) := range_new(R(B),R(B+1),C) */\n       int b = GETARG_B(i);\n\u003cspan class=\"gd\"\u003e-      regs[GETARG_A(i)] = mrb_range_new(mrb, regs[b], regs[b+1], GETARG_C(i));\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+      mrb_value res = mrb_range_new(mrb, regs[b], regs[b+1], GETARG_C(i));\n+      regs[GETARG_A(i)] = res;\n\u003c/span\u003e       ARENA_RESTORE(mrb, ai);\n       NEXT;\n     }\n\u003cspan class=\"gd\"\u003e-- \n\u003c/span\u003e\u003cspan class=\"p\"\u003e2.11.0\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","bounty_amount":"200.0","formatted_bounty":"$200","weakness":{"id":2,"name":"Memory Corruption - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-03-09T01:22:42.673Z","allow_singular_disclosure_after":-120194904.09759654,"singular_disclosure_allowed":true,"vote_count":5,"voters":["titanous","icanthack","mpz","eveeez","spetr0x"],"severity":{"rating":"low","author_type":"Team"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1392661,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for reporting this bug! This is an automated response to let you know that we've received your issue, and we'll process it as soon as possible.\n\nDue to the holiday period and the large volume of reports we have received, it may take us up to three weeks to respond. Thank you for your patience!","markdown_message":"\u003cp\u003eThank you for reporting this bug! This is an automated response to let you know that we\u0026#39;ve received your issue, and we\u0026#39;ll process it as soon as possible.\u003c/p\u003e\n\n\u003cp\u003eDue to the holiday period and the large volume of reports we have received, it may take us up to three weeks to respond. Thank you for your patience!\u003c/p\u003e\n","automated_response":true,"created_at":"2016-12-30T22:45:58.485Z","updated_at":"2016-12-30T22:45:58.485Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"shopify-scripts"}},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1411292,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Hi again @titanous and thanks for your report! Once again, this appears to be a duplicate of a previously reported issue. But since your submission added a patch, we'll consider splitting the bounty once this issue is resolved.\n\nWe've filed an upstream report here: https://github.com/mruby/mruby/issues/3387","markdown_message":"\u003cp\u003eHi again \u003ca href=\"/titanous\"\u003e@titanous\u003c/a\u003e and thanks for your report! Once again, this appears to be a duplicate of a previously reported issue. But since your submission added a patch, we\u0026#39;ll consider splitting the bounty once this issue is resolved.\u003c/p\u003e\n\n\u003cp\u003eWe\u0026#39;ve filed an upstream report here: \u003ca title=\"https://github.com/mruby/mruby/issues/3387\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fmruby%2Fmruby%2Fissues%2F3387\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/mruby/mruby/issues/3387\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n","automated_response":false,"created_at":"2017-01-10T14:52:30.285Z","updated_at":"2017-01-10T14:52:30.285Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1411293,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","markdown_message":"","automated_response":false,"created_at":"2017-01-10T14:52:34.836Z","updated_at":"2017-01-10T14:52:34.836Z","additional_data":{"old_severity":"Medium","new_severity":"Low","old_severity_id":16769,"new_severity_id":18618},"actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1438467,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thanks again for your report. This issue has been resolved upstream in https://github.com/mruby/mruby/commit/db1bd078bedcc33bfd3ca4c45f46bc553786bfd8\n\nOur next round of bounty decisions will take place within two weeks, so we'll be in touch with you again soon.","markdown_message":"\u003cp\u003eThanks again for your report. This issue has been resolved upstream in \u003ca title=\"https://github.com/mruby/mruby/commit/db1bd078bedcc33bfd3ca4c45f46bc553786bfd8\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fmruby%2Fmruby%2Fcommit%2Fdb1bd078bedcc33bfd3ca4c45f46bc553786bfd8\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/mruby/mruby/commit/db1bd078bedcc33bfd3ca4c45f46bc553786bfd8\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eOur next round of bounty decisions will take place within two weeks, so we\u0026#39;ll be in touch with you again soon.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-01-23T15:48:23.884Z","updated_at":"2017-01-23T15:48:23.884Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"titanous","url":"/titanous"},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1467317,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks for helping improve the security of Mruby and Shopify Scripts!","markdown_message":"\u003cp\u003eThanks for helping improve the security of Mruby and Shopify Scripts!\u003c/p\u003e\n","automated_response":false,"created_at":"2017-02-07T01:22:36.373Z","updated_at":"2017-02-07T01:22:36.373Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"shopify-scripts"}},"bounty_amount":"200.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"shopify-scripts","collaborator":{"username":"titanous","url":"/titanous"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1467318,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-02-07T01:22:42.646Z","updated_at":"2017-02-07T01:22:42.646Z","first_to_agree":true,"actor":{"username":"andrewdunbar","cleared":false,"url":"/andrewdunbar","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/164/5b0e89675ed6dbb9df87223e9f8f58e2125bb56b_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1467330,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-02-07T01:23:46.832Z","updated_at":"2017-02-07T01:23:46.832Z","actor":{"username":"titanous","cleared":false,"url":"/titanous","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/226/4a5ed7749ff0c45f6b1d4a15971edf4a1a2e5cf7_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1467331,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-02-07T01:23:46.885Z","updated_at":"2017-02-07T01:23:46.885Z","actor":{"username":"titanous","cleared":false,"url":"/titanous","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/226/4a5ed7749ff0c45f6b1d4a15971edf4a1a2e5cf7_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}